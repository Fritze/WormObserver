```{r, include=FALSE}

target_folder<-"/home/fpreuss/raid/timelapses/analysis/200318/data/posture"
save_path <- "/home/fpreuss/raid/timelapses/analysis/200318/plots/posture"


files_to_process <- list.files(target_folder,"skeletons_filtered.rds", full.names = TRUE, ignore.case = TRUE)
files_to_process <- files_to_process[!grepl("L2|exit|daf2|1:10",files_to_process)]
files_to_process_annotations <- gsub(".+\\/\\d+\\_(.+)\\_minimum.+","\\1", files_to_process)


skeleton_data_filtered <- files_to_process %>%
  map_df(., function(x) readRDS(x)) %>%
  group_by(dataset_ID,tp,TrackID,frame) %>%
  #all angles have to be between pi and -pi
  mutate(angle = ifelse(angle > pi & is.na(is_end), 2 * pi - angle,angle)) %>%
  mutate(angle = ifelse(angle < -pi & is.na(is_end), -2 * pi - angle,angle)) %>%
  mutate(mean_angle = mean(angle, na.rm = TRUE)) %>%
  ungroup()


# 
# plot <- ggplot(skeleton_data_filtered,aes(angle))+
#   geom_histogram(binwidth=0.01)
# 
# 
# plot
```


```{r, include=FALSE}

#transpose - rows: posture IDs, -columns: angles
angle_data_cluster <- skeleton_data_filtered %>%
  dcast(ID ~ index,value.var = "angle")

#make IDs the rowname so that this column is not part of the clustering data
rownames(angle_data_cluster) <- angle_data_cluster$ID
angle_data_cluster <- select(angle_data_cluster,-ID)

#take out first and last angle
angle_data_cluster <-angle_data_cluster[,2:(ncol(angle_data_cluster)-1)]


```


```{r, include=FALSE}


head(angle_data_cluster)
angle_data_cluster_test <- sample_n(angle_data_cluster, 15000)

n = nrow(angle_data_cluster_test)
kmax = 100
totwss <- NULL



for (i in seq(10,kmax,by=10)){
  kclus = kmeans(angle_data_cluster_test,centers=i,nstart=5,iter.max = 1000,algorithm = "Lloyd")
  totwss <- c(totwss, kclus$tot.withinss)
}


rsq = 1-(totwss*(n-1))/(totwss[1]*(n-seq(10,kmax,by=10)))

kclus
#measure of the total variance in the data set that is explained by the clustering.
# saveRDS(target_folder, )
plot(seq(10,kmax,by=10),rsq,xlab="Number of clusters",ylab="Adjusted R-squared",pch=20,cex=2)
plot(seq(10,kmax,by=10),totwss, pch=20, cex=2)


```

#calculate clusters
#choose right number of centers!
```{r, include=FALSE}
centers <- 100

cluster <- kmeans(angle_data_cluster,centers=centers,nstart=5,iter.max = 1000,algorithm = "Lloyd")

groups <- as.character(cluster$cluster)

skeleton_data_clustered <- skeleton_data_filtered  %>%
  mutate(ID = paste0(dataset_ID, "_",tp,"_",TrackID,"_",frame)) %>%
  dcast(.,ID ~ index,value.var = "angle") %>%
  select(ID) %>%
  #add groups
  mutate(clusterID = groups) %>%
  inner_join(skeleton_data_filtered, by="ID")

skeletons_filtered_clustered_filepath <- file.path(target_folder,paste0("200330_",paste(files_to_process_annotations,collapse = "_"),"_skeletons_filtered_clustered.RDS"))
saveRDS(skeleton_data_clustered, file=skeletons_filtered_clustered_filepath)
clustering_filepath <- file.path(target_folder,paste0("200330_",paste(files_to_process_annotations,collapse = "_"),"_clustering.RDS"))
saveRDS(cluster, file=file.path(target_folder,paste0("200330_",paste(files_to_process_annotations,collapse = "_"),"_clustering.RDS")))
```

