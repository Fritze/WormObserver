
##Plots1
```{r, echo=FALSE}

target_folder_base <- "/home/fpreuss/raid/timelapses/analysis/200305/motion"
save_path <- "/home/fpreuss/raid/timelapses/analysis/200318/"

motion_1 <- readRDS(file=file.path(target_folder_base,"200213_Motion_1_1.RDS")) #N2 1:10 OP50
motion_2 <- readRDS(file=file.path(target_folder_base,"200127_Motion_2.RDS")) #N2 empty
motion_3 <- readRDS(file=file.path(target_folder_base,"200214_Motion_3_1.RDS")) #daf2 1:10 OP50
motion_4 <- readRDS(file=file.path(target_folder_base,"200127_Motion_4.RDS")) #N2 1:5 OP50
motion_5 <- readRDS(file=file.path(target_folder_base,"200305_Motion_6.RDS")) #after 6h on food 1:10 OP50
motion_6 <- readRDS(file=file.path(target_folder_base,"200305_Motion_7.RDS")) #after 6h on food empty



imported_data <- rbind(motion_1,
                       motion_2,
                       motion_3,
                       motion_4,
                       motion_5,
                       motion_6)

```


##Plots1
```{r, echo=FALSE}

downsampled_to <- 2


imported_data %>%
  select(hours, dataset_ID, TrackID) %>%
  group_by(hours, dataset_ID) %>%
  summarise(.,n = n_distinct(TrackID)) %>%
  ggplot(.,aes(x=hours,y=n,fill=dataset_ID,colour=dataset_ID))+
  #scale_colour_manual(values = wes_palette("BottleRocket2"))+
  #geom_line()+
  geom_smooth(method="loess")+
  ylab("Number of tracked worms")+
  theme_classic()

imported_data %>%
  select(hours,dataset_ID, TrackID, Duration_of_track) %>%
  group_by(hours, dataset_ID) %>%
  summarise(., mean_duration =mean(Duration_of_track)/downsampled_to) %>%
  ggplot(.,aes(x=hours,y=mean_duration,fill=dataset_ID,colour=dataset_ID))+
  #scale_colour_manual(values = wes_palette("BottleRocket2"))+
  #geom_line()+
  geom_smooth(method="loess")+
  # geom_hline(yintercept=duration,color="red")+
  ylab("Mean duration of tracks (seconds)")+
  theme_classic()


```


## Plot grouped images for standard parameters
```{r, echo=TRUE}



params <- grep("p\\_.+",colnames(imported_data),value = TRUE)
dfp_for_plotting <- imported_data %>%
  ungroup()%>%
  # filter(!dataset_ID %in% exps_out) %>%
  mutate(dataset_ID = gsub("(.+)\\_.+","\\1",imported_data$dataset_ID))%>%
  group_by(hours,dataset_ID,plate_type)%>%
  unite("experiment", c("dataset_ID","worm_type", "plate_type"), sep= " ") %>%
  group_by(experiment,hours,minutes,tp) %>%
  summarise_at(.vars = params,
               .funs = c(mean_per_minute="mean"))

params <- grep("p\\_.+",colnames(dfp_for_plotting),value = TRUE)
for (i in params){
  print(ggplot(dfp_for_plotting, aes_string(x="hours",y=i))+
          #geom_ribbon(aes(ymin =  median_angle_per_minute - iqr_angle_per_minute, ymax = median_angle_per_minute + iqr_angle_per_minute))+
          geom_line(size=0.5)+
          ggtitle(i)+
          theme_classic()+
          scale_x_continuous(breaks = seq(0, 8, 1),limits = c(0,8))+
          facet_wrap(~experiment)
        #ggsave(paste0(i,".png"))
  )
}


```

##Plot grouped images for standard parameters
```{r, echo=TRUE}



with_bacteria_1to10 <- c(#with bacteria
  "2019-03-26_19-27-16",
  "2019-03-27_18-24-47",
  "2019-11-25_17-28-23")

daf_2_1to10 <-c("2019-05-07_12-15-40", #daf2 dauer
                  "2019-04-23_17-46-08")


empty <- c("2019-03-25_18-10-06",
                   "2019-11-18_18-43-57",
                   "2019-11-20_17-29-55") #no food

with_bacteria_1to5 <-c("2019-07-08_18-33-57", #1:5 OP50
                   "2019-07-09_18-22-34") #1:5 OP50


sixhonfood_1to10 <- c("2020-02-20_18-53-49",
                   "2020-02-21_15-58-43",
                   "2020-03-03_19-35-55" #after6h on food, 1:10 OP50
                )

sixhonfood_empty <- c("2020-02-26_18-31-08",
                      "2020-02-27_17-51-43"
                ) 


```

```{r, echo=TRUE}


imported_data_grouped <- imported_data %>%
    mutate(annotation = ifelse(dataset_ID %in% with_bacteria_1to10 , "1:10 OP50",NA)) %>%
    mutate(annotation = ifelse(dataset_ID %in% daf_2_1to10 , "daf2 dauers",annotation)) %>%
    mutate(annotation = ifelse(dataset_ID %in% empty, "N2 dauers no food",annotation)) %>%
    # mutate(annotation = ifelse(dataset_ID %in% with_bacteria_1to5, "1:5 OP50",annotation)) %>%
    mutate(annotation = ifelse(dataset_ID %in% sixhonfood_1to10, "6h on food, 1:10 OP50",annotation)) %>%
    mutate(annotation = ifelse(dataset_ID %in% sixhonfood_empty, "6h on food, empty",annotation)) %>%
    #round per half an hour
    # mutate(hours_rounded= floor(hours * 2) / 2) %>%
    #round per hour
    mutate(hours_rounded = ceiling(hours)) %>%
    #filter out first 30 mins
    filter(hours_rounded > 0.0) %>%
    na.omit()

```

## Plot mean values for certain parameters
### Plot either standard error or 95% confidence interval as error bars
```{r, echo=TRUE}

#This is just for selecting colors
pal <- wes_palette("Darjeeling1",5)
#Until how many hours
show_until <- 9

#select parameters to plot
params <- c("p_perc_turn", "p_perc_pause", "p_perc_omega_turn")

for (i in params){
  data <- imported_data_grouped %>%
      #calculate mean per rounded hour timepoint and condition (over all datasets)
      group_by(annotation, hours_rounded) %>%
      summarise(mean = mean(get(i), na.rm = TRUE),
              sd = sd(get(i), na.rm = TRUE),
              n = n()) %>%
     mutate(se = sd / sqrt(n),
           lower_ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
           upper_ci = mean + qt(1 - (0.05 / 2), n - 1) * se) %>%
      group_by(annotation) %>%
      #calculate the average number of tracks per annotation over all timepoints
      mutate(mean_number_of_tracks_per_roundedtp_exptype = round(mean(n))) %>%
      ungroup() %>%
      mutate(annotation = paste0(annotation, "\n(", round(mean_number_of_tracks_per_roundedtp_exptype),")")) %>%
      filter(hours_rounded <= show_until)
  
  ggplot(data,aes(x=hours_rounded,y=mean,color=annotation,group=annotation))+
    geom_line(size=1.5)+
    geom_point(color="black")+
    geom_errorbar(width=.2, aes(ymin=mean-se, ymax=mean+se))+
    geom_ribbon(aes(ymin=mean-se, ymax=mean+se), fill="darkgray",linetype = 0, alpha=0.2)+
    ggtitle(paste0(i," with standard error of the mean"))+
    scale_y_continuous(limits = c(0, (max(data$mean)+max(data$se))))+
    scale_x_continuous(limits = c(0, show_until),breaks = seq(0, show_until, 1))+
    xlab("hours") + ylab("relative occurence per track")+
    theme_linedraw()+
    theme(legend.direction="horizontal",
          legend.position = "top",
          strip.background = element_rect(colour = "black", fill = "white"),
          strip.text.x = element_text(colour = "black", face = "bold"),
          axis.text.x = element_text(size=20),
          axis.text.y = element_text(size=20))+
    scale_color_manual(values =pal)+
    facet_wrap(~annotation,scales="free")+
    ggsave(file.path(save_path,paste0(show_until,"h_",i,"_with_mean_line_with_error_of_the_mean",".png")),height=10,width=15)

}



```




## Plot histogram for velocity

```{r, echo=TRUE}


#This is just for selecting colors
pal <- wes_palette("Darjeeling1",5)
#Until how many hours
show_until <- 9

#number of bins
number_of_bins <- 50
#define quantiles
upper_quantile <- 0.95
lower_quantile <- 0.05

#get overall statistics for mean track velocity
summary(imported_data_grouped$p_mean_velocity)

#number of tracks not used for analysis
imported_data_grouped %>%
  group_by(annotation) %>%
  # summarise(upper_quantile = quantile(p_mean_velocity, upper_quantile))
  filter(p_mean_velocity > quantile(p_mean_velocity, upper_quantile)) %>%
  summarise(n= n())
         


data <- imported_data_grouped %>%
  mutate(p_mean_velocity = p_mean_velocity / 1000) %>%
  filter(p_mean_velocity <= quantile(p_mean_velocity, upper_quantile)) %>%
  filter(p_mean_velocity >= quantile(p_mean_velocity, lower_quantile)) %>%
  filter(hours_rounded <= show_until) %>%
  group_by(annotation, hours_rounded) %>%
  mutate(number_of_tracks_in_this_hour = n()) %>%
  arrange(hours_rounded)


  ggplot(data,aes(p_mean_velocity,color=annotation,fill=annotation))+
    geom_histogram(bins=number_of_bins,aes(y=..density..),color="black",fill="black",alpha=0.1)+
    geom_density(alpha=0.3, size=1.5) +
    scale_x_continuous(limits=c(0,quantile(data$p_mean_velocity, upper_quantile))) +
    xlab("average track velocity (mm/s)") + ylab("counts")+
    facet_wrap(vars(annotation,hours_rounded,number_of_tracks_in_this_hour),ncol=length(unique(data$hours_rounded)),scales="free_x")+
    theme_linedraw() +
    theme(legend.direction="horizontal",
      legend.position = "top",
      strip.background = element_rect(colour = "white", fill = "white"),
      panel.spacing = unit(1, "lines"),
      strip.text.x = element_text(size=15,colour = "black", face = "bold"),
      axis.text.x = element_text(size=30),
      axis.title.x = element_text(size=25),
      axis.text.y = element_text(size=35),
      axis.title.y = element_text(size=25))+
    scale_fill_manual(values=pal)+
    scale_color_manual(values=pal)+
    ggsave(file.path(save_path,paste0("histo_velocity_with_fit",".png")),height=20,width=49)
  


```

## Plot histogram for angle

```{r, echo=TRUE}


#This is just for selecting colors
pal <- wes_palette("Darjeeling1",5)
#Until how many hours
show_until <- 9

#number of bins
number_of_bins <- 50


#get overall statistics for mean track velocity
summary(imported_data_grouped$p_mean_angle)

        

data <- imported_data_grouped %>%
  filter(hours_rounded <= show_until) %>%
  group_by(annotation, hours_rounded) %>%
  mutate(number_of_tracks_in_this_hour = n()) %>%
  arrange(hours_rounded)


  ggplot(data,aes(p_mean_angle,color=annotation,fill=annotation))+
    geom_histogram(bins=number_of_bins,aes(y=..density..),color="black",fill="black",alpha=0.1)+
    geom_density(alpha=0.3, size=1.5) +
    xlab("mean angle (째)") + ylab("counts")+
    facet_wrap(vars(annotation,hours_rounded,number_of_tracks_in_this_hour),ncol=length(unique(data$hours_rounded)),scales="free_x")+
    theme_linedraw() +
    theme(legend.direction="horizontal",
      legend.position = "top",
      strip.background = element_rect(colour = "white", fill = "white"),
      panel.spacing = unit(1, "lines"),
      strip.text.x = element_text(size=15,colour = "black", face = "bold"),
      axis.text.x = element_text(size=30),
      axis.title.x = element_text(size=25),
      axis.text.y = element_text(size=35),
      axis.title.y = element_text(size=25))+
    scale_fill_manual(values=pal)+
    scale_color_manual(values=pal)+
    ggsave(file.path(save_path,paste0("histo_angle_with_fit",".png")),height=20,width=49)
  


```




```{r, echo=TRUE}


#Until how many hours
show_until <- 9




data <- imported_data_grouped %>%
  mutate(p_mean_velocity = p_mean_velocity / 1000) %>%
  filter(hours_rounded <= show_until) %>%
  group_by(annotation, hours_rounded) %>%
  mutate(number_of_tracks_in_this_hour = n()) %>%
  arrange(hours_rounded)


ggplot(data,aes(x = p_mean_angle, y = p_mean_velocity))+
  geom_point(colour="black",alpha=0.2)+
  theme_linedraw()+
  ylab("mean velocity (mm/s)") + xlab("mean track angle (째)")+
  scale_y_log10()+
  scale_x_continuous(limits=c(0,180))+
  theme(legend.direction="horizontal",
      legend.position = "top",
      strip.background = element_rect(colour = "white", fill = "white"),
      panel.spacing = unit(1, "lines"),
      strip.text.x = element_text(size=15,colour = "black", face = "bold"),
      axis.text.x = element_text(size=30),
      axis.title.x = element_text(size=45),
      axis.text.y = element_text(size=35),
      axis.title.y = element_text(size=45))+
  facet_wrap(vars(annotation,hours_rounded,number_of_tracks_in_this_hour),ncol=length(unique(data$hours_rounded)),scales="free_x")+
  ggsave(file.path(save_path,paste0("roaming_dwelling_heatmap_show_all_points",".png")),height=20,width=49)

ggplot(data,aes(x = p_mean_angle, y = p_mean_velocity))+
  stat_density_2d(aes(fill = ..ndensity..),contour=FALSE,geom="raster")+
  geom_point(colour="white",alpha=0.3)+
  scale_fill_viridis(option = "inferno",na.value="white")+
  theme_classic()+
  ylab("mean velocity (mm/s)") + xlab("mean track angle (째)")+
  scale_y_log10()+
  scale_x_continuous(limits=c(0,180))+
  theme(strip.background = element_rect(colour = "white", fill = "white"),
      panel.spacing = unit(1, "lines"),
      strip.text.x = element_text(size=15,colour = "black", face = "bold"),
      axis.text.x = element_text(size=30),
      axis.title.x = element_text(size=45),
      axis.text.y = element_text(size=35),
      axis.title.y = element_text(size=45))+
  facet_wrap(vars(annotation,hours_rounded,number_of_tracks_in_this_hour),ncol=length(unique(data$hours_rounded)),scales="free_x")+
  ggsave(file.path(save_path,paste0("roaming_dwelling_heatmap_show_all_points_and_density",".png")),height=20,width=49)


```

```{r, echo=TRUE}



data <- imported_data_grouped %>%
  mutate(ratio = p_mean_velocity/p_mean_angle) %>%
  mutate(behavioral_state=ifelse(ratio > 1, "roaming","dwelling")) %>%
  mutate(p_mean_velocity = p_mean_velocity / 1000) %>%
  filter(hours_rounded <= show_until) %>%
  group_by(annotation, hours_rounded) %>%
  mutate(number_of_tracks_in_this_hour = n()) %>%
  arrange(hours_rounded)

ggplot(data,aes(x = p_mean_angle, y = p_mean_velocity,color=behavioral_state))+
  geom_point(alpha=0.5)+
  theme_linedraw()+
  ylab("mean velocity (mm/s)") + xlab("mean track angle (째)")+
  scale_y_log10()+
  scale_x_continuous(limits=c(0,180))+
  theme(legend.direction="horizontal",
      legend.position = "top",
      strip.background = element_rect(colour = "white", fill = "white"),
      panel.spacing = unit(1, "lines"),
      strip.text.x = element_text(size=15,colour = "black", face = "bold"),
      axis.text.x = element_text(size=30),
      axis.title.x = element_text(size=45),
      axis.text.y = element_text(size=35),
      axis.title.y = element_text(size=45))+
  facet_wrap(vars(annotation,hours_rounded,number_of_tracks_in_this_hour),ncol=length(unique(data$hours_rounded)),scales="free_x")+
  ggsave(file.path(save_path,paste0("roaming_dwelling_heatmap_binarized",".png")),height=20,width=49)


```



