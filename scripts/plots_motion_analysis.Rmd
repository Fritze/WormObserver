  
#Define locations and datasets to include
```{r, echo=FALSE}
#bins or tracks?
average <- "bins"
  
base_path <- "/home/fpreuss/raid/timelapses/analysis/200612"


```

```{r, echo=FALSE}

target_path <- file.path(base_path,"data")
save_path <- file.path(base_path,"plots",average)
dir.create(save_path)
  
#list of centroid tracking .rds files in data folder
files_to_process <- list.files(target_folder, paste0("centroid_tracking_",average,".rds"),full.names = TRUE, ignore.case = TRUE)
  
order  <- c("N2 1:5 OP50",
            "N2 1:10 OP50",
            "N2 no food",
            "N2 1:10 after 6h exit",
            "N2 1:10 OP50 after 6h exit",
            "N2 empty after 6h exit",
            "daf2",
            "Agar",
            "N2 RT no food"
            )
  
imported_data <- map_dfr(files_to_process,readRDS) %>%
    mutate(hours = minutes / 60) %>%
    #round per half an hour
    # mutate(hours_rounded= floor(hours * 2) / 2) %>%
    #round per hour
    mutate(hours_rounded = ceiling(hours)) %>%
    #filter out first 30 mins
    filter(hours_rounded > 0.0) %>%
    #take out one condition
    filter(!annotation %in% c("L2")) %>%
    na.omit() %>%
    #custom order of conditions
    left_join(tibble(annotation=order),by="annotation")
  
#levels must be changed for ggplot to take new order into account
imported_data$annotation = factor(imported_data$annotation, levels=order)


```
  
  
```{r, echo=TRUE}
  
#Until how many hours
show_until <- 9
  

library(pals)
  
data <- imported_data %>%
  filter(hours_rounded <= show_until) %>%
  group_by(annotation, hours_rounded) %>%
  #count tracks per hour per condition
  mutate(number_of_tracks_in_this_hour = n_distinct(dataset_ID,tp,TrackID)) %>%
  # scale velocity to mm/s
  mutate(p_mean_velocity = p_mean_velocity / 1000) %>%
  arrange(hours_rounded)

for (a in unique(data$annotation)){ 
  data_to_plot <- data %>%
    filter(annotation == a)
  
  #all points colored by dataset
  ggplot(data_to_plot,aes(x = p_mean_angle, y = p_mean_velocity))+
    geom_point(alpha=0.15)+
    theme_linedraw()+
    ylab("velocity (mm/s)") + xlab("angular velocity (degree/s)")+
    scale_y_log10()+
    scale_x_continuous(limits=c(0,180))+
    theme(legend.direction="horizontal",
        legend.position = "top",
        strip.background = element_rect(colour = "white", fill = "white"),
        panel.spacing = unit(1, "lines"),
        strip.text.x = element_text(size=25,colour = "black", face = "bold"),
        axis.text.x = element_text(size=30),
        axis.title.x = element_text(size=45),
        axis.text.y = element_text(size=35),
        axis.title.y = element_text(size=45))+
    facet_wrap(vars(annotation,dataset_ID,hours_rounded),ncol=length(unique(data$hours_rounded)),scales="free_x")+
    ggsave(file.path(save_path,paste0("scatter_roaming_dwelling_datasets_per_annotation_",a,".png")),height=25,width=30)
}
```

```{r, echo=TRUE}


#point density with number of neighbours
ggplot(data,aes(x = p_mean_angle, y = p_mean_velocity))+
  geom_pointdensity()+
  scale_color_viridis(option = "inferno")+
  theme_classic()+
  ylab("velocity (mm/s)") + xlab("angular velocity (degree/s)")+
  scale_y_log10()+
  scale_x_continuous(limits=c(0,180))+
  theme(strip.background = element_rect(colour = "white", fill = "white"),
      panel.spacing = unit(1, "lines"),
      strip.text.x = element_text(size=25,colour = "black", face = "bold"),
      axis.text.x = element_text(size=30),
      axis.title.x = element_text(size=45),
      axis.text.y = element_text(size=35),
      axis.title.y = element_text(size=45))+
  facet_wrap(vars(annotation,hours_rounded,number_of_tracks_in_this_hour),ncol=length(unique(data$hours_rounded)),scales="free_x")+
  ggsave(file.path(save_path,paste0("scatter_roaming_dwelling_heatmap_show_all_points_and_density",".png")),bg="black",height=35,width=35)

#point density with number of neighbours
ggplot(data,aes(x = p_mean_angle, y = p_mean_velocity))+
  # geom_hex(bins = 70) +
  stat_density_2d(aes(fill = ..ndensity..), geom = "raster", contour = FALSE) +
  geom_rug(col="white",alpha=.01)+
  scale_fill_viridis(option = "inferno")+
  theme_black()+
  ylab("velocity (mm/s)") + xlab("angular velocity (degree/s)")+
  scale_y_log10()+
  scale_x_continuous(limits=c(0,180))+
  theme(strip.background = element_rect(colour = "white", fill = "white"),
      panel.spacing = unit(1, "lines"),
      strip.text.x = element_text(size=25,colour = "black", face = "bold"),
      axis.text.x = element_text(size=30),
      axis.title.x = element_text(size=45),
      axis.text.y = element_text(size=35),
      axis.title.y = element_text(size=45))+
  facet_wrap(vars(annotation,hours_rounded,number_of_tracks_in_this_hour),ncol=length(unique(data$hours_rounded)),scales="free_x")+
  ggsave(file.path(save_path,paste0("scatter_roaming_dwelling_heatmap_show_density",".png")),bg="black",height=35,width=35)
  
  
```
  
```{r, echo=TRUE}
  
  
  
data_binarized <- imported_data %>%
  mutate(ratio = p_mean_velocity/p_mean_angle) %>%
  #calculate ratio, this will give result in a diagonal (see binarized_not_log plot)
  mutate(behavioral_state=ifelse(ratio > 1, "roaming","dwelling")) %>%
  # scale velocity to mm/s
  mutate(p_mean_velocity = p_mean_velocity / 1000) %>%
  filter(hours_rounded <= show_until) %>%
  group_by(annotation, hours_rounded) %>%
  #count tracks per hour per condition
  mutate(number_of_tracks_in_this_hour = n_distinct(dataset_ID,tp,TrackID)) %>%
  arrange(hours_rounded) 
  
binarized <- ggplot(data_binarized,aes(x = p_mean_angle, y = p_mean_velocity,color=behavioral_state))+
  geom_point(alpha=0.05)+
  theme_linedraw()+
  ylab("velocity (mm/s)") + xlab("angular velocity (degree/s)")+
  scale_x_continuous(limits=c(0,180))+
    theme(legend.direction="horizontal",
      legend.position = "top",
      strip.background = element_rect(colour = "white", fill = "white"),
      panel.spacing = unit(1, "lines"),
        strip.text.x = element_text(size=15,colour = "black", face = "bold"),
        axis.text.x = element_text(size=30),
        axis.title.x = element_text(size=45),
        axis.text.y = element_text(size=35),
        axis.title.y = element_text(size=45))+
  facet_wrap(vars(annotation,hours_rounded,number_of_tracks_in_this_hour),ncol=length(unique(data$hours_rounded)),scales="free_x")
  
binarized + ggsave(file.path(save_path,paste0("scatter_roaming_dwelling_heatmap_binarized_not_log",".png")),height=35,width=35)
binarized + scale_y_log10() + ggsave(file.path(save_path,paste0("scatter_roaming_dwelling_heatmap_binarized",".png")),height=35,width=35)
  
pal <- wes_palette("Darjeeling1",5)[c(3,5)]
  
```

```{r, echo=TRUE}

data_binarized_summarized <- data_binarized %>%
  group_by(annotation,hours_rounded) %>%
  mutate(n_total = n()) %>%
  group_by(annotation, hours_rounded,behavioral_state) %>%
  mutate(n=n()) %>%
  mutate(perc=n/n_total) %>%
  group_by(annotation, hours_rounded,behavioral_state,perc) %>%
  summarise()

```

```{r, echo=TRUE}
library(jcolors)

data_summarised <- data_binarized %>%
  #counts per behavioral state
  group_by(annotation,hours_rounded,behavioral_state,dataset_ID) %>%
  summarise(counts=n()) %>%
  #total counts
  group_by(annotation,hours_rounded,dataset_ID) %>%
  mutate(sum=sum(counts)) %>%
  #relative occurence of beahvioral_state
  mutate(perc = counts/sum) %>%
  #extract first timepoint percentage for every condition
  mutate(first = case_when(hours_rounded == 1  ~ perc)) %>%
  group_by(dataset_ID,behavioral_state) %>%
  fill(first, .direction="down") %>%
  #normalize by first timepoint
  mutate(perc_norm = perc/first)
  
ggplot(data_summarised,aes(x=as.character(hours_rounded),y=perc,fill=behavioral_state))+
      geom_boxplot(lwd=1.75)+
      scale_fill_manual(values =pal)+
      scale_y_continuous(limits=c(0,1))+
      geom_point(position=position_dodge(width=0.75),aes(group=behavioral_state),color="red",alpha=0.75,size=2)+
      xlab("hours") + ylab("Relative occurence of \nbehavioral state")+
      facet_wrap(annotation ~ .)+
      theme_black()+
      theme(
        legend.direction="horizontal",
        legend.position = "top",
        strip.background = element_rect(colour = "white", fill = "white"),
        panel.spacing = unit(1, "lines"),
        strip.text.x = element_text(size=15,colour = "black", face = "bold"),
        axis.text.x = element_text(size=30),
        axis.title.x = element_text(size=45),
        axis.text.y = element_text(size=30),
        axis.title.y = element_text(size=45),
        legend.key.size = unit(2.5, "cm"))+
      facet_wrap(vars(annotation),scales="free_x")+
      ggsave(file.path(save_path,paste0("box_roaming_dwelling_relative",".png")),height=20,width=20)
  
  
other_hour <- 6

data_summarised_sub <- data_summarised %>%
  filter(hours_rounded %in% c(1,other_hour)) %>%
  filter(behavioral_state == "roaming")

library(jcolors)
ggplot(data_summarised_sub,aes(x=as.character(hours_rounded),y=perc))+
      geom_boxplot(aes(fill=annotation),color="white",width=0.2,outlier.alpha = 0.3,outlier.size = 1,lwd=0.5)+
      scale_fill_jcolors(palette = "pal7")+
      scale_color_jcolors(palette = "pal7")+
      geom_point(position=position_dodge(width=0.75),aes(group=behavioral_state),color="red",alpha=0.75,size=2)+
      xlab("hours") + ylab("Relative occurence of \nbehavioral state")+
      scale_y_continuous(limits=c(0,1))+
      facet_wrap(annotation ~ .)+
      theme_black()+
      theme(
        legend.direction="horizontal",
        legend.position = "top",
        strip.background = element_rect(colour = "white", fill = "white"),
        panel.spacing = unit(1, "lines"),
        strip.text.x = element_text(size=15,colour = "black", face = "bold"),
        axis.text.x = element_text(size=30),
        axis.title.x = element_text(size=45),
        axis.text.y = element_text(size=30),
        axis.title.y = element_text(size=45),
        axis.ticks=element_line(size=1.5),
        axis.ticks.length=unit(0.25,"cm"),
        legend.key.size = unit(2.5, "cm"))+
      facet_wrap(vars(annotation),scales="free_x")+
      ggsave(file.path(save_path,paste0("box_roaming_dwelling_relative_sub",".png")),height=10,width=10)


```
  
  
```{r, echo=TRUE}

library(ggsignif) #installed from github


data_binarized_only_roaming <-data_binarized %>%
  filter(behavioral_state == "roaming") %>%
  select(hours_rounded, annotation, p_mean_velocity)

ggplot(data_binarized_only_roaming, aes(y=p_mean_velocity, x=as.character(hours_rounded)))+
  geom_violin(lwd=1.75)+
  geom_boxplot(aes(fill=annotation),color="white",width=0.2,outlier.alpha = 0.3,outlier.size = 1,lwd=0.5)+
  theme_linedraw()+
  labs(x="hours",y="Roaming velocity (mm/s)")+
  theme(legend.direction="horizontal",
        legend.position = "top",
        strip.background = element_rect(colour = "white", fill = "white"),
        panel.spacing = unit(1, "lines"),
        strip.text.x = element_text(size=15,colour = "black", face = "bold"),
        axis.text.x = element_text(size=30),
        axis.title.x = element_text(size=45),
        axis.text.y = element_text(size=30),
        axis.title.y = element_text(size=45),
        plot.title = element_text(size = 40, face = "bold"),
        legend.key.size = unit(2.5, "cm"))+
  facet_wrap(vars(annotation),scales="free_x")+
  scale_fill_jcolors(palette = "pal7")+
  scale_color_jcolors(palette = "pal7")+
  ggtitle("Velocity average, only for roaming fraction")+
  ggsave(file.path(save_path,paste0("violin_roaming_average_velocity_all_hours",".png")),height=10,width=10)


data_binarized_only_roaming %>%
  filter(hours_rounded %in% c(1,other_hour)) %>%
  ggplot(., aes(y=p_mean_velocity, x=as.character(hours_rounded)))+
  geom_violin(lwd=0,fill="lightblue")+
  geom_boxplot(aes(fill=annotation),color="white",width=0.2,outlier.alpha = 0.3,outlier.size = 1,lwd=0.5)+
  # geom_signif(comparisons = list(c("1", other_hour)),
  #           test="wilcox.test",
  #           map_signif_level = TRUE,
  #           textsize=10,
  #           size=2,
  #           color="white") +
  theme_black()+
  labs(x="hours",y="Roaming velocity (mm/s)")+
  scale_y_continuous(limits=c(0,0.15))+
  theme(legend.direction="horizontal",
        legend.position = "top",
        strip.background = element_rect(colour = "white", fill = "white"),
        panel.spacing = unit(1, "lines"),
        strip.text.x = element_text(size=15,colour = "black", face = "bold"),
        axis.text.x = element_text(size=30),
        axis.title.x = element_text(size=45),
        axis.text.y = element_text(size=30),
        axis.title.y = element_text(size=45),
        plot.title = element_text(size = 40, face = "bold"),
        axis.ticks=element_line(size=1.5),
        axis.ticks.length=unit(0.25,"cm"),
        legend.key.size = unit(2.5, "cm"))+
  facet_wrap(vars(annotation),scales="free_x")+
  ggtitle("Velocity average, only for roaming fraction")+
  ggsave(file.path(save_path,paste0("violin_roaming_average_velocity_two_hours_with_signif",".png")),height=10,width=10)



```
