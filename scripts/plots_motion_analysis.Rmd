
##Plots1
```{r, echo=FALSE}

target_folder_base <- "/home/fpreuss/raid/timelapses/analysis/200305/motion"
save_path <- "/home/fpreuss/raid/timelapses/analysis/200318/"

motion_1 <- readRDS(file=file.path(target_folder_base,"200213_Motion_1_1.RDS")) #N2 1:10 OP50
motion_2 <- readRDS(file=file.path(target_folder_base,"200127_Motion_2.RDS")) #N2 empty
motion_3 <- readRDS(file=file.path(target_folder_base,"200214_Motion_3_1.RDS")) #daf2 1:10 OP50
motion_4 <- readRDS(file=file.path(target_folder_base,"200127_Motion_4.RDS")) #N2 1:5 OP50
motion_5 <- readRDS(file=file.path(target_folder_base,"200305_Motion_6.RDS")) #after 6h on food 1:10 OP50
motion_6 <- readRDS(file=file.path(target_folder_base,"200305_Motion_7.RDS")) #after 6h on food empty



imported_data <- rbind(motion_1,
                       motion_2,
                       motion_3,
                       motion_4,
                       motion_5,
                       motion_6)

```


##Plots1
```{r, echo=FALSE}

downsampled_to <- 2


imported_data %>%
  select(hours, dataset_ID, TrackID) %>%
  group_by(hours, dataset_ID) %>%
  summarise(.,n = n_distinct(TrackID)) %>%
  ggplot(.,aes(x=hours,y=n,fill=dataset_ID,colour=dataset_ID))+
  #scale_colour_manual(values = wes_palette("BottleRocket2"))+
  #geom_line()+
  geom_smooth(method="loess")+
  ylab("Number of tracked worms")+
  theme_classic()

imported_data %>%
  select(hours,dataset_ID, TrackID, Duration_of_track) %>%
  group_by(hours, dataset_ID) %>%
  summarise(., mean_duration =mean(Duration_of_track)/downsampled_to) %>%
  ggplot(.,aes(x=hours,y=mean_duration,fill=dataset_ID,colour=dataset_ID))+
  #scale_colour_manual(values = wes_palette("BottleRocket2"))+
  #geom_line()+
  geom_smooth(method="loess")+
  # geom_hline(yintercept=duration,color="red")+
  ylab("Mean duration of tracks (seconds)")+
  theme_classic()


```


## Plot grouped images for standard parameters
```{r, echo=TRUE}



params <- grep("p\\_.+",colnames(imported_data),value = TRUE)
dfp_for_plotting <- imported_data %>%
  ungroup()%>%
  # filter(!dataset_ID %in% exps_out) %>%
  mutate(dataset_ID = gsub("(.+)\\_.+","\\1",imported_data$dataset_ID))%>%
  group_by(hours,dataset_ID,plate_type)%>%
  unite("experiment", c("dataset_ID","worm_type", "plate_type"), sep= " ") %>%
  group_by(experiment,hours,minutes,tp) %>%
  summarise_at(.vars = params,
               .funs = c(mean_per_minute="mean"))

params <- grep("p\\_.+",colnames(dfp_for_plotting),value = TRUE)
for (i in params){
  print(ggplot(dfp_for_plotting, aes_string(x="hours",y=i))+
          #geom_ribbon(aes(ymin =  median_angle_per_minute - iqr_angle_per_minute, ymax = median_angle_per_minute + iqr_angle_per_minute))+
          geom_line(size=0.5)+
          ggtitle(i)+
          theme_classic()+
          scale_x_continuous(breaks = seq(0, 8, 1),limits = c(0,8))+
          facet_wrap(~experiment)
        #ggsave(paste0(i,".png"))
  )
}


```

##Plot grouped images for standard parameters
```{r, echo=TRUE}



with_bacteria_1to10 <- c(#with bacteria
  "2019-03-26_19-27-16",
  "2019-03-27_18-24-47",
  "2019-11-25_17-28-23")

daf_2_1to10 <-c("2019-05-07_12-15-40", #daf2 dauer
                  "2019-04-23_17-46-08")


empty <- c("2019-03-25_18-10-06",
                   "2019-11-18_18-43-57",
                   "2019-11-20_17-29-55") #no food

with_bacteria_1to5 <-c("2019-07-08_18-33-57", #1:5 OP50
                   "2019-07-09_18-22-34") #1:5 OP50


sixhonfood_1to10 <- c("2020-02-20_18-53-49",
                   "2020-02-21_15-58-43",
                   "2020-03-03_19-35-55" #after6h on food, 1:10 OP50
                )

sixhonfood_empty <- c("2020-02-26_18-31-08",
                      "2020-02-27_17-51-43"
                ) 


```

```{r, echo=TRUE}


imported_data_grouped <- imported_data %>%
    mutate(annotation = ifelse(dataset_ID %in% with_bacteria_1to10 , "1:10 OP50",NA)) %>%
    mutate(annotation = ifelse(dataset_ID %in% daf_2_1to10 , "daf2 dauers",annotation)) %>%
    mutate(annotation = ifelse(dataset_ID %in% empty, "N2 dauers no food",annotation)) %>%
    # mutate(annotation = ifelse(dataset_ID %in% with_bacteria_1to5, "1:5 OP50",annotation)) %>%
    mutate(annotation = ifelse(dataset_ID %in% sixhonfood_1to10, "6h on food, 1:10 OP50",annotation)) %>%
    mutate(annotation = ifelse(dataset_ID %in% sixhonfood_empty, "6h on food, empty",annotation)) %>%
    #round per half an hour
    mutate(hours_rounded= floor(hours* 2) / 2) %>%
    #filter out first 30 mins
    filter(hours_rounded > 0.0) %>%
    na.omit()

```

## Plot mean values for certain parameters
### Plot either standard error or 95% confidence interval as error bars
```{r, echo=TRUE}

#This is just for selecting colors
pal <- wes_palette("Darjeeling1",5)
#Until how many hours
show_until <- 9

#select parameters to plot
params <- c("p_perc_turn", "p_perc_pause", "p_perc_omega_turn")

for (i in params){
  data <- imported_data_grouped %>%
      #calculate mean per rounded hour timepoint and condition (over all datasets)
      group_by(annotation, hours_rounded) %>%
      summarise(mean = mean(get(i), na.rm = TRUE),
              sd = sd(get(i), na.rm = TRUE),
              n = n()) %>%
     mutate(se = sd / sqrt(n),
           lower_ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
           upper_ci = mean + qt(1 - (0.05 / 2), n - 1) * se) %>%
      group_by(annotation) %>%
      #calculate the average number of tracks per annotation over all timepoints
      mutate(mean_number_of_tracks_per_roundedtp_exptype = round(mean(n))) %>%
      ungroup() %>%
      mutate(annotation = paste0(annotation, "\n(", round(mean_number_of_tracks_per_roundedtp_exptype),")")) %>%
      filter(hours_rounded <= show_until)
  
  ggplot(data,aes(x=hours_rounded,y=mean,color=annotation,group=annotation))+
    geom_line(size=1.5)+
    geom_point(color="black")+
    geom_errorbar(width=.2, aes(ymin=mean-se, ymax=mean+se))+
    geom_ribbon(aes(ymin=mean-se, ymax=mean+se), fill="darkgray",linetype = 0, alpha=0.2)+
    ggtitle(paste0(i," with standard error of the mean"))+
    scale_y_continuous(limits = c(0, (max(data$mean)+max(data$se))))+
    scale_x_continuous(limits = c(0, show_until),breaks = seq(0, show_until, 1))+
    xlab("hours") + ylab("relative occurence per track")+
    theme_linedraw()+
    theme(legend.direction="horizontal",
          legend.position = "top",
          strip.background = element_rect(colour = "black", fill = "white"),
          strip.text.x = element_text(colour = "black", face = "bold"),
          axis.text.x = element_text(size=20),
          axis.text.y = element_text(size=20))+
    scale_color_manual(values =pal)+
    facet_wrap(~annotation,scales="free")+
    ggsave(file.path(save_path,paste0(show_until,"h_",i,"_with_mean_line_with_error_of_the_mean",".png")),height=10,width=15)

}



```




## Plot histogram for velocity

```{r, echo=TRUE}


#This is just for selecting colors
pal <- wes_palette("Darjeeling1",5)
#Until how many hours
show_until <- 9

#get overall statistics for mean track velocity
summary(imported_data_grouped$p_mean_velocity)
upper_quantile <- 0.95
lower_quantile <- 0.05

quantile(imported_data_grouped$p_mean_velocity, upper_quantile)
quantile(imported_data_grouped$p_mean_velocity, lower_quantile)


number_of_conditions <- length(unique(imported_data_grouped$annotation))

imported_data_grouped %>%
  filter(p_mean_velocity <= quantile(imported_data_grouped$p_mean_velocity, upper_quantile)) %>%
  filter(p_mean_velocity >= quantile(imported_data_grouped$p_mean_velocity, lower_quantile)) %>%
  filter(hours_rounded <= show_until) %>%
  ggplot(.,aes(p_mean_velocity,color=annotation))+
    geom_histogram(bins=50,aes(y=..density..),color="black",fill="black")+
    geom_density(alpha=.3, size=2) +
    scale_x_continuous(limits=c(0,quantile(imported_data_grouped$p_mean_velocity, upper_quantile))) +
    xlab("") + ylab("mean path angle")+
    facet_wrap(vars(annotation,hours_rounded),ncol=show_until*2,scales="free_x")+
    theme_linedraw() +
    theme(legend.direction="horizontal",
      legend.position = "top",
      strip.background = element_rect(colour = "black", fill = "white"),
      strip.text.x = element_text(colour = "black", face = "bold"),
      axis.text.x = element_text(size=15),
      axis.text.y = element_text(size=20))+
    scale_fill_manual(values=pal)+
    scale_color_manual(values=pal)+
    ggsave(file.path(save_path,paste0("histo_velocity_with_fit",".png")),height=20,width=30)
  


```

```{r, echo=TRUE}

pal <- wes_palette("Darjeeling1",5)
show_until <- 6

mean_angle <- imported_data_grouped %>%
    group_by(annotation, hours_rounded) %>%
    summarise(mean = mean(p_mean_angle, na.rm = TRUE),
            sd = sd(p_mean_angle, na.rm = TRUE),
            n = n()) %>%
   mutate(se = sd / sqrt(n),
         lower_ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper_ci = mean + qt(1 - (0.05 / 2), n - 1) * se) %>%
    group_by(annotation) %>%
    mutate(mean_number_of_tracks_per_roundedtp_exptype = round(mean(n))) %>%
    ungroup() %>%
    mutate(annotation = paste0(annotation, "\n(", round(mean_number_of_tracks_per_roundedtp_exptype),")")) %>%
    filter(hours_rounded <= show_until)


print(ggplot(mean_angle,aes(x=hours_rounded,y=mean,color=annotation,group=annotation))+
  geom_line(size=1)+
  geom_point()+
  geom_errorbar(width=.1, aes(ymin=mean-se, ymax=mean+se))+
  geom_ribbon(aes(ymin=mean-se, ymax=mean+se), fill="darkgray",linetype = 0, alpha=0.2)+
  # ggtitle(paste0(i," with standard error of the mean"))+
  scale_x_continuous(limits = c(0,show_until),breaks = seq(0, show_until, 1))+
  xlab("hours") + ylab("Average worm path angle (degrees)")+
  theme_bw()+
  theme(legend.direction="vertical",
        plot.background = element_rect(fill = "black"))+
  facet_wrap(~annotation)+
  scale_color_manual(values =pal)+
  #theme(axis.title=element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), plot.background = element_rect(fill = "black"))
  ggsave(file.path(save_path,paste0("mean_angle_line",".png")),height=10,width=15)
)



# unique_tracks<-imported_data_grouped %>%
#   filter(hours_rounded < 6.5) %>%
#   mutate(ID = paste0(dataset_ID,"_",tp,"_",TrackID)) %>%
#   group_by(hours_rounded,annotation) %>%
#   summarise(n=n_distinct(ID))
# 
# write.csv(unique_tracks, file.path(save_path, "unique_tracks_per_timepoint"))


imported_data_grouped %>%
  filter(hours_rounded < 6.5) %>%
  ggplot(.,aes(p_mean_angle))+
    geom_histogram(bins=50,aes(y=..density..), fill="white")+
    # geom_density(alpha=.3, fill="gold") +
    xlab("") + ylab("mean path angle")+
    facet_wrap(vars(annotation,hours_rounded),ncol=12)+
    theme_black()



  ggsave(file.path(save_path,paste0("histo_path_angle_no_fit",".png")),height=20,width=30)
```


```{r, echo=TRUE}


pal <- wes_palette("Darjeeling1",5)
show_until <- 6


boxplot <- imported_data_grouped %>%
  filter(hours_rounded <= show_until)
  

ggplot(boxplot,aes(x=as.character(hours_rounded),y=p_mean_angle,fill=annotation))+
  # geom_boxplot()+
  geom_violin(draw_quantiles=1)+
  #ggtitle(paste0(i," with standard error of the mean"))+
  # scale_x_continuous(limits = c(0,9),breaks = seq(0, 9, 1))+
  # xlab("hours") + ylab("Average turns per s")+
  theme_bw()+
  theme(legend.direction="vertical",
  plot.background = element_rect(fill = "black"))+
  facet_wrap(~annotation)+
  scale_fill_manual(values =pal)
  ggsave(file.path(save_path,paste0("violinplot_mean_angle",".png")),height=10,width=15)

ggplot(boxplot,aes(x=as.character(hours_rounded),y=p_mean_angle,fill=annotation))+
  geom_boxplot()+
  # geom_violin(draw_quantiles=1)+
  #ggtitle(paste0(i," with standard error of the mean"))+
  # scale_x_continuous(limits = c(0,9),breaks = seq(0, 9, 1))+
  # scale_y_continuous(limits = c(0,0.2))+
  # xlab("hours") + ylab("Average turns per s")+
  theme_bw()+
  theme(legend.direction="vertical",
  plot.background = element_rect(fill = "black"))+
  facet_wrap(~annotation)+
  ggsave(file.path(save_path,paste0("boxplot_mean_angle",".png")),height=10,width=15)

ggplot(boxplot,aes(x=as.character(hours_rounded),y=p_perc_turn,fill=annotation))+
  # geom_boxplot()+
  geom_violin(draw_quantiles=1)+
  #ggtitle(paste0(i," with standard error of the mean"))+
  # scale_x_continuous(limits = c(0,9),breaks = seq(0, 9, 1))+
  # xlab("hours") + ylab("Average turns per s")+
  theme_bw()+
  theme(legend.direction="vertical",
  plot.background = element_rect(fill = "black"))+
  facet_wrap(~annotation)+
  scale_fill_manual(values =pal)
  ggsave(file.path(save_path,paste0("violinplot_perc_turn",".png")),height=10,width=15)

ggplot(boxplot,aes(x=as.character(hours_rounded),y=p_perc_turn,fill=annotation))+
  geom_boxplot()+
  # geom_violin(draw_quantiles=1)+
  #ggtitle(paste0(i," with standard error of the mean"))+
  # scale_x_continuous(limits = c(0,9),breaks = seq(0, 9, 1))+
  # scale_y_continuous(limits = c(0,0.2))+
  # xlab("hours") + ylab("Average turns per s")+
  theme_bw()+
  theme(legend.direction="vertical",
  plot.background = element_rect(fill = "black"))+
  facet_wrap(~annotation)+
  ggsave(file.path(save_path,paste0("boxplot_perc_turn",".png")),height=10,width=15)


ggplot(boxplot,aes(x=as.character(hours_rounded),y=p_perc_pause,fill=annotation))+
  # geom_boxplot()+
  geom_violin(draw_quantiles=1)+
  #ggtitle(paste0(i," with standard error of the mean"))+
  # scale_x_continuous(limits = c(0,9),breaks = seq(0, 9, 1))+
  # xlab("hours") + ylab("Average turns per s")+
  theme_bw()+
  theme(legend.direction="vertical",
  plot.background = element_rect(fill = "black"))+
  facet_wrap(~annotation)+
  scale_fill_manual(values =pal)+
  ggsave(file.path(save_path,paste0("violinplot_perc_pause",".png")),height=10,width=15)

ggplot(boxplot,aes(x=as.character(hours_rounded),y=p_perc_pause,fill=annotation))+
  geom_boxplot()+
  # geom_violin(draw_quantiles=1)+
  #ggtitle(paste0(i," with standard error of the mean"))+
  # scale_x_continuous(limits = c(0,9),breaks = seq(0, 9, 1))+
  # scale_y_continuous(limits = c(0,0.2))+
  # xlab("hours") + ylab("Average turns per s")+
  theme_bw()+
  theme(legend.direction="vertical",
  plot.background = element_rect(fill = "black"))+
  facet_wrap(~annotation)+
  ggsave(file.path(save_path,paste0("boxplot_perc_pause",".png")),height=10,width=15)



```




```{r, echo=TRUE}
show_until <- 6

heatmap <- imported_data_grouped %>%
  filter(hours_rounded <= show_until)


ggplot(heatmap,aes(x = p_mean_angle, y = p_mean_velocity))+
  # stat_density_2d(aes(fill = ..ndensity..),contour=FALSE,geom="raster")+
  # stat_density_2d(aes(fill = stat(nlevel)), geom = "polygon")+
  geom_point(colour="white",alpha=0.2)+
  # scale_fill_viridis(option = "inferno")+
  scale_x_log10(limits=c(1,180))+
  scale_y_log10()+
  theme_black()+
  coord_fixed(ratio = 1)+
  facet_wrap(annotation+hours_rounded ~ ., nrow=length(unique(heatmap$annotation)), ncol= show_until*2)+
  ggsave(file.path(save_path,paste0("roaming_dwelling_heatmap_show_all_points",".png")),height=15,width=30)


ggplot(heatmap,aes(x = p_mean_angle, y = p_mean_velocity))+
  stat_density_2d(aes(fill = ..ndensity..),contour=FALSE,geom="raster")+
  # stat_density_2d(aes(fill = stat(nlevel)), geom = "polygon")+
  # geom_point(colour="white",alpha=0.2)+
  scale_fill_viridis(option = "inferno")+
  scale_x_log10(limits=c(1,180))+
  scale_y_log10()+
  theme_black()+
  coord_fixed(ratio = 1)+
  facet_wrap(annotation+hours_rounded ~ ., nrow=length(unique(heatmap$annotation)), ncol=  show_until*2)+
  ggsave(file.path(save_path,paste0("roaming_dwelling_heatmap_relative",".png")),height=15,width=30)


```

```{r, echo=TRUE}

pal <- wes_palette("Darjeeling1",5)[c(3,5)]


imported_data_grouped %>%
  filter(hours_rounded <= show_until)  %>%
  mutate(ratio = p_mean_velocity/p_mean_angle) %>%
  mutate(behavioral_state=ifelse(ratio > 1, "roaming","dwelling")) %>%
  ggplot(.,aes(x = p_mean_angle, y = p_mean_velocity,color=behavioral_state))+
    geom_point(alpha=0.1)+
    facet_wrap(annotation+hours_rounded ~ ., nrow=length(unique(heatmap$annotation)), ncol= show_until*2)+
    theme_black()+
    coord_fixed(ratio = 1)+
    scale_x_log10(limits=c(1,180))+
    scale_y_log10()+
    ggsave(file.path(save_path,paste0("roaming_dwelling_heatmap_binarized",".png")),height=10,width=15)


binarized <- imported_data_grouped %>%
  filter(hours_rounded <= show_until)  %>%
  mutate(ratio = p_mean_velocity/p_mean_angle) %>%
  mutate(behavioral_state=ifelse(ratio > 1, "roaming","dwelling")) %>%
  group_by(annotation,hours_rounded,behavioral_state,dataset_ID) %>%
  summarise(counts=n()) %>%
  group_by(annotation,hours_rounded,dataset_ID) %>%
  mutate(sum=sum(counts)) %>%
  mutate(perc = counts/sum)



ggplot(binarized,aes(x=as.character(hours_rounded),y=perc,fill=behavioral_state,color=behavioral_state))+
      geom_boxplot(outlier.shape = NA)+
      geom_point(position=position_dodge(width=0.75),aes(group=behavioral_state),color="white",alpha=0.5)+
      # geom_violin(draw_quantiles=1)+
      #ggtitle(paste0(i," with standard error of the mean"))+
      # scale_y_continuous(limits = c(0,0.2))+
      xlab("hours") + ylab("Relative occurence of \nbehavioral state")+
      facet_wrap(annotation ~ .)+
      theme_black()+
      theme(legend.direction="vertical")+
      scale_fill_manual(values =pal)+
      scale_color_manual(values=pal)+
      coord_fixed(ratio = 10)+
      ggsave(file.path(save_path,paste0("roaming_dwelling_relative",".png")),height=10,width=15)
```



