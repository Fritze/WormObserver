  
#Define locations and datasets to include
  
```{r, echo=FALSE}
#bins or tracks?
average <- "tracks"
  
target_folder <- "/home/fpreuss/raid/timelapses/analysis/200318/data"
save_path <- file.path("/home/fpreuss/raid/timelapses/analysis/200318/plots/",average)
  
#list of centroid tracking .rds files in data folder
files_to_process <- list.files(target_folder, paste0("centroid_tracking_",average,".rds"),full.names = TRUE, ignore.case = TRUE)
  
order  <- c("N2 1:5 OP50",
            "N2 1:10 OP50",
            "N2 no food",
            "N2 1:10 after 6h exit",
            "N2 1:10 OP50 after 6h exit", ###
            "N2 empty after 6h exit",
            "daf2"
            )
  
imported_data <- map_dfr(files_to_process,readRDS) %>%
    #round per half an hour
    # mutate(hours_rounded= floor(hours * 2) / 2) %>%
    #round per hour
    mutate(hours_rounded = ceiling(hours)) %>%
    #filter out first 30 mins
    filter(hours_rounded > 0.0) %>%
    #take out one condition
    filter(!annotation %in% c("L2")) %>%
    # filter(!dataset_ID %in% c("2019-05-07_12-15-40")) %>%
    na.omit() %>%
    #custom order of conditions
    left_join(tibble(annotation=order),by="annotation")
  
#levels must be changed for ggplot to take new order into account
imported_data$annotation = factor(imported_data$annotation, levels=order)
  
unique(imported_data$annotation)
```
  
  
#Overview of tracks per dataset and mean track duration over time
```{r, echo=FALSE}
  
downsampled_to <- 2
  
  
imported_data %>%
  select(hours, dataset_ID, TrackID) %>%
  group_by(hours, dataset_ID) %>%
  summarise(.,n = n_distinct(TrackID)) %>%
  ggplot(.,aes(x=hours,y=n,fill=dataset_ID,colour=dataset_ID))+
  #scale_colour_manual(values = wes_palette("BottleRocket2"))+
  #geom_line()+
  geom_smooth(method="loess")+
  ylab("Number of tracked worms")+
  theme_classic()
  
imported_data %>%
  select(hours,dataset_ID, TrackID, Duration_of_track) %>%
  group_by(hours, dataset_ID) %>%
  summarise(., mean_duration =mean(Duration_of_track)/downsampled_to) %>%
  ggplot(.,aes(x=hours,y=mean_duration,fill=dataset_ID,colour=dataset_ID))+
  #scale_colour_manual(values = wes_palette("BottleRocket2"))+
  #geom_line()+
  geom_smooth(method="loess")+
  # geom_hline(yintercept=duration,color="red")+
  ylab("Mean duration of tracks (seconds)")+
  theme_classic()
  
  
```
  
  
  
## Plot histogram for velocity
  
```{r, echo=TRUE}
  
library(jcolors)
#This is just for selecting colors
pal <- wes_palette("Darjeeling1",5)

#Until how many hours
show_until <- 9

#number of bins
number_of_bins <- 50
#define quantiles
upper_quantile <- 0.95
lower_quantile <- 0.05
  
#get overall statistics for mean track velocity
summary(imported_data$p_mean_velocity)
  
#number of tracks not used for analysis
imported_data %>%
  group_by(annotation) %>%
  # summarise(upper_quantile = quantile(p_mean_velocity, upper_quantile))
  filter(p_mean_velocity > quantile(p_mean_velocity, upper_quantile)) %>%
  summarise(n= n())
           
  
  
data <- imported_data %>%
  #filter out samples below and above quantile threshold
  filter(p_mean_velocity <= quantile(p_mean_velocity, upper_quantile)) %>%
  filter(p_mean_velocity >= quantile(p_mean_velocity, lower_quantile)) %>%
  filter(hours_rounded <= show_until) %>%
  # scale velocity to mm/s
  mutate(p_mean_velocity = p_mean_velocity / 1000) %>%
  group_by(annotation, hours_rounded) %>%
  #count tracks per hour per condition
  mutate(number_of_tracks_in_this_hour = n_distinct(dataset_ID,tp,TrackID)) %>%
  arrange(hours_rounded)
  
  
ggplot(data,aes(p_mean_velocity,color=annotation,fill=annotation))+
    geom_histogram(bins=number_of_bins,aes(y=..density..),color="black",fill="black",alpha=0.1)+
    geom_density(alpha=0.3, size=1.5) +
    scale_x_continuous(limits=c(0,quantile(data$p_mean_velocity, upper_quantile))) +
    xlab("average track velocity (mm/s)") + ylab("counts")+
    facet_wrap(vars(annotation,hours_rounded,number_of_tracks_in_this_hour),ncol=length(unique(data$hours_rounded)),scales="free_x")+
    theme_linedraw() +
    theme(legend.direction="horizontal",
      legend.position = "top",
      strip.background = element_rect(colour = "white", fill = "white"),
      panel.spacing = unit(1, "lines"),
      strip.text.x = element_text(size=25,colour = "black", face = "bold"),
      axis.text.x = element_text(size=30),
      axis.title.x = element_text(size=25),
      axis.text.y = element_text(size=35),
      axis.title.y = element_text(size=25))+
    # scale_fill_manual(values=pal)+
    # scale_color_manual(values=pal)+
    scale_fill_jcolors(palette = "pal7")+
    scale_color_jcolors(palette = "pal7")+
    ggsave(file.path(save_path,paste0("histo_velocity_with_fit",".png")),height=35,width=35)
    
  
  
```
  
## Plot histogram for angle
  
```{r, echo=TRUE}
  

#This is just for selecting colors
pal <- wes_palette("Darjeeling1",5)
#Until how many hours
show_until <- 9
  
#number of bins
number_of_bins <- 50
  
  
#get overall statistics for mean track velocity
summary(imported_data$p_mean_angle)
  
          
  
data <- imported_data %>%
  filter(hours_rounded <= show_until) %>%
  group_by(annotation, hours_rounded) %>%
  #count tracks per hour per condition
  mutate(number_of_tracks_in_this_hour = n_distinct(dataset_ID,tp,TrackID)) %>%
  arrange(hours_rounded)
  
  
ggplot(data,aes(p_mean_angle,color=annotation,fill=annotation))+
    geom_histogram(bins=number_of_bins,aes(y=..density..),color="black",fill="black",alpha=0.1)+
    geom_density(alpha=0.3, size=1.5) +
    xlab("angular velocity (degree/s)") + ylab("counts")+
    facet_wrap(vars(annotation,hours_rounded,number_of_tracks_in_this_hour),ncol=length(unique(data$hours_rounded)),scales="free_x")+
    theme_linedraw() +
    theme(legend.direction="horizontal",
      legend.position = "top",
      strip.background = element_rect(colour = "white", fill = "white"),
      panel.spacing = unit(1, "lines"),
      strip.text.x = element_text(size=25,colour = "black", face = "bold"),
      axis.text.x = element_text(size=30),
      axis.title.x = element_text(size=25),
      axis.text.y = element_text(size=35),
      axis.title.y = element_text(size=25))+
    #scale_fill_manual(values=pal)+
    #scale_color_manual(values=pal)+
    scale_fill_jcolors(palette = "pal7")+
    scale_color_jcolors(palette = "pal7")+
    ggsave(file.path(save_path,paste0("histo_angle_with_fit",".png")),height=35,width=35)
    
  
  
```
  
  
  
  
```{r, echo=TRUE}
  
  
#Until how many hours
show_until <- 9
  
  
library(pals)
  
data <- imported_data %>%
  filter(hours_rounded <= show_until) %>%
  group_by(annotation, hours_rounded) %>%
  #count tracks per hour per condition
  mutate(number_of_tracks_in_this_hour = n_distinct(dataset_ID,tp,TrackID)) %>%
  # scale velocity to mm/s
  mutate(p_mean_velocity = p_mean_velocity / 1000) %>%
  arrange(hours_rounded)
  
  
ggplot(data,aes(x = p_mean_angle, y = p_mean_velocity,color=dataset_ID))+
  geom_point(alpha=0.2)+
  theme_linedraw()+
  ylab("velocity (mm/s)") + xlab("angular velocity (degree/s)")+
  scale_y_log10()+
  scale_x_continuous(limits=c(0,180))+
  theme(legend.direction="horizontal",
      legend.position = "top",
      strip.background = element_rect(colour = "white", fill = "white"),
      panel.spacing = unit(1, "lines"),
      strip.text.x = element_text(size=25,colour = "black", face = "bold"),
      axis.text.x = element_text(size=30),
      axis.title.x = element_text(size=45),
      axis.text.y = element_text(size=35),
      axis.title.y = element_text(size=45))+
  scale_color_manual(values=as.vector(alphabet(26)))+
  facet_wrap(vars(annotation,hours_rounded,number_of_tracks_in_this_hour),ncol=length(unique(data$hours_rounded)),scales="free_x")+
  ggsave(file.path(save_path,paste0("scatter_roaming_dwelling_heatmap_show_all_points_datasets_individually",".png")),height=35,width=35)
  
ggplot(data,aes(x = p_mean_angle, y = p_mean_velocity))+
  geom_pointdensity()+
  scale_color_viridis(option = "inferno")+
  theme_classic()+
  ylab("velocity (mm/s)") + xlab("angular velocity (degree/s)")+
  scale_y_log10()+
  scale_x_continuous(limits=c(0,180))+
  theme(strip.background = element_rect(colour = "white", fill = "white"),
      panel.spacing = unit(1, "lines"),
      strip.text.x = element_text(size=25,colour = "black", face = "bold"),
      axis.text.x = element_text(size=30),
      axis.title.x = element_text(size=45),
      axis.text.y = element_text(size=35),
      axis.title.y = element_text(size=45))+
  facet_wrap(vars(annotation,hours_rounded,number_of_tracks_in_this_hour),ncol=length(unique(data$hours_rounded)),scales="free_x")+
  ggsave(file.path(save_path,paste0("scatter_roaming_dwelling_heatmap_show_all_points_and_density",".png")),height=35,width=35)
  
  
```
  
```{r, echo=TRUE}
  
  
  
data_binarized <- imported_data %>%
  mutate(ratio = p_mean_velocity/p_mean_angle) %>%
  #calculate ratio, this will give result in a diagonal (see binarized_not_log plot)
  mutate(behavioral_state=ifelse(ratio > 1, "roaming","dwelling")) %>%
  # scale velocity to mm/s
  mutate(p_mean_velocity = p_mean_velocity / 1000) %>%
  filter(hours_rounded <= show_until) %>%
  group_by(annotation, hours_rounded) %>%
  #count tracks per hour per condition
  mutate(number_of_tracks_in_this_hour = n_distinct(dataset_ID,tp,TrackID)) %>%
  arrange(hours_rounded)
  
binarized <- ggplot(data_binarized,aes(x = p_mean_angle, y = p_mean_velocity,color=behavioral_state))+
  geom_point(alpha=0.05)+
  theme_linedraw()+
  ylab("velocity (mm/s)") + xlab("angular velocity (degree/s)")+
  scale_x_continuous(limits=c(0,180))+
    theme(legend.direction="horizontal",
      legend.position = "top",
      strip.background = element_rect(colour = "white", fill = "white"),
      panel.spacing = unit(1, "lines"),
        strip.text.x = element_text(size=15,colour = "black", face = "bold"),
        axis.text.x = element_text(size=30),
        axis.title.x = element_text(size=45),
        axis.text.y = element_text(size=35),
        axis.title.y = element_text(size=45))+
  facet_wrap(vars(annotation,hours_rounded,number_of_tracks_in_this_hour),ncol=length(unique(data$hours_rounded)),scales="free_x")
  
binarized + ggsave(file.path(save_path,paste0("scatter_roaming_dwelling_heatmap_binarized_not_log",".png")),height=35,width=35)
binarized + scale_y_log10() + ggsave(file.path(save_path,paste0("scatter_roaming_dwelling_heatmap_binarized",".png")),height=35,width=35)
  
pal <- wes_palette("Darjeeling1",5)[c(3,5)]
  
  
data_summarised <- data_binarized %>%
  #counts per behavioral state
  group_by(annotation,hours_rounded,behavioral_state,dataset_ID) %>%
  summarise(counts=n()) %>%
  #total counts
  group_by(annotation,hours_rounded,dataset_ID) %>%
  mutate(sum=sum(counts)) %>%
  #relative occurence of beahvioral_state
  mutate(perc = counts/sum) %>%
  #extract first timepoint percentage for every condition
  mutate(first = case_when(hours_rounded == 1  ~ perc)) %>%
  group_by(dataset_ID,behavioral_state) %>%
  fill(first, .direction="down") %>%
  #normalize by first timepoint
  mutate(perc_norm = perc/first)
  
ggplot(data_summarised,aes(x=as.character(hours_rounded),y=perc,fill=behavioral_state))+
      geom_boxplot(lwd=1.75)+
      scale_fill_manual(values =pal)+
      geom_point(position=position_dodge(width=0.75),aes(group=behavioral_state),color="red",alpha=0.75,size=2)+
      xlab("hours") + ylab("Relative occurence of \nbehavioral state")+
      facet_wrap(annotation ~ .)+
      theme_linedraw()+
      theme(
        legend.direction="horizontal",
        legend.position = "top",
        strip.background = element_rect(colour = "white", fill = "white"),
        panel.spacing = unit(1, "lines"),
        strip.text.x = element_text(size=15,colour = "black", face = "bold"),
        axis.text.x = element_text(size=30),
        axis.title.x = element_text(size=45),
        axis.text.y = element_text(size=30),
        axis.title.y = element_text(size=45),
        legend.key.size = unit(2.5, "cm"))+
      facet_wrap(vars(annotation),scales="free")+
      ggsave(file.path(save_path,paste0("scatter_roaming_dwelling_relative",".png")),height=20,width=20)
  
  
  
ggplot(data_summarised,aes(x=as.character(hours_rounded),y=perc_norm,fill=behavioral_state))+
      geom_boxplot(lwd=1.75)+
      geom_point(position=position_dodge(width=0.75),aes(group=behavioral_state),color="red",alpha=0.75)+
      # scale_x_continuous(breaks = )
      xlab("hours") + ylab("Relative occurence of \nbehavioral state")+
      facet_wrap(annotation ~ .) +
      theme_linedraw()+
      scale_fill_manual(values =pal)+
      theme(
        legend.direction="horizontal",
        legend.position = "top",
        strip.background = element_rect(colour = "white", fill = "white"),
        panel.spacing = unit(1, "lines"),
        strip.text.x = element_text(size=15,colour = "black", face = "bold"),
        axis.text.x = element_text(size=30),
        axis.title.x = element_text(size=45),
        axis.text.y = element_text(size=30),
        axis.title.y = element_text(size=45),
        legend.key.size = unit(2.5, "cm"))+
      facet_wrap(vars(annotation),scales="free")+
      ggsave(file.path(save_path,paste0("scatter_roaming_dwelling_relative_to_1h",".png")),height=20,width=20)
```
  
  
```{r, echo=TRUE}

library(ggsignif) #installed from github


data_binarized_only_roaming <-data_binarized %>%
  filter(behavioral_state == "roaming") %>%
  select(hours_rounded, annotation, p_mean_velocity)

ggplot(data_binarized_only_roaming, aes(y=p_mean_velocity, x=as.character(hours_rounded)))+
  geom_violin(lwd=1.75)+
  geom_boxplot(aes(fill=annotation),width=0.2,outlier.alpha = 0.3,outlier.size = 2,lwd=1.75)+
  theme_linedraw()+
  labs(x="hours",y="Roaming velocity (mm/s)")+
  theme(legend.direction="horizontal",
        legend.position = "top",
        strip.background = element_rect(colour = "white", fill = "white"),
        panel.spacing = unit(1, "lines"),
        strip.text.x = element_text(size=15,colour = "black", face = "bold"),
        axis.text.x = element_text(size=30),
        axis.title.x = element_text(size=45),
        axis.text.y = element_text(size=30),
        axis.title.y = element_text(size=45),
        plot.title = element_text(size = 40, face = "bold"),
        legend.key.size = unit(2.5, "cm"))+
  facet_wrap(vars(annotation),scales="free_x")+
  scale_fill_jcolors(palette = "pal7")+
  scale_color_jcolors(palette = "pal7")+
  ggtitle("Velocity average, only for roaming fraction")+
  ggsave(file.path(save_path,paste0("violin_roaming_average_velocity_all_hours",".png")),height=20,width=20)


data_binarized_only_roaming %>%
  filter(hours_rounded %in% c(1,6)) %>%
  ggplot(., aes(y=p_mean_velocity, x=as.character(hours_rounded)))+
  geom_violin(lwd=1.75)+
  geom_boxplot(aes(fill=annotation),width=0.2,outlier.alpha = 0.3,outlier.size = 2,lwd=1.75)+
  geom_signif(comparisons = list(c("1", "6")),
            test="wilcox.test",
            map_signif_level = TRUE,
            textsize=10,
            size=2) +
  theme_linedraw()+
  labs(x="hours",y="Roaming velocity (mm/s)")+
  scale_y_continuous(limits=c(0,0.21))+
  theme(legend.direction="horizontal",
        legend.position = "top",
        strip.background = element_rect(colour = "white", fill = "white"),
        panel.spacing = unit(1, "lines"),
        strip.text.x = element_text(size=15,colour = "black", face = "bold"),
        axis.text.x = element_text(size=30),
        axis.title.x = element_text(size=45),
        axis.text.y = element_text(size=30),
        axis.title.y = element_text(size=45),
        plot.title = element_text(size = 40, face = "bold"),
        legend.key.size = unit(2.5, "cm"))+
  facet_wrap(vars(annotation),scales="free_x")+
  scale_fill_jcolors(palette = "pal7")+
  scale_color_jcolors(palette = "pal7")+
  ggtitle("Velocity average, only for roaming fraction")+
  ggsave(file.path(save_path,paste0("violin_roaming_average_velocity_two_hours_with_signif",".png")),height=20,width=20)



```
