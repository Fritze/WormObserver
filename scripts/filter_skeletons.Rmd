#Filter skeleton
```{r, include=FALSE}

target_folder<-"/home/fpreuss/raid/timelapses/analysis/200318/data/posture"
save_path <- "/home/fpreuss/raid/timelapses/analysis/200318/data/posture"

#Define the minimum number of consecutive frames for a posture (with head) to be taken into account
min_frames <- 20


suffix <- "_with_headext_reordered.rds"

list_of_datasets <- matrix(c(
  "2019-03-26_19-27-16", "N2 1:10 OP50",
  "2019-03-27_18-24-47", "N2 1:10 OP50",
  ###"2019-11-25_17-28-23", "N2 1:10 OP50",
  "2019-07-08_18-33-57", "N2 1:5 OP50",
  "2019-07-09_18-22-34", "N2 1:5 OP50",
  ###"2019-11-11_16-17-33", "N2 1:5 OP50",
  ###"2019-03-25_18-10-06", "N2 no food",
  "2019-11-18_18-43-57", "N2 no food",
  "2019-11-20_17-29-55", "N2 no food",
  "2019-04-23_17-46-08", "daf2",
  "2019-05-07_12-15-40", "daf2",
  "2019-04-30_14-15-44", "L2",
  "2019-05-04_15-36-42", "L2",
  "2020-02-20_18-53-49", "N2 1:10 OP50 after 6h exit",
  "2020-02-21_15-58-43", "N2 1:10 OP50 after 6h exit"
  ###"2020-03-03_19-35-55", "N2 1:10 OP50 after 6h exit",
  ###"2020-02-26_18-31-08", "N2 empty after 6h exit",
  ###"2020-02-27_17-51-43", "N2 empty after 6h exit",
  ###"2020-02-28_17-38-15", "N2 empty after 6h exit"
  ),byrow = TRUE,ncol=2)

colnames(list_of_datasets) <- c("dataset_ID", "annotation")

nested_list_of_datasets <- list_of_datasets %>%
  as.data.frame(.) %>%
  nest(data=c(dataset_ID))

for (row in 1:nrow(nested_list_of_datasets)){
  file_name <-paste0(as.character(pull(unnest(nested_list_of_datasets[row,2],cols=c(data)))),suffix)
  annotation <- as.character(pull(nested_list_of_datasets[row,1]))
  file_locations <- map_chr(file_name, function(x){list.files(path=target_folder,pattern=x, full.names = TRUE)})
  skeleton_data_filtered <- file_locations %>%
    map_df(.,function(x) readRDS(x)) %>%
    mutate(annotation = annotation) %>%
    group_by(dataset_ID,tp,TrackID,frame) %>%
    #only postures that have a "YES"
    filter(any(is_head=="YES")) %>%
    mutate(ID = paste0(dataset_ID, "_",tp,"_",TrackID,"_",frame)) %>%
    mutate(minutes = 10 + ((tp-1)*8+(tp-1)*0)) %>%
    group_by(dataset_ID,TrackID,tp) %>%
    mutate(TrackCheck_cleaned = replace_f(TrackCheck, 26*min_frames)) %>%
    drop_na("TrackCheck_cleaned") %>%
    ungroup() %>%
    group_by(dataset_ID,tp,TrackID,frame) %>%
    #all angles have to be between pi and -pi
    mutate(angle = ifelse(angle > pi & is.na(is_end), 2 * pi - angle,angle)) %>%
    mutate(angle = ifelse(angle < -pi & is.na(is_end), -2 * pi - angle,angle)) %>%
    ungroup()

  
  annotation_underscored <- gsub(" ", "_", annotation)
  created_file_path <- file.path(save_path,paste0("200407_", annotation_underscored ,"_minimum_",min_frames, "_frames", "_skeletons_filtered.rds"))
  saveRDS(skeleton_data_filtered, file = created_file_path)
  cat(paste0("\n\ndatasets ",paste(unique(skeleton_data_filtered$dataset_ID), collapse=" & "), " were filtered \nand saved under: ", created_file_path))

}
```
