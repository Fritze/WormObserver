#set parameters here
```{r, include=FALSE}

#Set the location folder of the raw data (of all experiments you want to plot)
base_path <- "/media/fpreuss/raid5/timelapses/analysis/200703/"

```

#load files
```{r, include=FALSE}

target_path <- file.path(base_path,"data", "other_raw")
save_path <- file.path(base_path,"plots")

#list of .rds files in data folder
files_to_process <- list.files(target_path, "raw_data.rds", full.names = TRUE, ignore.case = TRUE)

#select dataset
files_to_process <- grep(".+long.+", files_to_process,value=TRUE)

#pixel to Âµm conversion
#this is with magnifaction 3.2
conversion_factor <- 6.25


imported_data <- NULL
#load all .rds files and append to one data frame ('imported_data')
for (file in files_to_process){
  imported_data_temp <- readRDS(file) %>%
    #calculate average size, major and minor axis BY TRACK
    group_by(annotation,dataset_ID, tp,minutes,TrackID) %>%
    summarise(size=mean(Size),major=mean(Major),minor=mean(Minor)) %>%
    #round to full hour steps
    mutate(hours_rounded = ceiling(minutes/60)) %>%
    filter(hours_rounded <= 20) %>%
    mutate(time= ifelse(hours_rounded < 5, 5, NA)) %>%
    mutate(time = ifelse(hours_rounded < 10 & hours_rounded > 5, 10, time)) %>%
    mutate(time = ifelse(hours_rounded < 15 & hours_rounded > 10, 15, time)) %>%
    mutate(time = ifelse(hours_rounded <= 20 & hours_rounded > 15, 20, time)) %>%
    na.omit() %>%
    mutate(major = conversion_factor * major, minor = conversion_factor * minor)
  
  imported_data <- rbind(imported_data, imported_data_temp)  
}

```

#create plotting functions
```{r, include=FALSE}
library("ggridges")
library(wesanderson)

pal <- wes_palette("Darjeeling1")[c(1,5)]

#function to plot distributions
plot_distribution_ridges <- function(data_to_plot, X, Y){ 
  ggplot(data_to_plot,aes_string(x = X ,y =Y)) +
    geom_density_ridges_gradient(aes(fill=stat(x)),scale = 1) +
    scale_fill_viridis(option="magma",limits=c(0,1000)) +
    theme_classic()+
    labs(x="Size (px)",y="time (hours)")+
    theme(strip.background = element_rect(colour = "white", fill = "white"),
      strip.text.x = element_text(size=20,colour = "black", face = "bold"),
      axis.text.x = element_text(size=15, face="bold"),
      axis.title.x = element_text(size=20, face="bold"),
      axis.text.y = element_text(size=15, face="bold"),
      axis.title.y = element_text(size=20, face="bold"),
      axis.line = element_line(colour = 'black', size = 1.2),
      axis.ticks = element_line(colour = "black", size = 1.2))
}


plot_boxplots <- function(data_to_plot, X, Y){ 
  ggplot(data_to_plot,aes_string(x = X ,y =Y, fill="annotation")) +
    geom_boxplot(aes(fill=annotation),outlier.shape = NA)+
    geom_point(aes(fill=annotation),alpha=0.025,shape=21,position = position_jitterdodge())+
    theme_classic()+
    labs(x="time (hours)",y="Size (px)")+
    theme(strip.background = element_rect(colour = "white", fill = "white"),
      strip.text.x = element_text(size=20,colour = "black", face = "bold"),
      axis.text.x = element_text(size=15, face="bold"),
      axis.title.x = element_text(size=20, face="bold"),
      axis.text.y = element_text(size=15, face="bold"),
      axis.title.y = element_text(size=20, face="bold"),
      axis.line = element_line(colour = 'black', size = 1.2),
      axis.ticks = element_line(colour = "black", size = 1.2))+
    scale_fill_manual(values = pal)
}


plot_violins <- function(data_to_plot, X, Y){ 
  ggplot(data_to_plot,aes_string(x = X ,y =Y, fill="annotation")) +
    geom_violin(aes(fill=annotation),lwd=1.3)+
    theme_classic()+
    labs(x="time (hours)",y="Size (px)")+
    theme(strip.background = element_rect(colour = "white", fill = "white"),
      strip.text.x = element_text(size=20,colour = "black", face = "bold"),
      axis.text.x = element_text(size=15, face="bold"),
      axis.title.x = element_text(size=20, face="bold"),
      axis.text.y = element_text(size=15, face="bold"),
      axis.title.y = element_text(size=20, face="bold"),
      axis.line = element_line(colour = 'black', size = 1.2),
      axis.ticks = element_line(colour = "black", size = 1.2))+
    scale_fill_manual(values = pal)
}

plot_line <- function(data_to_plot, X, Y){ 
  ggplot(data_to_plot,aes_string(x = X ,y =Y, color="annotation",fill="annotation")) +
    geom_smooth(aes(group=annotation))+
    theme_classic()+
    labs(x="time (hours)",y="Size (px)")+
    #has to be defined in cartestian, otherwise it influences the data that goes into the geom_smooth calculation
    coord_cartesian(ylim = c(0,350))+
    theme(strip.background = element_rect(colour = "white", fill = "white"),
      strip.text.x = element_text(size=20,colour = "black", face = "bold"),
      axis.text.x = element_text(size=15, face="bold"),
      axis.title.x = element_text(size=20, face="bold"),
      axis.text.y = element_text(size=15, face="bold"),
      axis.title.y = element_text(size=20, face="bold"),
      axis.line = element_line(colour = 'black', size = 1.2),
      axis.ticks = element_line(colour = "black", size = 1.2))+
    scale_fill_manual(values = pal)+
    scale_color_manual(values = pal)
}

```

#make plots
```{r, include=FALSE}
save_path <- file.path(base_path,"plots","sizes")
dir.create(save_path)


for(a in unique(imported_data$annotation)){
  # new data frame with hours rounded by hour
  data_to_plot <- imported_data %>%
    filter(annotation == a)
  
  data_to_plot %>%
    arrange(hours_rounded) %>%
    mutate(hours_rounded=factor(hours_rounded, levels=unique(hours_rounded))) %>%
    plot_distribution_ridges(., "size", "hours_rounded")+
      ggsave(file.path(save_path,paste0("size_distri_",a,".png")),height=7,width=3.5)
  
}




imported_data %>%
  arrange(time) %>%
  mutate(time=factor(time, levels=unique(time))) %>%
  plot_distribution_ridges(., "size", "time")+
    facet_wrap(vars(annotation))+
    ggsave(file.path(save_path,paste0("size_distri_fewer_both",".png")),height=7,width=7)

imported_data %>%
  arrange(time) %>%
  mutate(time=factor(time, levels=unique(time))) %>%
  plot_boxplots(., "size", "time")+
    ggsave(file.path(save_path,paste0("size_boxplot_both",".png")),height=7,width=7)

imported_data %>%
  arrange(time) %>%
  mutate(time=factor(time, levels=unique(time))) %>%
  plot_violins(., "size", "time")+
    ggsave(file.path(save_path,paste0("size_violins_both",".png")),height=7,width=7)

imported_data %>%
  arrange(hours_rounded) %>%
  mutate(hours_rounded=factor(hours_rounded, levels=unique(hours_rounded))) %>%
  plot_line(., "hours_rounded", "size")+
    ggsave(file.path(save_path,paste0("size_line_both",".png")),height=7,width=7)

```
