#Select paths
```{r, include=FALSE}
base_path <- "/Users/fpreuss/Desktop/data/"
target_folder <- "/Users/fpreuss/Desktop/data/postures_clustered"

```

#Load data for clustering of posture libraries across annotations
```{r, include=FALSE}

#function to load posture library
#ID to unify posture IDs across annotations
load_cc <- function(x){
  readRDS(x) %>%
    mutate(annotation=gsub("^(.+)_cluster_centers_reduced.RDS", "\\1",basename(x))) %>%
    mutate(ID = paste0(newID, "_", annotation))
}

#all posture libraries (aka "cluster centers reduced") have to be in one folder
cc_list <- list.files(target_folder,"_cluster_centers_reduced.RDS", full.names = TRUE,recursive = TRUE)

#load data
cluster_centers_reduced <- cc_list %>%
  map_df(., load_cc)


```



#prepare data for clustering of posture libraries across annotations
#also we now cluster (unified) x/y positions instead of angles, this seems to work better...
```{r, include=FALSE}

plot_posture_examples <- function(data_to_plot,X,Y){
  ggplot(data_to_plot, aes_string(x=X,y=Y,color="angle"))+
    geom_point(size=3.5) +
    geom_path(size=2.5,lineend = "round") +
    theme_void()+
    coord_fixed(ratio = 1)+
    scale_color_gradient2(low = "deepskyblue", mid = "lavender",
                          high = "deeppink",midpoint=0,limits=c(-1,1),na.value="grey") +
    # scale_color_viridis(option = "plasma",limits=c(-1,1))+
    theme(plot.title = element_text(face = "bold"))
}


#create specific folder location that will be used to save the heatmaps
save_path <- file.path(base_path,"plots","posture","posture_groups")
dir.create(save_path, recursive = TRUE)

#data frame, every column is an x or y position for each segment of the posture (newID)
ccr_for_clustering <- filter(cluster_centers_reduced,newID_sub == 1) %>%
  select(ID,index,X,Y) %>%
  pivot_wider(names_from = index, values_from = c(X,Y)) %>%
  # mutate(newID = paste0("posture_", newID)) %>%
  column_to_rownames(var = "ID")

```

#here we perform the "elbow plot" for finding the right number of k clusters
```{r, include=FALSE}

# function to compute total within-cluster sum of square
wss <- function(k) {
  k <- kmeans(ccr_for_clustering, k)
  perc <- k$betweenss / k$totss
  return(perc)
}

# Compute and plot wss for k = 1 to k = 15
k_values <- 1:15

# extract wss for 2-15 clusters
wss_values <- data.frame(expvar = map_dbl(k_values, wss)) %>%
  mutate(k=k_values)

#do the plot
ggplot(data=wss_values,aes(x=k, y=expvar))+
  geom_point()+
  geom_line()+
  scale_x_continuous(breaks = seq(min(k_values), max(k_values)))+
  theme_classic()

```

#perform the clustering
#this is done by another round of kmeans clustering this time only on posture libraries but across annotations/datasets
```{r, include=FALSE}
#define the number of k for kmeans
how_many_clusters <- 2

#kmeans clustering is performed here
k_ccr <- kmeans(ccr_for_clustering, how_many_clusters)

#new dataframe that contains the ID (posture ID (newID) combined with annotatation) and the new posture group the new ID belongs to (after clustering)
postures_grouped <- data.frame(posture_grouped= as.character(k_ccr$cluster), ID = rownames(ccr_for_clustering),stringsAsFactors = FALSE)

#bring together original posture library with new posture group
cluster_centers_reduced_grouped <- left_join(cluster_centers_reduced, postures_grouped, by="ID") %>%
  filter(newID_sub == 1) %>%
  mutate(posture_grouped = paste0("group_",posture_grouped)) %>%
  select(annotation,newID,index,X,Y,angle, posture_grouped)


```

#Load data for quantifying posture group occurences (this is the angle_data_postures_per_dataset from "plot_postures.Rmd")
#we also need this to get ID2 (which is the names of postures in the heatmap)
```{r, include=FALSE}

#function to load posture library
#ID to unify posture IDs across annotations
load_cc <- function(x){
  readRDS(x) %>%
  mutate(annotation = gsub("^(..+)_perc_norm_angle_data_postures_per_dataset.RDS","\\1",basename(x)))
}

#all posture libraries (aka "cluster centers reduced") have to be in one folder
cc_list <- list.files(target_folder,"_angle_data_postures_per_dataset.RDS", full.names = TRUE,recursive=TRUE)

#load data and append new postures_grouped ID
angle_data_postures_per_dataset <- cc_list %>%
  map_df(., load_cc) %>%
  mutate(ID = paste0(newID, "_", gsub(" ","_",annotation))) %>%
  left_join(postures_grouped, by="ID") %>%
  select(-ID)

#this is a list for converting between newID (after first kmeans) and newID2 (after temporal clustering for heatmap)
conversion_newID_and_newID2 <- angle_data_postures_per_dataset %>%
  select(annotation,newID, newID2) %>%
  group_by(annotation,newID, newID2) %>%
  summarise()

unique(angle_data_postures_per_dataset$posture_grouped)
unique(angle_data_postures_per_dataset$annotation)
```

#for each annotation and grouped posture a .txt file is saved with the list of "newID2"
```{r, include=FALSE}
all_annotations <- unique(cluster_centers_reduced$annotation)


for (a in all_annotations){
  postures <- angle_data_postures_per_dataset %>%
    filter(annotation %in% a) %>%
    group_by(newID2,posture_grouped) %>%
    summarise()
  
  pg <- unique(postures$posture_grouped)
  
  for (p in pg){
    postures %>%
      filter(posture_grouped == p) %>%
      write.table(., file.path(save_path, paste0(a, "_posture_conversion_",p,".txt")), row.names = FALSE)
    
  }
}

```



#plot overview seperately for each posture group (seperately for each annotation)
#the Id corresponds to the one in the heatmap (for that particular dataset)
```{r, include=FALSE}


for (a in unique(angle_data_postures_per_dataset$annotation)){
  for (i in seq(1,how_many_clusters)){
  data_to_plot <- cluster_centers_reduced_grouped %>%
      #append newID2, so that postures in the overview have the same ID as in heatmap
      left_join(conversion_newID_and_newID2, by=c("newID","annotation")) %>%
      filter(posture_grouped == paste0("group_",i)) %>%
      filter(annotation ==a)
  number_of_IDs <- length(unique(data_to_plot$newID))
  plot_posture_examples(data_to_plot, "X","Y") +
    geom_point(data=filter(data_to_plot,index == 2), aes(X,Y),color="orange",size=7,shape=17) +
    facet_wrap(vars(posture_grouped,newID2,annotation),ncol=sqrt(number_of_IDs)) +
    theme(strip.text.x = element_text(size = 20,face="bold"))+
    ggsave(file.path(save_path,paste0(a,"_group_",i,"_k_",how_many_clusters,".png")),height=sqrt(number_of_IDs)*4,width=sqrt(number_of_IDs)*4,limitsize=FALSE)
  }
}

```

#calculate relative occurence of posture groups
```{r, include=FALSE}

postures_grouped_statistics <- angle_data_postures_per_dataset %>%
  group_by(annotation,dataset_ID, hours_rounded,posture_grouped,postures_per_tp_per_dataset) %>%
  #Count members of one posture group (adding all number of cluster members per hours_rounded per dataset within this group)
  summarise(number_of_posture_members_per_tp_per_dataset = sum(number_of_cluster_members_per_tp_per_dataset)) %>%
  #do this seperately for each dataset, timepoint (== tp == hours_rounded) and posture group
  group_by(dataset_ID, hours_rounded,posture_grouped) %>%
  #Normalize this with the numbers of postures per tp per dataset
  mutate(perc_per_posture_grouped_per_dataset = number_of_posture_members_per_tp_per_dataset/postures_per_tp_per_dataset) %>%
  #also seperately for each annotation, timepoint (== tp == hours_rounded) and posture group
  group_by(annotation, hours_rounded,posture_grouped) %>%
  mutate(number_of_posture_members_per_tp_per_annotation = sum(number_of_posture_members_per_tp_per_dataset)) %>%
  mutate(postures_per_tp_per_annotation=sum(postures_per_tp_per_dataset)) %>%
  mutate(perc_per_posture_grouped_per_annotation = number_of_posture_members_per_tp_per_annotation/postures_per_tp_per_annotation) %>%
  select(dataset_ID,
         number_of_posture_members_per_tp_per_dataset,
         postures_per_tp_per_dataset,
         perc_per_posture_grouped_per_dataset,
         number_of_posture_members_per_tp_per_annotation,
         postures_per_tp_per_annotation,
         perc_per_posture_grouped_per_annotation) %>%
  arrange(hours_rounded) %>%
  #the rest is done across time (z-score calculation) per dataset
  group_by(dataset_ID, posture_grouped) %>%
  mutate(sd_perc_per_posture_grouped_per_dataset = sd(perc_per_posture_grouped_per_dataset)) %>%
  mutate(mean_perc_per_posture_grouped_per_dataset = mean(perc_per_posture_grouped_per_dataset)) %>%
  mutate(perc_norm_per_posture_grouped_per_dataset =  (perc_per_posture_grouped_per_dataset-mean_perc_per_posture_grouped_per_dataset)/sd_perc_per_posture_grouped_per_dataset) %>%
  #the rest is done across time (z-score calculation) per annotation
  group_by(annotation, posture_grouped) %>%
  mutate(sd_perc_per_posture_grouped_per_annotation = sd(perc_per_posture_grouped_per_annotation)) %>%
  mutate(mean_perc_per_posture_grouped_per_annotation = mean(perc_per_posture_grouped_per_annotation)) %>%
  mutate(perc_norm_per_posture_grouped_per_annotation =  (perc_per_posture_grouped_per_annotation-mean_perc_per_posture_grouped_per_annotation)/sd_perc_per_posture_grouped_per_annotation) %>%
  group_by(annotation, dataset_ID, hours_rounded, posture_grouped,
           perc_per_posture_grouped_per_dataset,
           perc_per_posture_grouped_per_annotation,
           sd_perc_per_posture_grouped_per_dataset,
           mean_perc_per_posture_grouped_per_dataset,
           perc_norm_per_posture_grouped_per_dataset,
           sd_perc_per_posture_grouped_per_annotation,
           mean_perc_per_posture_grouped_per_annotation,
           perc_norm_per_posture_grouped_per_annotation) %>%
  summarise()
  

unique(postures_grouped_statistics$annotation)
# unique(postures_grouped_statistics$posture_grouped)
```

#plotting relative occurence of (sub-)posture groups
```{r, include=FALSE}
library(wesanderson)
#create specific folder location that will be used to save the heatmaps
save_path <- file.path(base_path,"plots","posture","posture_groups")
dir.create(save_path, recursive = TRUE)

selected_annotations <- c("Agar","OP50_with_Az_NGM","OP50","daf2")
pal <- wes_palette("Darjeeling1")[c(1,2,5,3)]
data_for_plotting <- postures_grouped_statistics %>%
  filter(annotation %in% selected_annotations) %>%
  mutate(annotation=factor(annotation, levels=selected_annotations))

ggplot(data_for_plotting, aes(y=perc_norm_per_posture_grouped_per_dataset,x=hours_rounded,color=annotation))+
  geom_point(alpha=0.5)+
  # geom_point(data=data_for_plotting, aes(y=perc_norm_per_posture_grouped_per_annotation, x=hours_rounded),color="black",fill="black",shape=21,alpha=0.75)+
  geom_line(data=data_for_plotting, aes(y=perc_norm_per_posture_grouped_per_annotation, x=hours_rounded),color="black")+
  scale_y_continuous(limits = c(-3,3))+
  scale_x_continuous(breaks = seq(1,12))+
  # geom_smooth()+
  theme_bw()+
  theme(
  strip.background = element_rect(fill="white"))+
  facet_wrap(vars(posture_grouped,annotation),nrow=how_many_clusters,scales="free")+
  scale_fill_manual(values = pal)+
  scale_color_manual(values = pal)+
  ggsave(file.path(save_path,"posture_groups_relative_occurences_norm.png"),height=4,width=8)

ggplot(data_for_plotting, aes(y=perc_per_posture_grouped_per_dataset,x=hours_rounded,color=annotation))+
  geom_point(alpha=0.5)+
  geom_line(data=data_for_plotting, aes(y=perc_per_posture_grouped_per_annotation, x=hours_rounded),color="black")+
  scale_y_continuous(limits = c(0,1))+
  scale_x_continuous(breaks = seq(1,12))+
  theme_bw()+
  theme(
  strip.background = element_rect(fill="white"))+
  facet_wrap(vars(posture_grouped,annotation),nrow=how_many_clusters,scales="free")+
  scale_fill_manual(values = pal)+
  scale_color_manual(values = pal)+
  ggsave(file.path(save_path,"posture_groups_relative_occurences.png"),height=4,width=8)


```

#plotting first derivatives of relative occurence of (sub-)posture groups
#only for z-score normalized data
```{r, include=FALSE}
selected_annotations <- c("Agar","OP50_with_Az_NGM","OP50")


data_for_plotting <- postures_grouped_statistics %>%
  filter(annotation %in% selected_annotations) %>%
  mutate(annotation=factor(annotation, levels=selected_annotations)) %>%
  group_by(dataset_ID,posture_grouped) %>%
  mutate(first_d = perc_norm_per_posture_grouped_per_annotation - lag(perc_norm_per_posture_grouped_per_annotation)) %>%
  select(dataset_ID, annotation,hours_rounded,posture_grouped,first_d) %>%
  ungroup() %>%
  filter(posture_grouped == 1)


ggplot(data_for_plotting, aes(y=first_d,x=hours_rounded,color=annotation,fill=annotation))+
  # geom_line(color="black")+
  geom_smooth()+
  scale_x_continuous(breaks = seq(1,12))+
  theme_bw()+
  theme(
  strip.background = element_rect(fill="white"))+
  facet_wrap(vars(posture_grouped,annotation),nrow=1,scales="free_x")+
  scale_fill_manual(values = pal)+
  scale_color_manual(values = pal)+
  ggsave(file.path(save_path,"firstd_posture_groups_relative_occurences_norm.png"),height=3,width=9)

```

#plotting average curvature per posture groups
```{r, include=FALSE}
#
ggplot(cluster_centers_reduced_grouped, aes(x=angle,fill=posture_grouped))+
  geom_density(alpha=0.5,lwd=1)+
  scale_x_continuous(limits=c(-1,1))+
  theme_classic()+
  scale_fill_manual(values=c("#EC008C", "#00A651"))+
  ggsave(file.path(save_path, "postures_grouped_angle_density.png"),height=3,width=6)



```

#plotting average posture
```{r, include=FALSE}
#select one dataset (i.e. OP50)
s <- cluster_centers_reduced_grouped %>%
  filter(annotation == "OP50") %>%
  group_by(index,annotation, posture_grouped) %>%
  #shift all postures of "group_2 to the left
  mutate(X=ifelse(posture_grouped == "group_2",-X-0.25,X)) %>%
  #manually select 2 posture to be highlighted
  mutate(highlight=ifelse(newID %in% c(82,25),"YES","NO"))

#do the plot
ggplot(s)+
  geom_path(data=s,aes(X,Y,group=newID),color="grey",alpha=0.8)+
  geom_path(data=filter(s,highlight=="YES"),aes(X,Y,group=newID,color=angle))+
  geom_point(data=filter(s,highlight=="YES"),aes(X,Y,group=newID,fill=angle,color=angle))+
  geom_point(data=filter(s,highlight=="YES" & index==2), aes(X,Y),color="orange",size=3,shape=17) +
  scale_color_gradient2(low = "deepskyblue", mid = "lavender",
                        high = "deeppink",midpoint=0,limits=c(-1,1),na.value="grey") +
  scale_fill_gradient2(low = "deepskyblue", mid = "lavender",
                        high = "deeppink",midpoint=0,limits=c(-1,1),na.value="grey") +
  # theme_classic()+
  theme_void()+
  facet_wrap(vars(annotation))+
  coord_fixed(ratio = 1)+
  ggsave(file.path(save_path, "postures_grouped_overlay_OP50.png"),height=3,width=6)



```
