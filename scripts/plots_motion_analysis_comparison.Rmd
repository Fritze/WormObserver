
  
#Define locations and datasets to include
```{r, echo=FALSE}
#bins or tracks?
average <- "bins"
  
base_path <- "/media/fpreuss/raid5/timelapses/analysis/200703"
```

```{r, echo=FALSE}

target_path <- file.path(base_path,"data","motion")
save_path <- file.path(base_path,"plots")
dir.create(save_path)
save_path <- file.path(save_path, average,"comparisons")
dir.create(save_path)

#list of centroid tracking .rds files in data folder
files_to_process <- list.files(target_path, paste0("centroid_tracking_",average,".rds"),full.names = TRUE, ignore.case = TRUE)
  
order  <- c("N2 1:5 OP50",
            "N2 1:10 OP50",
            "N2 1:7 OP50",
            "N2 no food",
            "N2 1:10 OP50 after 6h exit",
            "N2 empty after 6h exit",
            "daf2",
            "Agar",
            "Agar with NAD",
            "N2 RT no food",
            "MT13984"
            )
  
imported_data <- map_dfr(files_to_process,readRDS) %>%
    mutate(hours = minutes / 60) %>%
    #round per half an hour
    # mutate(hours_rounded= floor(hours * 2) / 2) %>%
    #round per hour
    mutate(hours_rounded = ceiling(hours)) %>%
    #filter out first 30 mins
    filter(hours > 0.5) %>%
    #take out conditions
    filter(!annotation %in% c("L2","L3","N2 empty after 6h exit")) %>%
    na.omit() %>%
    #custom order of conditions
    left_join(tibble(annotation=order),by="annotation")
  
#levels must be changed for ggplot to take new order into account
imported_data$annotation = factor(imported_data$annotation, levels=order)

unique(imported_data$annotation)

```
  
  
```{r, echo=TRUE}
  
#Until how many hours
show_until <- 12

#define colors
library(wesanderson)
pal <- wes_palette("Darjeeling1",5)[c(3,5)]

library(pals)
  
data <- imported_data %>%
  filter(hours_rounded <= show_until) %>%
  group_by(annotation, hours_rounded) %>%
  #count tracks per hour per condition
  mutate(number_of_tracks_in_this_hour = n_distinct(dataset_ID,tp,TrackID)) %>%
  # scale velocity to mm/s
  mutate(p_mean_velocity = p_mean_velocity / 1000) %>%
  arrange(hours_rounded)


  
data_binarized <- imported_data %>%
  mutate(ratio = p_mean_velocity/p_mean_angle) %>%
  #calculate ratio, this will give result in a diagonal (see binarized_not_log plot)
  mutate(behavioral_state=ifelse(ratio > 1, "roaming","dwelling")) %>%
  # scale velocity to mm/s
  mutate(p_mean_velocity = p_mean_velocity / 1000) %>%
  filter(hours_rounded <= show_until) %>%
  group_by(annotation, hours_rounded) %>%
  #count tracks per hour per condition
  mutate(number_of_tracks_in_this_hour = n_distinct(dataset_ID,tp,TrackID)) %>%
  arrange(hours_rounded) 

data_binarized_summarized <- data_binarized %>%
  group_by(annotation,hours_rounded) %>%
  mutate(n_total = n()) %>%
  group_by(annotation, hours_rounded,behavioral_state) %>%
  mutate(n=n()) %>%
  mutate(perc=n/n_total) %>%
  group_by(annotation, hours_rounded,behavioral_state,perc) %>%
  summarise()

data_summarised <- data_binarized %>%
  #counts per behavioral state
  group_by(annotation,hours_rounded,tp,behavioral_state,dataset_ID) %>%
  summarise(counts=n()) %>%
  #total counts
  group_by(annotation,hours_rounded,tp,dataset_ID) %>%
  mutate(sum=sum(counts)) %>%
  #relative occurence of behavioral_state
  mutate(perc = counts/sum) %>%
  mutate(hours_rounded =as.character(hours_rounded))

```


#plot relative occurence of dwelling AND roaming for all timepoints for all conditions
```{r, echo=TRUE}

ggplot(data_summarised,aes(x=factor(hours_rounded, levels=as.character(c(1:show_until))),y=perc,fill=behavioral_state))+
      geom_boxplot(lwd=1.75)+
      scale_fill_manual(values =pal)+
      scale_y_continuous(limits=c(0,1))+
      geom_point(position=position_dodge(width=0.75),aes(group=behavioral_state),color="black",alpha=0.5,size=2)+
      xlab("hours") + ylab("Relative occurence of \nbehavioral state")+
      facet_wrap(annotation ~ .)+
      theme_classic()+
      theme(
        legend.direction="horizontal",
        legend.position = "top",
        strip.background = element_rect(colour = "white", fill = "white"),
        panel.spacing = unit(1, "lines"),
        strip.text.x = element_text(size=15,colour = "black", face = "bold"),
        axis.text.x = element_text(size=30),
        axis.title.x = element_text(size=45),
        axis.text.y = element_text(size=30),
        axis.title.y = element_text(size=45),
        legend.key.size = unit(2.5, "cm"))+
      facet_wrap(vars(annotation),scales="free_x")+
      ggsave(file.path(save_path,paste0("box_roaming_dwelling_relative",".png")),height=20,width=40)
  
```


#plot relative occurence of roaming for specific timepoints and conditions
```{r, echo=TRUE}


selected_hours <- c(3,6,9,12)

selected_annotations <- c("Agar", "Agar with NAD","N2 1:10 OP50")

data_summarised_sub <- data_summarised %>%
  filter(annotation %in% selected_annotations) %>%
  filter(hours_rounded %in% selected_hours) %>%
  filter(behavioral_state == "roaming")

data_summarised_sub$annotation <- factor(data_summarised_sub$annotation, levels=unique(data_summarised_sub$annotation))


ggplot(data_summarised_sub,aes(x=factor(hours_rounded,levels = c(hours)),y=perc,fill=annotation))+
      geom_boxplot(aes(fill=annotation),lwd=1.2)+
      geom_point(aes(fill=annotation),position = position_jitterdodge(),shape=21,size=2.5,alpha=0.5)+
      xlab("hours") + ylab("fraction roaming")+
      scale_y_continuous(limits=c(0,1))+
      scale_fill_manual(values=wes_palette(n=4, name="Moonrise3"))+
      theme_classic()+
      theme(
        legend.direction="horizontal",
        legend.position = "top",
        strip.background = element_rect(colour = "white", fill = "white"),
        panel.spacing = unit(1, "lines"),
        strip.text.x = element_text(size=15,colour = "black", face = "bold"),
        axis.text.x = element_text(size=30),
        axis.title.x = element_text(size=20),
        axis.text.y = element_text(size=30),
        axis.title.y = element_text(size=20),
        axis.ticks=element_line(size=1.5),
        axis.ticks.length=unit(0.25,"cm"),
        axis.line = element_line(colour = 'black', size = 1.5),
        legend.key.size = unit(2.5, "cm"))+
      ggsave(file.path(save_path,paste0("box_roaming_dwelling_relative_sub_compare_",paste(selected_annotations, collapse="_"),".png")),height=5,width=10)


selected_annotations <- c("Agar", "N2 1:10 OP50")

data_summarised_sub <- data_summarised %>%
  filter(annotation %in% selected_annotations) %>%
  filter(hours_rounded %in% selected_hours) %>%
  filter(behavioral_state == "roaming")

data_summarised_sub$annotation <- factor(data_summarised_sub$annotation, levels=unique(data_summarised_sub$annotation))


ggplot(data_summarised_sub,aes(x=factor(hours_rounded,levels = c(hours)),y=perc,fill=annotation))+
      geom_boxplot(aes(fill=annotation),lwd=1.2)+
      geom_point(aes(fill=annotation),position = position_jitterdodge(),shape=21,size=2.5,alpha=0.5)+
      xlab("hours") + ylab("fraction roaming")+
      scale_y_continuous(limits=c(0,1))+
      scale_fill_manual(values=wes_palette(n=4, name="Moonrise3"))+
      theme_classic()+
      theme(
        legend.direction="horizontal",
        legend.position = "top",
        strip.background = element_rect(colour = "white", fill = "white"),
        panel.spacing = unit(1, "lines"),
        strip.text.x = element_text(size=15,colour = "black", face = "bold"),
        axis.text.x = element_text(size=30),
        axis.title.x = element_text(size=20),
        axis.text.y = element_text(size=30),
        axis.title.y = element_text(size=20),
        axis.ticks=element_line(size=1.5),
        axis.ticks.length=unit(0.25,"cm"),
        axis.line = element_line(colour = 'black', size = 1.5),
        legend.key.size = unit(2.5, "cm"))+
      ggsave(file.path(save_path,paste0("box_roaming_dwelling_relative_sub_compare_",paste(selected_annotations, collapse="_"),".png")),height=5,width=10)
```

#function for plotting histograms
```{r, echo=TRUE}
plot_histograms <- function(data,X,xlab){
  ggplot(data,aes_string(x=X,fill="annotation"))+
    geom_histogram(lwd=1.2)+
    xlab(xlab)+
    theme_classic()+
    scale_fill_manual(values=pal)+
    facet_wrap(vars(annotation,hours_rounded),ncol=4,scales="free")+
      theme(
        legend.direction="horizontal",
        legend.position = "top",
        strip.background = element_rect(colour = "white", fill = "white"),
        panel.spacing = unit(1, "lines"),
        strip.text.x = element_text(size=15,colour = "black", face = "bold"),
        axis.text.x = element_text(size=20),
        axis.title.x = element_text(size=20),
        axis.text.y = element_text(size=20),
        axis.title.y = element_text(size=20),
        axis.ticks=element_line(size=1.5),
        axis.ticks.length=unit(0.25,"cm"),
        axis.line = element_line(colour = 'black', size = 1.5))+
      ggsave(file.path(save_path,paste0(X,"_",paste(selected_annotations, collapse="_"),"_histograms.png")),height=8,width=20)
  
  
}
```

#function for plotting violin plots
```{r, echo=TRUE}
plot_violins <- function(data,Y,xlab){
  ggplot(data,aes_string(x="annotation",y=Y,fill="annotation"))+
    # geom_violin(lwd=1.2)+
    geom_boxplot(width=0.1, lwd=1.5,color="black")+
    xlab(xlab)+
    theme_classic()+
    scale_fill_manual(values=pal)+
    facet_wrap(vars(hours_rounded),ncol=4,scales="fixed")+
      theme(
        legend.direction="horizontal",
        legend.position = "top",
        strip.background = element_rect(colour = "white", fill = "white"),
        panel.spacing = unit(1, "lines"),
        strip.text.x = element_text(size=15,colour = "black", face = "bold"),
        axis.text.x = element_text(size=20),
        axis.title.x = element_text(size=20),
        axis.text.y = element_text(size=20),
        axis.title.y = element_text(size=20),
        axis.ticks=element_line(size=1.5),
        axis.ticks.length=unit(0.25,"cm"),
        axis.line = element_line(colour = 'black', size = 1.5))+
      ggsave(file.path(save_path,paste0(Y,"_",paste(selected_annotations, collapse="_"),"_violins.png")),height=5,width=10)
  
  
}
```

 
#plot velocity histograms for specific timepoints and conditions
```{r, echo=TRUE}

selected_hours <- c(12)

selected_annotations <- c("N2 1:10 OP50", "MT13984")

data_binarized %>%
  filter(annotation %in% selected_annotations) %>%
  filter(hours_rounded %in% selected_hours) %>%
  plot_histograms(., "p_mean_velocity", "velocity (mm/s)")

data_binarized %>%
  filter(annotation %in% selected_annotations) %>%
  filter(hours_rounded %in% selected_hours) %>%
  plot_violins(., "p_mean_velocity", "velocity (mm/s)")
  
```


#plot angular velocity histograms for specific timepoints and conditions
```{r, echo=TRUE}
pal <- wes_palette("Darjeeling1",5)[c(1,3,5)]

selected_hours <- c(3,6,9,12)

selected_annotations <- c("Agar","N2 1:10 OP50", "MT13984")

data_binarized %>%
  filter(annotation %in% selected_annotations) %>%
  filter(hours_rounded %in% selected_hours) %>%
  plot_histograms(., "p_mean_angle", "angular velocity (°/s)")

data_binarized %>%
  filter(annotation %in% selected_annotations) %>%
  filter(hours_rounded %in% selected_hours) %>%
  plot_violins(., "p_mean_angle", "velocity (mm/s)")


```