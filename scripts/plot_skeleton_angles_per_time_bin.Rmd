
#
# Run the filter_skeletons.Rmd before to get "skeleton_data_filtered"
#
#open questions: Some (ca. 10%?) have very high angles > 1, what is going on there?


#Bin data in time bins (per hour) & sample equal number from each bin
```{r, include=FALSE}

sample_number <- 15000

dataset_name <- unique(skeleton_data_filtered$dataset_ID)

bin_data_sampled <- skeleton_data_filtered %>%
  mutate(time = ifelse(hours_rounded < 1,"1h",NA)) %>%
  mutate(time = ifelse(hours_rounded >= 1 & hours_rounded < 2,"2h",time)) %>%
  mutate(time = ifelse(hours_rounded >= 2 & hours < 3,"3h",time)) %>%
  mutate(time = ifelse(hours_rounded >= 3 & hours_rounded < 4,"4h",time)) %>%
  mutate(time = ifelse(hours_rounded >= 4 & hours_rounded < 5,"5h",time)) %>%
  mutate(time = ifelse(hours_rounded >= 5 & hours_rounded < 6,"6h",time)) %>%
  mutate(time = ifelse(hours_rounded >= 6 & hours_rounded <= 7 ,"7h",time)) %>%
  group_by(ID,time) %>%
  nest() %>%
  # drop_na("time") %>%
  group_by(time) %>%
  sample_n(sample_number) %>%
  arrange(desc(ID)) %>%
  mutate(ID_number= 1:n()) %>%
  unnest(cols=c(data))



bin_data_sampled %>%
   group_by(time) %>%
   summarise(n = n_distinct(dataset_TrackID))
```




#Plot distribution for each angle in each time bin
```{r, include=FALSE}

ggplot(bin_data_sampled, aes(x=angle,y=index),group=time)+
   stat_density_2d(aes(fill = ..ndensity..),contour=FALSE,geom="raster")+
   scale_color_gradient2(low = "cornflowerblue", mid = "white",
                         high = "brown2",midpoint=0,limits=c(-1,1),na.value="grey") +
   facet_grid(~time)+
   scale_x_continuous(limits=c(-1,1),labels=c(-1,-0.5,0,0.5,1))+
   scale_y_continuous(trans = "reverse")+
   scale_fill_viridis(limits=c(0.01,1),na.value="black")+
   theme_black()+
   theme(legend.position = "top")

ggsave(file.path(save_path,paste0("L2_averaged_all_angles",sample_number,"postures",".png")),width=12,height=9)

```


```{r, include=FALSE}

bin_data_sampled_head <- bin_data_sampled %>%
   filter(index %in% c(1,2,3,4,5)) %>%
   drop_na("angle")
```


```{r, include=FALSE}

ggplot(bin_data_sampled_head, aes(x=time, y=angle,group=time))+
   geom_bin2d()+
   scale_y_continuous(limits=c(-1,1))+
   scale_fill_distiller(palette = "Spectral")+
   theme_black()+
   theme(legend.position = "top")

ggsave(file.path(save_path,paste0("L2_head_averaged_over_all_angles_",sample_number,"postures",".png")),width=12,height=9)


```  

```{r, include=FALSE}
ggplot(bin_data_sampled_head, aes(x=angle,y=index),group=time )+
   stat_density_2d(aes(fill = ..ndensity..), geom = "raster", contour = FALSE) +
   scale_color_gradient2(low = "cornflowerblue", mid = "white",
                         high = "brown2",midpoint=0,limits=c(-1,1),na.value="grey") +
   facet_grid(~time)+
   scale_x_continuous(limits=c(-1,1),labels=c(-1,-0.5,0,0.5,1))+
   scale_y_continuous(trans = "reverse",limits=c(5.5,1.5))+
   scale_fill_viridis(limits=c(0.01,1),na.value="black")+
   theme_black()+
   theme(legend.position = "top")

ggsave(file.path(save_path,paste0("L2_head_averaged_angles_downsampled_",sample_number,"postures",".png")),width=12,height=9)
```  



#Plot distribution for each angle in each time bin
```{r, include=FALSE}
ggplot(bin_data_sampled,aes(x=time,y=angle,group=time,fill=time))+
  # geom_boxplot()+
  geom_violin()+
  # geom_boxplot()+
  coord_flip()+
  scale_y_continuous(limits=c(-1,1))+
  theme_black()+
  theme(legend.position = "top")
```

#Compare distributions with Kolmogorov-Smirnov test
```{r, include=FALSE}

one_hour <- filter(bin_data_sampled,time == "<1h") %>% select(angle) %>% pull() %>% na.omit()
two_hours <- filter(bin_data_sampled,time == "<2h") %>% select(angle) %>% pull() %>% na.omit()
three_hours <- filter(bin_data_sampled,time == "<3h") %>% select(angle) %>% pull() %>% na.omit()
four_hours <- filter(bin_data_sampled,time == "<4h") %>% select(angle) %>% pull() %>% na.omit()
five_hours <- filter(bin_data_sampled,time == "<5h") %>% select(angle) %>% pull() %>% na.omit()

shuffled_1 <- sample(bin_data_sampled$angle,120000)
shuffled_2 <- sample(bin_data_sampled$angle,120000)

ks.test(shuffled_1,shuffled_2)
ks.test(three_hours,five_hours)

```


#Plot averaged angles for each bin, adding one more posture each image
```{r, include=FALSE}

for(i in seq(1:1000)){
   
   to_plot <- bin_data_sampled %>%
    filter(ID_number %in% 1:i)
 
   ggplot(to_plot, aes(x=angle,y=index),group=time )+
      # geom_bin2d()+
      # geom_hex()+
      stat_density_2d(aes(fill = ..ndensity..),contour=FALSE,geom="raster")+
      # stat_density_2d(aes(fill = stat(nlevel)),contour=FALSE)+
      geom_point(data=bin_data_sampled %>% filter(ID_number == i ),aes(x=angle,y=index,color=angle), alpha=0.75,size=1.5)+
      # geom_path(data=bin_data_sampled %>% filter(ID_number == i ),aes(x=angle,y=index,color=angle), size=1)+
      scale_color_gradient2(low = "cornflowerblue", mid = "white",
                            high = "brown2",midpoint=0,limits=c(-1,1),na.value="grey") +
      facet_grid(~time)+
      scale_x_continuous(limits=c(-1,1),labels=c(-1,-0.5,0,0.5,1))+
      scale_y_continuous(trans = "reverse")+
      scale_fill_viridis(limits=c(0.01,1),na.value="black")+
      # scale_fill_distiller(palette = "Spectral",limits=c(0.1,1),na.value="black")+
      theme_black()+
      theme(legend.position = "top")+
      ggtitle(dataset_name)
       
   ggsave(file.path(save_path,paste0("withfoods_averaged_angles_examples_",i,".png")),width=12,height=9)
}
```



```{r, include=FALSE}


for(i in seq(1:1000)){
   
   to_plot <- bin_data_sampled_head %>%
    filter(ID_number %in% 1:i)

   ggplot(to_plot, aes(x=angle,y=index),group=time )+
      # geom_bin2d()+
      # geom_hex()+
      # stat_density_2d(aes(fill = ..density..), geom = "polygon")+
      stat_density_2d(aes(fill = ..ndensity..), geom = "raster", contour = FALSE) +
      # stat_density_2d(aes(fill = stat(nlevel)), geom = "polygon",n=200)+
      geom_point(data=bin_data_sampled_head %>% filter(ID_number == i ),aes(x=angle,y=index,color=angle), alpha=0.75,size=2)+
      # geom_path(data=bin_data_sampled_head %>% filter(ID_number == i ),aes(x=angle,y=index,color=angle), alpha=0.75,size=1)+
      scale_color_gradient2(low = "cornflowerblue", mid = "white",
                            high = "brown2",midpoint=0,limits=c(-1,1),na.value="grey") +
      facet_grid(~time)+
      scale_x_continuous(limits=c(-1,1),labels=c(-1,-0.5,0,0.5,1))+
      scale_y_continuous(trans = "reverse",limits=c(5.5,1.5))+
      scale_fill_viridis(limits=c(0.01,1),na.value="black")+
      theme_black()+
      theme(legend.position = "top")+
      ggtitle(dataset_name)
   ggsave(file.path(base_location,"plots",paste0("head_averaged_angles_examples_",i,".png")),width=12,height=9)

}
# ggsave(file.path(base_location,"plots",paste0(dataset_name,"head_averaged_angles_downsampled_",sample_number,"postures",".png")),width=12,height=9)
```   
