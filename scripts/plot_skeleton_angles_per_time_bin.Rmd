
#
# Run the filter_skeletons.Rmd before to get "skeleton_data_filtered"
#
#open questions: Some (ca. 10%?) have very high angles > 1, what is going on there?


#Bin data in time bins (per hour) & sample equal number from each bin
```{r, include=FALSE}

sample_number <- 15000

dataset_name <- unique(skeleton_data_filtered$dataset_ID)

bin_data_sampled <- skeleton_data_filtered %>%
  mutate(time = ifelse(hours_rounded < 1,"1h",NA)) %>%
  mutate(time = ifelse(hours_rounded >= 1 & hours_rounded < 2,"2h",time)) %>%
  mutate(time = ifelse(hours_rounded >= 2 & hours < 3,"3h",time)) %>%
  mutate(time = ifelse(hours_rounded >= 3 & hours_rounded < 4,"4h",time)) %>%
  mutate(time = ifelse(hours_rounded >= 4 & hours_rounded < 5,"5h",time)) %>%
  mutate(time = ifelse(hours_rounded >= 5 & hours_rounded < 6,"6h",time)) %>%
  mutate(time = ifelse(hours_rounded >= 6 & hours_rounded <= 7 ,"7h",time)) %>%
  group_by(ID,time) %>%
  nest() %>%
  # drop_na("time") %>%
  group_by(time) %>%
  sample_n(sample_number) %>%
  arrange(desc(ID)) %>%
  mutate(ID_number= 1:n()) %>%
  unnest(cols=c(data))



bin_data_sampled %>%
   group_by(time) %>%
   summarise(n = n_distinct(dataset_TrackID))
```




#Plot distribution for each angle in each time bin
```{r, include=FALSE}

ggplot(bin_data_sampled, aes(x=angle,y=index),group=time)+
   stat_density_2d(aes(fill = ..ndensity..),contour=FALSE,geom="raster")+
   scale_color_gradient2(low = "cornflowerblue", mid = "white",
                         high = "brown2",midpoint=0,limits=c(-1,1),na.value="grey") +
   facet_grid(~time)+
   scale_x_continuous(limits=c(-1,1),labels=c(-1,-0.5,0,0.5,1))+
   scale_y_continuous(trans = "reverse")+
   scale_fill_viridis(limits=c(0.01,1),na.value="black")+
   theme_black()+
   theme(legend.position = "top")

ggsave(file.path(save_path,paste0("L2_averaged_all_angles",sample_number,"postures",".png")),width=12,height=9)

```


```{r, include=FALSE}

bin_data_sampled_head <- bin_data_sampled %>%
   filter(index %in% c(1,2,3,4,5)) %>%
   drop_na("angle")
```


```{r, include=FALSE}

head_angles_1 <- readRDS(file="/Users/fpreuss/Desktop/behavior/daf2_head_sampled.rds") %>%
   mutate(annotation = "daf2")
head_angles_2 <- readRDS(file="/Users/fpreuss/Desktop/behavior/nofood_head_sampled.rds") %>%
   mutate(annotation = "no food")
head_angles_3 <- readRDS(file="/Users/fpreuss/Desktop/behavior/withfood_head_sampled.rds") %>%
   mutate(annotation = "with food")

bin_data_sampled_head <- rbind(
   head_angles_1,
   head_angles_2,
   head_angles_3
)

bin_data_sampled_head %>%
   group_by(hours_rounded,annotation) %>%
   summarise(number_of_tracks=n_distinct(dataset_TrackID)) %>%
   group_by(annotation) %>%
   mutate(mean_number_of_tracks=mean(number_of_tracks))


```

```{r, include=FALSE}

bin_data_sampled_head_abs <- bin_data_sampled_head %>%
   mutate(angle = abs(angle)) %>%
   filter(index %in% c(2,3))

# ggplot(bin_data_sampled_head_abs, aes(x=time, y=angle,group=time))+
#    geom_bin2d(aes(fill = ..ndensity..))+
#    scale_y_continuous(limits=c(0,1))+
#    scale_fill_viridis(option = "inferno")+
#    facet_wrap(~annotation)+
#    theme_black()+
#    theme(legend.position = "top")

ggplot(bin_data_sampled_head_abs, aes(x=time, y=angle,group=time))+
   geom_bin2d()+
   scale_y_continuous(limits=c(0,1))+
   scale_fill_distiller(palette= "Spectral") +
   facet_wrap(~annotation)+
   theme_black()+
   theme(legend.position = "top")


ggplot(filter(bin_data_sampled_head_abs,annotation=="with food"), aes(x=time, y=angle,group=time))+
   geom_bin2d()+
   scale_y_continuous(limits=c(0,1))+
   scale_fill_distiller(palette= "Spectral") +
   facet_wrap(~annotation)+
   theme_black()+
   theme(legend.position = "top")

# ggplot(bin_data_sampled_head_abs, aes(angle,color=time))+
#    geom_density()+
#    scale_x_continuous(limits=c(0,1))+
#    facet_wrap(~annotation)
# 
# d <- bin_data_sampled_head_abs %>%
#    group_by(annotation,time) %>%
#    summarise(sum01= sum(angle<=0.1)/n_distinct(ID)*2,
#              sum02= sum(angle<=0.2)/n_distinct(ID)*2,
#              sum03= sum(angle<=0.3)/n_distinct(ID)*2,
#              sum04= sum(angle<=0.4)/n_distinct(ID)*2,
#              sum05= sum(angle<=0.5)/n_distinct(ID)*2) %>%
#     gather(condition, measurement, sum01:sum05, factor_key=TRUE)
#    
   
# ggplot(d,aes(x=time,y=measurement,fill=condition))+
#    geom_boxplot()


ggsave(file.path("/Users/fpreuss/Desktop/behavior/",paste0("head_averaged_over_all_angles_",sample_number,"postures",".png")),width=15,height=10)


```  

```{r, include=FALSE}

filtered <- bin_data_sampled_head %>%
   mutate(angle_rounded = round(angle,1)) %>%
   filter(angle_rounded < 0.5 & angle_rounded > -0.5) %>%
   group_by(index,time,angle_rounded,annotation) %>%
   summarise(number = n_distinct(ID)) %>%
   filter(index < 4)

ggplot(filtered, aes(x=angle_rounded, y=number,fill=as.character(index)))+
   geom_bar(stat="identity")+
   coord_polar()+
   scale_x_reverse()+
   facet_wrap(vars(annotation,time),nrow =3)+
   scale_fill_brewer(palette="Greens")+
   theme_void()+
   theme(legend.position = "top",
         panel.background = element_rect(fill ="black"))

# ggsave(file.path("/Users/fpreuss/Desktop/behavior/",paste0("head_averaged_over_all_angles_",sample_number,"postures",".png")),width=15,height=10)


```  

```{r, include=FALSE}

for(i in seq(1:1000)){
   
   to_plot <- bin_data_sampled_head %>%
    filter(ID_number %in% 1:i)

   ggplot(to_plot, aes(x=time, y=angle,group=time))+
      geom_bin2d(aes(fill = ..ndensity..))+
      scale_y_continuous(limits=c(-1,1))+
      scale_fill_viridis(option = "inferno")+
      facet_wrap(~annotation)+
      theme_black()+
      theme(legend.position = "top")

   ggsave(file.path("/Users/fpreuss/Desktop/behavior/",paste0("head_averaged_over_all_angles_",sample_number,"postures_",i,".png")),width=15,height=10)
   
}


```  



```{r, include=FALSE}
ggplot(bin_data_sampled_head, aes(x=angle,y=index),group=time )+
   stat_density_2d(aes(fill = ..ndensity..), geom = "raster", contour = FALSE) +
   scale_color_gradient2(low = "cornflowerblue", mid = "white",
                         high = "brown2",midpoint=0,limits=c(-1,1),na.value="grey") +
   facet_grid(~time)+
   scale_x_continuous(limits=c(-1,1),labels=c(-1,-0.5,0,0.5,1))+
   scale_y_continuous(trans = "reverse",limits=c(5.5,1.5))+
   scale_fill_viridis(limits=c(0.01,1),na.value="black")+
   theme_black()+
   theme(legend.position = "top")

ggsave(file.path(save_path,paste0("L2_head_averaged_angles_downsampled_",sample_number,"postures",".png")),width=12,height=9)
```  



#Plot distribution for each angle in each time bin
```{r, include=FALSE}
ggplot(bin_data_sampled,aes(x=time,y=angle,group=time,fill=time))+
  # geom_boxplot()+
  geom_violin()+
  # geom_boxplot()+
  coord_flip()+
  scale_y_continuous(limits=c(-1,1))+
  theme_black()+
  theme(legend.position = "top")
```

#Compare distributions with Kolmogorov-Smirnov test
```{r, include=FALSE}

one_hour <- filter(bin_data_sampled,time == "<1h") %>% select(angle) %>% pull() %>% na.omit()
two_hours <- filter(bin_data_sampled,time == "<2h") %>% select(angle) %>% pull() %>% na.omit()
three_hours <- filter(bin_data_sampled,time == "<3h") %>% select(angle) %>% pull() %>% na.omit()
four_hours <- filter(bin_data_sampled,time == "<4h") %>% select(angle) %>% pull() %>% na.omit()
five_hours <- filter(bin_data_sampled,time == "<5h") %>% select(angle) %>% pull() %>% na.omit()

shuffled_1 <- sample(bin_data_sampled$angle,120000)
shuffled_2 <- sample(bin_data_sampled$angle,120000)

ks.test(shuffled_1,shuffled_2)
ks.test(three_hours,five_hours)

```


#Plot averaged angles for each bin, adding one more posture each image
```{r, include=FALSE}

for(i in seq(1:1000)){
   
   to_plot <- bin_data_sampled %>%
    filter(ID_number %in% 1:i)
 
   ggplot(to_plot, aes(x=angle,y=index),group=time )+
      # geom_bin2d()+
      # geom_hex()+
      stat_density_2d(aes(fill = ..ndensity..),contour=FALSE,geom="raster")+
      # stat_density_2d(aes(fill = stat(nlevel)),contour=FALSE)+
      geom_point(data=bin_data_sampled %>% filter(ID_number == i ),aes(x=angle,y=index,color=angle), alpha=0.75,size=1.5)+
      # geom_path(data=bin_data_sampled %>% filter(ID_number == i ),aes(x=angle,y=index,color=angle), size=1)+
      scale_color_gradient2(low = "cornflowerblue", mid = "white",
                            high = "brown2",midpoint=0,limits=c(-1,1),na.value="grey") +
      facet_grid(~time)+
      scale_x_continuous(limits=c(-1,1),labels=c(-1,-0.5,0,0.5,1))+
      scale_y_continuous(trans = "reverse")+
      scale_fill_viridis(limits=c(0.01,1),na.value="black")+
      # scale_fill_distiller(palette = "Spectral",limits=c(0.1,1),na.value="black")+
      theme_black()+
      theme(legend.position = "top")+
      ggtitle(dataset_name)
       
   ggsave(file.path(save_path,paste0("withfoods_averaged_angles_examples_",i,".png")),width=12,height=9)
}
```



```{r, include=FALSE}


for(i in seq(1:1000)){
   
   to_plot <- bin_data_sampled_head %>%
    filter(ID_number %in% 1:i)

   ggplot(to_plot, aes(x=angle,y=index),group=time )+
      # geom_bin2d()+
      # geom_hex()+
      # stat_density_2d(aes(fill = ..density..), geom = "polygon")+
      stat_density_2d(aes(fill = ..ndensity..), geom = "raster", contour = FALSE) +
      # stat_density_2d(aes(fill = stat(nlevel)), geom = "polygon",n=200)+
      geom_point(data=bin_data_sampled_head %>% filter(ID_number == i ),aes(x=angle,y=index,color=angle), alpha=0.75,size=2)+
      # geom_path(data=bin_data_sampled_head %>% filter(ID_number == i ),aes(x=angle,y=index,color=angle), alpha=0.75,size=1)+
      scale_color_gradient2(low = "cornflowerblue", mid = "white",
                            high = "brown2",midpoint=0,limits=c(-1,1),na.value="grey") +
      facet_grid(~time)+
      scale_x_continuous(limits=c(-1,1),labels=c(-1,-0.5,0,0.5,1))+
      scale_y_continuous(trans = "reverse",limits=c(5.5,1.5))+
      scale_fill_viridis(limits=c(0.01,1),na.value="black")+
      theme_black()+
      theme(legend.position = "top")+
      ggtitle(dataset_name)
   ggsave(file.path(base_location,"plots",paste0("head_averaged_angles_examples_",i,".png")),width=12,height=9)

}
# ggsave(file.path(base_location,"plots",paste0(dataset_name,"head_averaged_angles_downsampled_",sample_number,"postures",".png")),width=12,height=9)
```   
