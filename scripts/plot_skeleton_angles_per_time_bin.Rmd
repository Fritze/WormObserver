
#
# Run the filter_skeletons.Rmd before to get "skeleton_data_filtered"
#
#open questions: Some (ca. 10%?) have very high angles > 1, what is going on there?


#Bin data in time bins (per hour) & sample equal number from each bin
```{r, include=FALSE}
save_path <- "/media/ella/raid5/timelapses/analysis/200305/posture"
sample_number <- 5000

dataset_name <- unique(skeleton_data_filtered$dataset_ID)

skeleton_data_filtered_named <- skeleton_data_filtered %>%
   mutate(experiment = ifelse(dataset_ID == "2019-03-25_18-10-06" | dataset_ID == "2019-11-18_18-43-57" | dataset_ID == "2019-11-20_17-29-55","empty",NA)) %>%
   mutate(experiment = ifelse(dataset_ID == "2019-03-26_19-27-16" | dataset_ID == "2019-03-27_18-24-47" | dataset_ID == "2019-11-25_17-28-23","1:10 OP50",experiment)) %>%
   mutate(experiment = ifelse(dataset_ID == "2019-04-23_17-46-08" | dataset_ID == "2019-05-07_12-15-40", "daf2", experiment)) %>%
   mutate(experiment = ifelse(dataset_ID == "2020-02-20_18-53-49","6h on food 1:10",experiment))
   



bin_data_sampled <- skeleton_data_filtered_named %>%
  mutate(time = ifelse(hours_rounded < 1,"1h",NA)) %>%
  mutate(time = ifelse(hours_rounded >= 1 & hours_rounded < 2,"2h",time)) %>%
  mutate(time = ifelse(hours_rounded >= 2 & hours_rounded < 3,"3h",time)) %>%
  mutate(time = ifelse(hours_rounded >= 3 & hours_rounded < 4,"4h",time)) %>%
  mutate(time = ifelse(hours_rounded >= 4 & hours_rounded < 5,"5h",time)) %>%
  mutate(time = ifelse(hours_rounded >= 5 & hours_rounded < 6,"6h",time)) %>%
  mutate(time = ifelse(hours_rounded >= 6 & hours_rounded <= 7 ,"7h",time)) %>%
  group_by(experiment,ID,time) %>%
  nest() %>%
  # drop_na("time") %>%
  group_by(time,experiment) %>%
  sample_n(sample_number) %>%
  arrange(desc(ID)) %>%
  mutate(ID_number= 1:n()) %>%
  unnest(cols=c(data))


bin_data_sampled %>%
   group_by(time,experiment) %>%
   summarise(n = n_distinct(ID))

bin_data_sampled %>%
   group_by(time,experiment) %>%
   summarise(n = n_distinct(dataset_TrackID))

bin_data_sampled %>%
   group_by(time) %>%
   summarise(n = n_distinct(dataset_TrackID))
```




#Plot distribution for each angle in each time bin
```{r, include=FALSE}

ggplot(bin_data_sampled, aes(x=angle,y=index),group=time)+
   stat_density_2d(aes(fill = ..ndensity..),contour=FALSE,geom="raster")+
   scale_color_gradient2(low = "cornflowerblue", mid = "white",
                         high = "brown2",midpoint=0,limits=c(-1,1),na.value="grey") +
   facet_wrap(vars(experiment,time),ncol=6) +
   scale_x_continuous(limits=c(-1,1),labels=c(-1,-0.5,0,0.5,1))+
   scale_y_continuous(trans = "reverse")+
   scale_fill_viridis(limits=c(0.01,1),na.value="black")+
   theme_black()+
   theme(legend.position = "top")

ggsave(file.path(save_path,paste0("L2_averaged_all_angles",sample_number,"postures",".png")),width=12,height=9)

```



```{r, include=FALSE}

bin_data_sampled_head_abs <- bin_data_sampled %>%
   mutate(angle = abs(angle)) %>%
   filter(index %in% c(2,3,4,5,6)) %>%
   filter(time %in% c("1h","2h","3h","4h","5h","6h"))



ggplot(bin_data_sampled_head_abs, aes(angle))+
   geom_histogram(aes(y=..density..), colour="black", fill="grey")+
   geom_density(alpha=.1, fill="#FF6666") +
   scale_x_continuous(limits=c(0,1))+
   # scale_fill_viridis(option = "inferno")+
   facet_wrap(vars(experiment,time),ncol=6)
   # theme_black()
   # theme(legend.position = "top")

ggsave(file.path(save_path,paste0("first_5_angles_distributions",sample_number,"postures",".png")),width=15,height=10)





```  

```{r, include=FALSE}

filtered <- bin_data_sampled %>%
   filter(index < 4) %>%
   filter(time %in% c("1h","2h","3h","4h","5h","6h")) %>%
   mutate(angle_rounded = round(angle,1)) %>%
   filter(angle_rounded < 0.5 & angle_rounded > -0.5) %>%
   group_by(index,time,angle_rounded,experiment) %>%
   summarise(number = n_distinct(ID))
   # filter(!experiment %in% c("empty"))


ggplot(filtered, aes(x=angle_rounded, y=number,fill=as.character(index)))+
   geom_bar(stat="identity")+
   coord_polar()+
   scale_x_reverse()+
   facet_wrap(vars(experiment,time),ncol =6)+
   scale_fill_brewer(palette="Greens")+
   theme_void()+
   theme(legend.position = "top",
         panel.background = element_rect(fill ="black"))

ggsave(file.path(save_path,paste0("head_averaged_over_all_angles_",sample_number,"postures",".png")),width=15,height=10)


```  

```{r, include=FALSE}

for(i in seq(1:1000)){
   
   to_plot <- bin_data_sampled_head %>%
    filter(ID_number %in% 1:i)

   ggplot(to_plot, aes(x=time, y=angle,group=time))+
      geom_bin2d(aes(fill = ..ndensity..))+
      scale_y_continuous(limits=c(-1,1))+
      scale_fill_viridis(option = "inferno")+
      facet_wrap(~annotation)+
      theme_black()+
      theme(legend.position = "top")

   ggsave(file.path("/Users/fpreuss/Desktop/behavior/",paste0("head_averaged_over_all_angles_",sample_number,"postures_",i,".png")),width=15,height=10)
   
}


```  



```{r, include=FALSE}
ggplot(bin_data_sampled_head, aes(x=angle,y=index),group=time )+
   stat_density_2d(aes(fill = ..ndensity..), geom = "raster", contour = FALSE) +
   scale_color_gradient2(low = "cornflowerblue", mid = "white",
                         high = "brown2",midpoint=0,limits=c(-1,1),na.value="grey") +
   facet_grid(~time)+
   scale_x_continuous(limits=c(-1,1),labels=c(-1,-0.5,0,0.5,1))+
   scale_y_continuous(trans = "reverse",limits=c(5.5,1.5))+
   scale_fill_viridis(limits=c(0.01,1),na.value="black")+
   theme_black()+
   theme(legend.position = "top")

ggsave(file.path(save_path,paste0("L2_head_averaged_angles_downsampled_",sample_number,"postures",".png")),width=12,height=9)
```  



#Plot distribution for each angle in each time bin
```{r, include=FALSE}
ggplot(bin_data_sampled,aes(x=time,y=angle,group=time,fill=time))+
  # geom_boxplot()+
  geom_violin()+
  # geom_boxplot()+
  coord_flip()+
  scale_y_continuous(limits=c(-1,1))+
  theme_black()+
  theme(legend.position = "top")
```

#Compare distributions with Kolmogorov-Smirnov test
```{r, include=FALSE}

one_hour <- filter(bin_data_sampled,time == "<1h") %>% select(angle) %>% pull() %>% na.omit()
two_hours <- filter(bin_data_sampled,time == "<2h") %>% select(angle) %>% pull() %>% na.omit()
three_hours <- filter(bin_data_sampled,time == "<3h") %>% select(angle) %>% pull() %>% na.omit()
four_hours <- filter(bin_data_sampled,time == "<4h") %>% select(angle) %>% pull() %>% na.omit()
five_hours <- filter(bin_data_sampled,time == "<5h") %>% select(angle) %>% pull() %>% na.omit()

shuffled_1 <- sample(bin_data_sampled$angle,120000)
shuffled_2 <- sample(bin_data_sampled$angle,120000)

ks.test(shuffled_1,shuffled_2)
ks.test(three_hours,five_hours)

```


#Plot averaged angles for each bin, adding one more posture each image
```{r, include=FALSE}

for(i in seq(1:1000)){
   
   to_plot <- bin_data_sampled %>%
    filter(ID_number %in% 1:i)
 
   ggplot(to_plot, aes(x=angle,y=index),group=time )+
      # geom_bin2d()+
      # geom_hex()+
      stat_density_2d(aes(fill = ..ndensity..),contour=FALSE,geom="raster")+
      # stat_density_2d(aes(fill = stat(nlevel)),contour=FALSE)+
      geom_point(data=bin_data_sampled %>% filter(ID_number == i ),aes(x=angle,y=index,color=angle), alpha=0.75,size=1.5)+
      # geom_path(data=bin_data_sampled %>% filter(ID_number == i ),aes(x=angle,y=index,color=angle), size=1)+
      scale_color_gradient2(low = "cornflowerblue", mid = "white",
                            high = "brown2",midpoint=0,limits=c(-1,1),na.value="grey") +
      facet_grid(~time)+
      scale_x_continuous(limits=c(-1,1),labels=c(-1,-0.5,0,0.5,1))+
      scale_y_continuous(trans = "reverse")+
      scale_fill_viridis(limits=c(0.01,1),na.value="black")+
      # scale_fill_distiller(palette = "Spectral",limits=c(0.1,1),na.value="black")+
      theme_black()+
      theme(legend.position = "top")+
      ggtitle(dataset_name)
       
   ggsave(file.path(save_path,paste0("withfoods_averaged_angles_examples_",i,".png")),width=12,height=9)
}
```



```{r, include=FALSE}


for(i in seq(1:1000)){
   
   to_plot <- bin_data_sampled_head %>%
    filter(ID_number %in% 1:i)

   ggplot(to_plot, aes(x=angle,y=index),group=time )+
      # geom_bin2d()+
      # geom_hex()+
      # stat_density_2d(aes(fill = ..density..), geom = "polygon")+
      stat_density_2d(aes(fill = ..ndensity..), geom = "raster", contour = FALSE) +
      # stat_density_2d(aes(fill = stat(nlevel)), geom = "polygon",n=200)+
      geom_point(data=bin_data_sampled_head %>% filter(ID_number == i ),aes(x=angle,y=index,color=angle), alpha=0.75,size=2)+
      # geom_path(data=bin_data_sampled_head %>% filter(ID_number == i ),aes(x=angle,y=index,color=angle), alpha=0.75,size=1)+
      scale_color_gradient2(low = "cornflowerblue", mid = "white",
                            high = "brown2",midpoint=0,limits=c(-1,1),na.value="grey") +
      facet_grid(~time)+
      scale_x_continuous(limits=c(-1,1),labels=c(-1,-0.5,0,0.5,1))+
      scale_y_continuous(trans = "reverse",limits=c(5.5,1.5))+
      scale_fill_viridis(limits=c(0.01,1),na.value="black")+
      theme_black()+
      theme(legend.position = "top")+
      ggtitle(dataset_name)
   ggsave(file.path(base_location,"plots",paste0("head_averaged_angles_examples_",i,".png")),width=12,height=9)

}
# ggsave(file.path(base_location,"plots",paste0(dataset_name,"head_averaged_angles_downsampled_",sample_number,"postures",".png")),width=12,height=9)
```   
