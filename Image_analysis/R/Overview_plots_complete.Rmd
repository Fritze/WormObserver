---
title: "WormObserver_analysis_complete"
output: html_document
---
#functions
```{r setup, echo=FALSE}
library("plyr")
library("dplyr")
library("tidyr")
library("ggplot2")
library("rmarkdown")
library("knitr")
library("lubridate")
library("wesanderson")
library("readr")
library("purrr")
library("viridis")
library("png")
library("grid")
library("ggpubr")
library("RColorBrewer")
library("shiny")
library("shinyWidgets")
library("plotly")
library("ggridges")
library("gganimate")
library("cowplot")

#functions

import <- function (file){
  ds <- read_csv(file,col_types = cols())
  #append column with file name
  ds$file_name <- file
  #extract the timelapse name from the folder structure
  ds$dataset_ID <- gsub(".+\\/([0-9]+\\-[0-9]+\\-[0-9]+\\_[0-9]+\\-[0-9]+\\-[0-9]+)\\/.+", "\\1",ds$file_name)
  return(ds)
}

angle <- function(x1, y1, x2, y2) {
  values <- list(x1, y1, x2, y2)
  if(anyNA(values)) {
    "NA"
  } else {
    x <- c(x1, y1)
    y <- c(x2, y2)
    dot.prod <- x%*%y 
    norm.x <- norm(x,type="2")
    norm.y <- norm(y,type="2")
    theta <- acos(dot.prod / (norm.x * norm.y))
    as.numeric(theta)
  }
}

distance <- function(x1, y1, x2, y2) {
  values <- list(x1, y1, x2, y2)
  if(anyNA(values)) {
    "NA"
  } else {
    length <- sqrt((x1-x2)^2+(y1-y2)^2)
    as.numeric(length)
  }
}

  myPalette <- colorRampPalette(rev(brewer.pal(11, "Spectral")))

plot_image_with_path <- function(offset,time_input_type,time_input,which_dataset,max_number_gaps,duration,which_frame,color_path,with_image) {
  sc <- scale_colour_gradientn(colours = myPalette(100), limits=c(0, 180)) 
  data.sub <- data %>% filter(dataset_ID == which_dataset)
  if(time_input_type == "minutes"){
  all_tps_in_minutes <- unique(data.sub$minutes)
  corresponding_minute <- all_tps_in_minutes[which(abs(all_tps_in_minutes-time_input)==min(abs(all_tps_in_minutes-time_input)))]
  selected_tp <- unique(data[data$minutes == corresponding_minute,"tp"])
  }else{
    selected_tp <- time_input
  }
  data_for_plotting <<- data %>%
    select_if(function(x){!all(is.na(x))}) %>%
    filter(tp == selected_tp, dataset_ID == which_dataset) %>%
    filter(Number_of_gaps < max_number_gaps) %>%
    mutate(grouping = paste0(dataset_ID, "_",TrackID, "_", tp)) %>%
    filter(Duration_of_track>duration) %>%
    group_by(TrackID, tp, dataset_ID) %>%
    mutate(x_lag=location_x - lag(location_x,n=offset), y_lag = location_y -lag(location_y, n=offset)) %>%
    mutate(x_lead=lead(location_x, n=offset)-location_x, y_lead=lead(location_y, n=offset)-location_y) %>%
    mutate(angle=180-suppressWarnings(as.numeric(mapply(angle,x_lag,y_lag,x_lead,y_lead)))*180/pi) %>%
    mutate(local_velocity=suppressWarnings(as.numeric(mapply(distance,x_lag,y_lag,x_lead,y_lead)))) %>%
    mutate(turn = ifelse(Eccentricity < 0.8 | angle < 50,"YES","NO")) %>%
    group_by(TrackID) %>%
    na.omit() %>%
    mutate(mean_angle = mean(angle),sd_local_angle=sd(angle),displacement=mean(Track_displacement),mean_velocity=Mean_velocity,track_length_secs=mean(Duration_of_track/downsampled_to),local_velocity=local_velocity,sd_local_velocity=sd(local_velocity), turns=turn,eccentricity=Eccentricity)
  
  p <- ggplot(data_for_plotting)+
    theme(aspect.ratio = 1024/1024)+
    coord_cartesian(ylim=c(0, 1023))+
    scale_x_continuous(expand = c(0, 0), limits= c(0,1023)) + scale_y_continuous(expand = c(0, 0),trans="reverse")+
    theme_void()
    #ggtitle(paste0("tp_",selected_tp))
  if(with_image == "with_image"){
    tp <- paste0("tp_",selected_tp)
    frame_png <- paste0(sprintf("%03d", which_frame),".png")
    location_dataset <- target_folder_general[grep(which_dataset, target_folder_general)]
    img <- readPNG(file.path(location_dataset,tp,frame_png))
    p <- p + background_image(img)
  }else{
    p
  }
  if(color_path == "mean_angle"){
    sc <- scale_colour_gradientn(colours = myPalette(100), limits=c(0, 180))
    p <- p +
      sc + 
      geom_path(aes(x=location_x, y=location_y,col=mean_angle, group=grouping),size=0.8, alpha=0.75)
  }else if(color_path == "ID"){
    p <- p +
      geom_path(aes(x=location_x, y=location_y,col=TrackID, group=grouping),size=0.8, alpha=0.75)+
      theme(
        legend.position = "none")
  }else if(color_path == "frame"){
    sc <- scale_colour_gradientn(colours = myPalette(100), limits=c(0, max(data$frame)))
    p <- p +
      sc +
      geom_path(aes(x=location_x, y=location_y,col=frame, group=grouping),size=0.8, alpha=0.75)
  }else if(color_path == "displacement"){
    sc <- scale_colour_gradientn(colours = myPalette(100), limits=c(0, max(data$Track_displacement)))
    p <- p +
      sc +
      geom_path(aes(x=location_x, y=location_y,col=displacement, group=grouping),size=0.8, alpha=0.75)
  }else if(color_path == "velocity"){
    sc <- scale_colour_gradientn(colours = myPalette(100), limits=c(0, max(data$Mean_velocity)))
    p <- p +
      sc +
      geom_path(aes(x=location_x, y=location_y,col=mean_velocity, group=grouping),size=0.8, alpha=0.75)
  }else if(color_path == "length"){
    sc <- scale_colour_gradientn(colours = myPalette(100), limits=c(0, max(data$Duration_of_track)/downsampled_to))
    p <- p +
      sc +
      geom_path(aes(x=location_x, y=location_y,col=length, group=grouping),size=0.8, alpha=0.75)
  }else if(color_path == "local_velocity"){
    sc <- scale_colour_gradientn(colours = myPalette(100), limits=c(0, max(data_for_plotting$local_velocity)))
    p <- p +
      sc +
      geom_path(aes(x=location_x, y=location_y,col=local_velocity, group=grouping),size=0.8, alpha=0.75)
  }else if(color_path == "sd_local_velocity"){
    sc <- scale_colour_gradientn(colours = myPalette(100), limits=c(0, max(data_for_plotting$sd_local_velocity)))
    p <- p +
      sc +
      geom_path(aes(x=location_x, y=location_y,col=sd_local_velocity, group=grouping),size=0.8, alpha=0.75)
  }else if(color_path == "sd_local_angle"){
    sc <- scale_colour_gradientn(colours = myPalette(100), limits=c(0, max(data_for_plotting$sd_local_angle)))
    p <- p +
      sc +
      geom_path(aes(x=location_x, y=location_y,col=sd_local_angle, group=grouping),size=0.8, alpha=0.75)
  }else if(color_path == "eccentricity"){
    sc <- scale_colour_gradientn(colours = myPalette(100), limits=c(0, max(0.9)))
    p <- p +
      sc +
      geom_path(aes(x=location_x, y=location_y,col=eccentricity, group=grouping),size=0.8, alpha=0.75)
  }else if(color_path == "turns"){
    p <- p +
      scale_colour_hue() +
      geom_path(aes(x=location_x, y=location_y,col=turns, group=grouping),size=0.8, alpha=0.75)
  }else{
    sc <- scale_colour_gradientn(colours = myPalette(100), limits=c(0, 180))
    p <- p +
      sc+
      geom_path(aes(x=location_x, y=location_y,col=angle, group=grouping),size=0.8, alpha=0.75)
  }
  p
}


calculate_overview_statistics <- function(offset,max_number_gaps,duration) {
  dfp <<- data %>%
    select_if(function(x){!all(is.na(x))}) %>%
    mutate(grouping = paste0(dataset_ID, "_",TrackID, "_", tp)) %>%
    filter(Number_of_gaps < max_number_gaps) %>%
    filter(Duration_of_track>duration) %>%
    group_by(grouping) %>%
    mutate(x_lag=location_x - lag(location_x,n=offset), y_lag = location_y -lag(location_y, n=offset)) %>%
    mutate(x_lead=lead(location_x, n=offset)-location_x, y_lead=lead(location_y, n=offset)-location_y) %>%
    mutate(angle=180-suppressWarnings(as.numeric(mapply(angle,x_lag,y_lag,x_lead,y_lead)))*180/pi) %>%
    mutate(turn = ifelse(Eccentricity < 0.9 | angle < 50,"YES","NO")) %>%
    group_by(TrackID, tp, minutes, hours,dataset_ID,file_name,plate_type,Duration_of_track) %>%
    na.omit() %>%
    summarise(mean_size=mean(Size), mean_eccentricity=mean(Eccentricity),mean_angle=mean(angle), sd_velocity=mean(Velocity_standard_deviation),mean_velocity=mean(Mean_velocity),mean_displacement=mean(Track_displacement),turns=sum(turn == "YES")
    )
  
}

calculate_centered <- function(offset,max_number_gaps,duration) {
  dfp_centered <<- data %>%
    select_if(function(x){!all(is.na(x))}) %>%
    mutate(grouping = paste0(dataset_ID, "_",TrackID, "_", tp)) %>%
    filter(Number_of_gaps < max_number_gaps) %>%
    filter(Duration_of_track>duration) %>%
    group_by(grouping) %>%
    mutate(x_lag=location_x - lag(location_x,n=offset), y_lag = location_y -lag(location_y, n=offset)) %>%
    mutate(x_lead=lead(location_x, n=offset)-location_x, y_lead=lead(location_y, n=offset)-location_y) %>%
    mutate(angle=180-suppressWarnings(as.numeric(mapply(angle,x_lag,y_lag,x_lead,y_lead)))*180/pi) %>%
    mutate(first_x = first(location_x),first_y = first(location_y))%>%
    mutate(x_centered=location_x - first_x, y_centered=location_y - first_y)%>%
    mutate(turn = ifelse(Eccentricity < 0.9 | angle < 50,"YES","NO"))%>%
    na.omit()
}


theme_black = function(base_size = 12, base_family = "") {
  
  theme_classic(base_size = base_size, base_family = base_family) %+replace%
    
    theme(
      # Specify axis options
      axis.line = element_line(colour = "white"),  
      axis.text.x = element_text(size = base_size, color = "white", lineheight = 0.9),  
      axis.text.y = element_text(size = base_size, color = "white", lineheight = 0.9),  
      axis.ticks = element_line(color = "white", size  =  0.2),  
      axis.title.x = element_text(size = base_size, color = "white", margin = margin(0, 10, 0, 0)),  
      axis.title.y = element_text(size = base_size, color = "white", angle = 90, margin = margin(0, 10, 0, 0)),  
      axis.ticks.length = unit(0.3, "lines"),   
      # Specify legend options
      legend.background = element_rect(color = NA, fill = "black"),  
      legend.key = element_rect(color = "white",  fill = "black"),  
      legend.key.size = unit(1.2, "lines"),  
      legend.key.height = NULL,  
      legend.key.width = NULL,      
      legend.text = element_text(size = base_size*0.8, color = "white"),  
      legend.title = element_text(size = base_size*0.8, face = "bold", hjust = 0, color = "white"),  
      legend.position = "right",  
      legend.text.align = NULL,  
      legend.title.align = NULL,  
      legend.direction = "vertical",  
      legend.box = NULL, 
      # Specify panel options
      panel.background = element_rect(fill = "black", color  =  NA),  
      panel.border = element_blank(),  
      panel.grid.major = element_blank(),  
      panel.grid.minor = element_blank(),  
      panel.spacing = unit(0.5, "lines"),   
      # Specify facetting options
      strip.background = element_blank(), #(fill = "grey30", color = "grey10"),  
      strip.text.x = element_text(size = base_size*0.8, color = "white", face = "italic"),  
      strip.text.y = element_text(size = base_size*0.8, color = "white",angle = -90),  
      # Specify plot options
      plot.background = element_rect(color = "black", fill = "black"),  
      plot.title = element_text(size = base_size*1.2, color = "white"),  
      plot.margin = unit(rep(1, 4), "lines")
      
    )
  
}
```


#load data and metadata
```{r, include=FALSE}
target_folder_general <- c("/media/ella/raid5/timelapses/2019-03-11_17-54-09")
```


```{r, echo=FALSE, messages=FALSE}
target_folder_analysis <- file.path(target_folder_general, "analysis")
target_folder_analysis_csvs <- list.files(target_folder_analysis,pattern=".+\\.csv", full.names = TRUE)


#### This is the for loop that pastes all .csv files together
##### _Additionally, time differences are calculated and transformed to minutes
#load metadata
metadata_file <- list.files(target_folder_general,pattern=".+\\_metadata.txt", full.names = TRUE)
metadata <- data.frame(sapply(metadata_file, function (x) readLines(x, warn=FALSE)), stringsAsFactors = FALSE)
colnames(metadata) <- as.character(gsub(".+\\/([0-9]+\\-[0-9]+\\-[0-9]+\\_[0-9]+\\-[0-9]+\\-[0-9]+)\\/.+", "\\1",target_folder_analysis))

time_elapsed <- apply(metadata,2, function(x) as.numeric(gsub(".+\\s([0-9]+).*", "\\1",x[grepl("Time elapsed.+\\:\\s(.+)",x)])))
time_elapsed <- as.data.frame(time_elapsed)
time_elapsed$dataset <- gsub(".+\\/([0-9]+\\-[0-9]+\\-[0-9]+\\_[0-9]+\\-[0-9]+\\-[0-9]+)\\/.+", "\\1",rownames(time_elapsed))


#timepoint length, in minutes
#attention to divide everything by 60, because this value is entered in seconds
timepoint_length <- apply(metadata,2, function(x) as.numeric(gsub(".+\\:\\s(.+)", "\\1",x[grepl("Timepoint length\\:\\s(.+)\\.",x)])))/60
timepoint_length <- as.data.frame(timepoint_length)
timepoint_length$dataset <- gsub(".+\\/([0-9]+\\-[0-9]+\\-[0-9]+\\_[0-9]+\\-[0-9]+\\-[0-9]+)\\/.+", "\\1",rownames(timepoint_length))


#timestep, in minutes
timestep_length <- apply(metadata,2, function(x) as.numeric(gsub(".+every(.+)minutes\\.", "\\1",x[grepl(".+every(.+)minutes\\.",x)])))
timestep_length <- as.data.frame(timestep_length)
timestep_length$dataset <- gsub(".+\\/([0-9]+\\-[0-9]+\\-[0-9]+\\_[0-9]+\\-[0-9]+\\-[0-9]+)\\/.+", "\\1",rownames(timestep_length))

#plate type
plate_type <- apply(metadata,2, function(x) gsub(".+\\,(.+)\\,.+", "\\1",x[grepl("Timelapse plate type\\:",x)]))
plate_type <- as.data.frame(plate_type)
plate_type$dataset <- gsub(".+\\/([0-9]+\\-[0-9]+\\-[0-9]+\\_[0-9]+\\-[0-9]+\\-[0-9]+)\\/.+", "\\1",rownames(plate_type))


#apply the import function defined above to all csv files (from all timelapses)
data <- ldply(.data=target_folder_analysis_csvs, .fun=import) %>%
  #replace all whitespaces in column names with "_"
  rename_all(funs(gsub("\\s", "_",.))) %>%
  inner_join(., time_elapsed,by = c("dataset_ID" = "dataset")) %>%
  inner_join(., timepoint_length,by = c("dataset_ID" = "dataset")) %>%
  inner_join(., timestep_length,by = c("dataset_ID" = "dataset")) %>%
  inner_join(., plate_type, by = c("dataset_ID" = "dataset")) %>%
  mutate(minutes = time_elapsed + ((tp-1)*timepoint_length+(tp-1)*timestep_length)) %>%
  mutate(hours= minutes/60)

```

##overview plots
```{r, include=FALSE}
#calculate_overview_statistics(offset,max_number_gaps,duration)
secs_angle_offset = 1
max_gaps = 3 
secs_min_tracked = 30
downsampled_fps <- unique(na.omit(data$downsampled_to))



calculate_overview_statistics(secs_angle_offset*downsampled_fps,5,secs_min_tracked*downsampled_fps)


```

##Plots1

```{r, echo=FALSE}


dfp %>%
  select(hours, dataset_ID, TrackID) %>%
  group_by(hours, dataset_ID) %>%
  summarise(.,n = n_distinct(TrackID)) %>%
  ggplot(.,aes(x=hours,y=n,fill=dataset_ID,colour=dataset_ID))+
  scale_colour_manual(values = wes_palette("Darjeeling1"))+
  geom_line()+
  geom_smooth(method="loess")+
  ylab("Number of tracked worms")+
  theme_classic()

data %>%
  select(hours,dataset_ID, TrackID, Duration_of_track) %>%
  group_by(hours, dataset_ID) %>%
  summarise(., mean_duration =mean(Duration_of_track)/downsampled_fps) %>%
  ggplot(.,aes(x=hours,y=mean_duration,fill=dataset_ID,colour=dataset_ID))+
  scale_colour_manual(values = wes_palette("Darjeeling1"))+
  geom_line()+
  geom_smooth(method="loess")+
  geom_hline(yintercept=secs_min_tracked,color="red")+
  ylab("Mean duration of tracks (seconds)")+
  theme_black()


```


##Plot grouped images for standard parameters
```{r, echo=TRUE}

dfp2 <- dfp %>%
  group_by(hours,dataset_ID,plate_type)%>%
  unite("experiment", c("dataset_ID","plate_type"), sep= " ")%>%
  group_by(experiment,hours)%>%
  summarise(turns_median_per_minute = median(turns), size_median_per_minute=median(mean_size),eccentricity_median_per_minute=median(mean_eccentricity),angle_median_per_minute=median(mean_angle),velocity_median_per_minute=median(mean_velocity), sd_velocity_median_per_minute=median(sd_velocity),displacement_median_per_minute=median(mean_displacement))


params <- c("turns_median_per_minute","size_median_per_minute","eccentricity_median_per_minute","angle_median_per_minute", "velocity_median_per_minute", "sd_velocity_median_per_minute", "displacement_median_per_minute")
for (i in params){
print(ggplot(dfp2, aes_string(x="hours",y=i))+
      #geom_ribbon(aes(ymin =  median_angle_per_minute - iqr_angle_per_minute, ymax = median_angle_per_minute + iqr_angle_per_minute))+
      geom_line(size=1)+
      ggtitle(i)+
      # ylim(c(0,180))+
      theme_classic()+
      facet_wrap(~experiment)
)
}
```

##Plot grouped images for standard parameters
```{r, echo=TRUE}

glimpse(dfp)

  


```


##Plot gifs of parameters
```{r, echo=TRUE, out.width = '4%'}


chosen_dataset <- "2019-01-23_16-07-02"
dfp2 <- dfp %>%
  group_by(minutes,dataset_ID,plate_type,tp)%>%
  filter(mean_displacement > 100)%>%
  summarise(size_median_per_minute=median(mean_size),eccentricity_median_per_minute=median(mean_eccentricity),angle_median_per_minute=median(mean_angle),velocity_median_per_minute=median(mean_velocity), sd_velocity_median_per_minute=median(sd_velocity),displacement_median_per_minute=median(mean_displacement))%>%
  filter(dataset_ID == chosen_dataset)

for (i in dfp2$tp){
  
dfp3 <- dfp2 %>%
    filter(tp <= i)
  
  p1 <- ggplot(dfp3,aes_string(x="minutes",y="angle_median_per_minute"))+
      geom_line(size=1,color="white")+
      scale_x_continuous(limits=c(0, max(dfp2$minutes)))+
      scale_y_continuous(limits=c(0, max(dfp2$angle_median_per_minute)))+
      xlab("")+
      ylab("median\nangle")+
      theme_black()+
      theme(axis.title.x = element_text(size = rel(1.5)),
            axis.title.y = element_text(size = rel(1.5)))       
  
#plot_image_with_path(offset,selected_minute,which_dataset,max_number_gaps,duration,which_frame,color_path,with_image) 
  p2 <- plot_image_with_path(5,"tp",i,chosen_dataset,5,100,1,"mean_angle","no")+theme_black()+xlab("")+ylab("")+
      theme(axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank(),
        legend.key.height=unit(0.5,"line"))


  p3 <- ggplot(dfp3,aes_string(x="minutes",y="velocity_median_per_minute"))+
      geom_line(size=1,color="white")+
      scale_x_continuous(limits=c(0, max(dfp2$minutes)))+
      scale_y_continuous(limits=c(0, max(dfp2$velocity_median_per_minute)))+
      xlab("")+
      ylab("median\nvelocity")+
      theme_black()+
      theme(axis.title.x = element_text(size = rel(1.5)),
            axis.title.y = element_text(size = rel(1.5)))  

  p4 <- plot_image_with_path(5,"tp",i,chosen_dataset,5,100,1,"velocity","no")+theme_black()+xlab("")+ylab("")+
      theme(axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank(),
        legend.key.height=unit(0.5,"line"))

  
  p5 <- ggplot(dfp3,aes_string(x="minutes",y="displacement_median_per_minute"))+
      geom_line(size=1,color="white")+
      scale_x_continuous(limits=c(0, max(dfp2$minutes)))+
      scale_y_continuous(limits=c(0, max(dfp2$displacement_median_per_minute)))+
      xlab("minutes")+
      ylab("median\ndisplacement")+
      theme_black()+
      theme(axis.title.x = element_text(size = rel(1.5)),
            axis.title.y = element_text(size = rel(1.5)))  
  
  p6 <- plot_image_with_path(5,"tp",i,chosen_dataset,5,100,1,"displacement","no")+theme_black()+xlab("")+ylab("")+
      theme(axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank(),
        legend.key.height=unit(0.5,"line"))

  
 p_all <- plot_grid(p1, p2, p3,p4,p5,p6,
          ncol = 2, nrow = 3,
          rel_widths = c(1,1))

 p_all
 save_plot(paste0("plots/",chosen_dataset,"_",round(i,3),".png"), p_all, base_height=10,base_aspect_ratio = 1.1)
 print(paste0("Saved plot Nr.",round(i,3)))
 
}


```


```{r, echo=TRUE}
calculate_centered(secs_angle_offset*downsampled_fps,5,secs_min_tracked*downsampled_fps)


p <- ggplot(dfp_centered)+
    theme(aspect.ratio = 1024/1024)+
    scale_x_continuous(limits= c(-1024,1024)) +
    scale_y_continuous(limits= c(-1024,1024))+
    geom_path(aes(x=x_centered, y=y_centered,col=minutes,group=grouping),size=0.8, alpha=0.3)+
    scale_colour_gradientn(colours = myPalette(100), limits=c(0, max(data$minutes)))+
    theme_void()

p

for (i in sort(unique(dfp_centered$tp))){
  
  dfp3 <- dfp_centered %>%
    filter(tp == i)
  
  p_tp <- ggplot(dfp3)+
    theme(aspect.ratio = 1024/1024)+
    scale_x_continuous(limits= c(-1024,1024)) +
    scale_y_continuous(limits= c(-1024,1024))+
    geom_path(aes(x=x_centered, y=y_centered,col=TrackID,group=grouping),size=1)+
    theme_void()+
    theme(legend.position = "none")
  p_tp
  save_plot(paste0("plots/","centered_",round(i,3),".png"),p_tp,base_height=10,base_aspect_ratio = 1.1)
  print(paste0("Saved plot Nr.",round(i,3)))
}


```



```{r, echo=TRUE}
dfp2 <- dfp %>%
  group_by(minutes,dataset_ID,plate_type)%>%
  unite("experiment", c("dataset_ID","plate_type"), sep= " ")

ggplot(dfp2,aes(x = mean_angle, y = mean_velocity))+
  stat_density2d(geom="raster", aes(fill = ..density..),contour = FALSE)+
  scale_fill_viridis(option = "inferno")+
  scale_x_reverse(limits=c(180,0), breaks = seq(180, 0, by = -36))+
  scale_y_continuous(limits=c(0,15), breaks = seq(0,15, by = 5))+
  theme_classic2()+
  ggtitle("2D density velocity against angle velocity")+
  facet_wrap(~experiment)

```


```{r, echo=TRUE}
test <- MASS::geyser

data <- data.frame(dfp2$mean_angle,dfp2$mean_velocity)
colnames(data) <- c("mean_angle","mean_velocity")
data
kd <- with(data, MASS::kde2d(mean_angle,mean_velocity, n = 50))
p <- plot_ly(x = kd$x, y = kd$y, z = kd$z) %>% add_surface()
p
chart_link = api_create(p, filename="surface-2")
chart_link

```

```{r, echo=TRUE}

params <- c("mean_angle", "mean_velocity", "mean_displacement", "mean_size")
for (i in params){
print(ggplot(dfp,aes_string(x = i, y = "minutes",group="minutes",height="..density..")) +
    geom_density_ridges_gradient(aes(fill = ..x..), scale = 5, size = 0.3) +
    scale_fill_gradientn(
      colours = c("#0D0887FF", "#CC4678FF", "#F0F921FF"),
      name = i)+
    theme_classic()+
    facet_wrap(~dataset_ID)
  )
}

```
