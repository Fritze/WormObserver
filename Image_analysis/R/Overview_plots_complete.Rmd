---
title: "WormObserver_analysis_complete"
output: html_document
---

#define data paths
```{r, include=FALSE}
target_folder_base <- ("/media/ella/raid5/timelapses")
target_folder_general <- c("2019-03-26_19-27-16",
                           #"2019-03-07_17-28-51",
                           "2019-03-11_17-54-09",
                           #"2019-03-18_18-01-40",
                           "2019-03-19_17-40-32",
                           "2019-03-25_18-10-06",#no food
                           "2019-03-27_18-24-47",
                           #"2019-04-15_17-32-23",
                           "2019-04-23_17-46-08",#daf2
                           "2019-04-30_14-15-44", #L2
                           "2019-05-04_15-36-42",#L2
                           "2019-05-07_12-15-40",#daf2
                           #"2019-05-08_14-11-15",#daf2
                           "2019-07-08_18-33-57",#1:5 OP50
                           "2019-07-09_18-22-34"#1:5 OP50
                           )

target_folder_analysis <- file.path(target_folder_base,target_folder_general, "analysis")


```

#load metadata (for all datasets)
```{r, include=FALSE}
metadata_file <- list.files(file.path(target_folder_base,target_folder_general),pattern=".+\\_metadata.txt$", full.names = TRUE)
metadata <- data.frame(sapply(metadata_file, function (x) read.delim(x,header=FALSE,check.names = FALSE)))
colnames(metadata) <- metadata_file
colnames(metadata) <- as.character(gsub(".+\\/", "",colnames(metadata)))
colnames(metadata) <- as.character(gsub("_metadata.txt", "",colnames(metadata)))

time_elapsed <- apply(metadata,2, function(x) as.numeric(gsub(".+\\s([0-9]+).*", "\\1",x[grepl("Time elapsed.+\\:\\s(.+)",x)])))
time_elapsed <- as.data.frame(time_elapsed)
time_elapsed$dataset <- colnames(metadata)


#timepoint length, in minutes
#attention to divide everything by 60, because this value is entered in seconds
timepoint_length <- apply(metadata,2, function(x) as.numeric(gsub(".+\\:\\s(.+)", "\\1",x[grepl("Timepoint length\\:\\s(.+)\\.",x)])))/60
timepoint_length <- as.data.frame(timepoint_length)
timepoint_length$dataset <- colnames(metadata)


#timestep, in minutes
timestep_length <- apply(metadata,2, function(x) as.numeric(gsub(".+every(.+)minutes\\.", "\\1",x[grepl(".+every(.+)minutes\\.",x)])))
timestep_length <- as.data.frame(timestep_length)
timestep_length$dataset <- colnames(metadata)

#plate type
plate_type <- apply(metadata,2, function(x) gsub(".+\\,(.+)\\,.+", "\\1",x[grepl("Timelapse plate type\\:",x)]))
plate_type <- as.data.frame(plate_type)
plate_type$dataset <- colnames(metadata)

#worm type
worm_type <- apply(metadata,2, function(x) gsub(".+\\:\\s(.+)", "\\1",x[grepl("Used line\\:",x)]))
worm_type <- as.data.frame(worm_type)
worm_type$dataset <- colnames(metadata)

```


#import timelapse data
```{r, include=FALSE}
#list zip files in target_folder_analysis
find_zip_files <- function(target_folder_analysis){
  files <- sort(as.numeric(gsub("(\\d+)\\..+","\\1",list.files(target_folder_analysis,pattern=".zip"))))[1:70]
  file.path(target_folder_analysis,paste0(files, ".csv.zip"))
}



imported_data <-  unlist(map(target_folder_analysis,find_zip_files)) %>%
  map_df(.,function(x) read_csv(x, col_types=cols(),col_names=TRUE) %>% mutate(file_name=x)) %>%
  mutate(dataset_ID = gsub(".+\\/([0-9]+\\-[0-9]+\\-[0-9]+\\_[0-9]+\\-[0-9]+\\-[0-9]+)\\/.+", "\\1",file_name)) %>%
  #replace all whitespaces in column names with "_"
  rename_all(list(~gsub("\\s", "_",.))) %>%
  inner_join(., time_elapsed,by = c("dataset_ID" = "dataset")) %>%
  inner_join(., timepoint_length,by = c("dataset_ID" = "dataset")) %>%
  inner_join(., timestep_length,by = c("dataset_ID" = "dataset")) %>%
  inner_join(., plate_type, by = c("dataset_ID" = "dataset")) %>%
  inner_join(., worm_type, by = c("dataset_ID" = "dataset")) %>%
  mutate(timestep_length = ifelse(timepoint_length > timestep_length, 0,timestep_length-timepoint_length)) %>%
  mutate(minutes = time_elapsed + ((tp-1)*timepoint_length+(tp-1)*timestep_length)) %>%
  mutate(hours= minutes/60) %>%
  na.omit()



#downsampled to for conversion
downsampled_fps <- unique(na.omit(imported_data$downsampled_to))

#save(data, file = paste0("6experiments","_","1-50tp",".RData"))
#write.csv(data, file = paste0("6experiments","_","1-50tp",".RData"))
```



```{r message=FALSE, include=FALSE}

# all_tracks <- as.character(unique(data$TrackID))
#function(datasetIDs, TrackIDs, tp,frames)
TrackIDs <- unique(imported_data$TrackID)
# TrackIDs <- c("track_0","track_1","track_2","track_3","track_4","track_5","track_6","track_7","track_8","track_9","track_10")
#tps <- c(1,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100,105,110)
tps <- unique(imported_data$tp)

# tic()
# skeleton("2019-03-26_19-27-16","track_1",1,0:959)
# toc()


# library(future)
# library(furrr)


trackID_names <- TrackIDs
dataset_names <-"2019-03-26_19-27-16"
tp_names <- tps
trackID_names
tp_names

#plan(multiprocess)


imported_data_filtered <- imported_data %>%
  filter(tp == 1)

first_equal_to <- function(x, value){
    (x == value) & (cumsum(x == value) == "YES")
}

tic()
#looks like future and furrr makes this 8x faster
data_skeleton <- imported_data  %>%
  filter(dataset_ID %in% dataset_names) %>%
  filter(tp %in% tp_names) %>%
  group_by(dataset_ID,tp,TrackID) %>%
  nest() %>%
  mutate(m = map(data,skeleton_direction)) %>%
  select(dataset_ID,tp,TrackID,m) %>%
  unnest() %>%
  group_by(dataset_ID, tp,TrackID,frame) %>%
  nest() %>%
  group_by(dataset_ID, tp,TrackID,frame) %>%
  mutate(mf =map(data,skeleton_frame,dataset_ID,tp,TrackID,frame)) %>%
  select(dataset_ID,tp,TrackID,frame,mf) %>%
  unnest() %>%
  group_by(dataset_ID,tp,TrackID,frame) %>%
  nest() %>%
  mutate(mh = map(data,skeleton_head)) %>%
  select(dataset_ID,tp,TrackID,frame,mh) %>%
  unnest() %>%
  select(-ends_with("1"))
toc()

tic()
test <- data_skeleton %>%
  filter(tp == 1) %>%
  mutate(head_detected = ifelse(grepl("downsampled | unclear",status),"not yet","NO" )) %>%
  mutate(distance_to_latest_head = NA) %>%
  group_by(dataset_ID, tp,TrackID) %>%
  nest() %>%
  group_by(dataset_ID, tp,TrackID) %>%
  mutate(mhe = map(data,skeleton_head_estimate))%>%
  select(dataset_ID, tp,TrackID,mhe) %>%
  unnest(cols=c(mhe))
toc()




any(is.na(test$distance_to_latest_head))
any(test$head_detected == "not yet")
test %>% filter(status == "no head estimation possible") %>% pull(frame) %>% unique()
typeof(test$distance_to_latest_head)




unique(data$tp)
unique(data_skeleton$tp)
unique(data_skeleton$TrackID)

unique(imported_data$tp)
unique(imported_data$dataset_ID)
imported_data %>%
  count(tp,TrackID) %>%
  summarise(mean_frames_per_track= mean(n))

?count
unique(data_skeleton$frame)

#save(data_skeleton, file = file.path(target_folder_base,"analysis","191112",paste0("2019-03-26_19-27-16","_","70tps","_","0-900",".RData")))

```


# example videos of skeletons
```{r, include=FALSE}
#use this if you want only plot worms that are continuesly tracked over x frames
x <- 5

#function to plot skeletons
plot_skeletons <- function(data_plot){
  ggplot(data_plot, aes(x=X,y=Y,colour=angle))+
      geom_point(size=0.25) +
      geom_path(size=0.025) +
      # geom_point(aes(fill=angle_1)) +
      # transition_states(frame,transition_length = 0.1,state_length = 0.2) +
      # ease_aes('linear') + 
      #geom_text(aes(label=round(angle_1,3)),color="white",size=3,hjust=2, vjust=1)+
      geom_point(data=data_plot[which(data_plot$is_head == "YES"), ], aes(x=X, y=Y), shape=17, stroke=1, alpha=0.5,colour = "gold", size=4) +
      scale_x_continuous(limits=c(-10,70)) +
      scale_y_continuous(expan = c(0, 0),limits=c(70,-10),trans="reverse") +
      facet_wrap(~ grouping,nrow=25,ncol=35, labeller = labeller(grouping=tracknames))+
      theme_black()+
      scale_color_gradient2(low = "cornflowerblue", mid = "white",
                         high = "brown2",midpoint=0,limits=c(-1,1),na.value="grey") +
      coord_equal() +
      theme(legend.position = "none",
            axis.title=element_blank(),
            axis.ticks=element_blank(),
            axis.text=element_blank(),
            axis.line=element_blank(),
            strip.text.x = element_text(colour = 'white',size=5))+
      guides(fill=guide_legend(title="Angle (rad)"))
}



data_skeleton_head$TrackCheck_cleaned <- replace_f(data_skeleton_head$TrackCheck, 24*x)
skeleton_data_all_cleaned <- data_skeleton_head %>%
  mutate(X = ifelse(is.na(TrackCheck_cleaned), NA, X)) %>%
  mutate(Y = ifelse(is.na(TrackCheck_cleaned), NA, Y)) %>%
  mutate(grouping = paste0(dataset_ID, ",",tp,",",TrackID)) %>%
  group_by(grouping) %>%
  #only those that have a head detected at one point
  filter(any(is_head=="YES"))


# skeleton_data_all_cleaned <- skeleton_data_all %>%
#   mutate(grouping = paste0(dataset_ID, ",",tp,",",TrackID))

#if you want to look at a certain timepoint
# skeleton_data_all_cleaned <- skeleton_data_all_cleaned %>%
#   filter(tp == 4)

for (f in unique(skeleton_data_all_cleaned$frame)){
    data_plot <<- skeleton_data_all_cleaned %>%
      filter(frame == f)
   
    #tracknames <- paste(data_plot$dataset_ID,data_plot$tp,sep="\n")
    tracknames <- paste0("tp: ", data_plot$tp,"\n",data_plot$TrackID)
    data_plot$grouping <- factor(data_plot$grouping, levels=unique(data_plot$grouping))
    names(tracknames) <- data_plot$grouping
    p <- plot_skeletons(data_plot)
    
    #print(p)
    ggsave(paste0(file.path(target_folder_analysis,"ggplots"),"/",f,".png"),height = 60,width= 60,units = "cm",bg="black",dpi=150)
}



```

#show segment angle diagrams (aka "wave diagrams") next to skeleton of the same worm
```{r, include=FALSE}
#function to plot a skeleton
plot_skeleton <- function(data_plot){
  ggplot(data_plot, aes(x=X,y=Y,colour=angle))+
      geom_point(size=2) +
      geom_path(size=1) +
      # geom_point(aes(fill=angle_1)) +
      # transition_states(frame,transition_length = 0.1,state_length = 0.2) +
      # ease_aes('linear') + 
      #geom_text(aes(label=round(angle_1,3)),color="white",size=3,hjust=2, vjust=1)+
      geom_point(data=data_plot[which(data_plot$is_head == "YES"), ], aes(x=X, y=Y), shape=17, stroke=1, alpha=0.5,colour = "gold", size=4) +
      scale_x_continuous(limits=c(-10,70)) +
      scale_y_continuous(expan = c(0, 0),limits=c(70,-10),trans="reverse") +
      #facet_wrap(~ grouping,nrow=25,ncol=35, labeller = labeller(grouping=tracknames))+
      theme_black()+
      scale_color_gradient2(low = "cornflowerblue", mid = "white",
                         high = "brown2",midpoint=0,limits=c(-1,1),na.value="grey") +
      coord_equal() +
      theme(legend.position = "none",
            axis.title=element_blank(),
            axis.ticks=element_blank(),
            axis.text=element_blank(),
            axis.line=element_blank(),
            strip.text.x = element_text(colour = 'white',size=5))
      
}

#function to plot the wave diagram
plot_wave <- function(skeleton_wave_onetrack){
  ggplot(skeleton_wave_onetrack, aes(x=X,y=Y,fill=angle))+
  geom_raster(na.rm=TRUE) +
  scale_x_continuous(limits=c(0,max(skeleton_wave_onetrack$frame))) +
  scale_y_continuous(trans="reverse")+
  geom_vline(xintercept=f,linetype="longdash")+
  scale_fill_gradient2(low = "cornflowerblue",mid ="white",high = "brown2",midpoint=0,limits=c(-1,1),na.value="black") +
  theme_black()+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.line.y=element_blank(),
        legend.position = "top")+
  labs(x="frames",title=paste0("Timepoint: ", timepoint, ", ",unique(skeleton_wave_onetrack$TrackID)))+
  labs(y="tail                                       head")+
  theme(strip.text.x = element_text(size = 3))+
  labs(fill = "Intersegment angle (rad)")

}
  
timepoint <- 5
#only those that have a head structure within one timepoint of choice
skeleton_wave <- data_skeleton_head %>%
  filter(tp == timepoint) %>%
  group_by(TrackID,frame) %>%
  filter(any(is_head=="YES")) %>%
  mutate(X=frame, Y=index) %>%
  mutate(grouping  = paste(tp, TrackID, sep="_"))

#present tracks with head
skeleton_wave %>%
  group_by(TrackID) %>%
  summarise(number_of_frames = length(unique(frame)))

#
track <- "track_3"
#if you want a certain TrackID / timepoint
skeleton_wave_onetrack <- skeleton_wave %>%
  filter(TrackID == track)

skeleton_data_onetrack <- data_skeleton_head %>%
      filter(tp == timepoint) %>%
      filter(TrackID == track)


for (f in skeleton_data_onetrack %>% filter(!is.na(X)) %>% distinct(frame) %>% pull()){
  data_plot <- skeleton_data_onetrack %>%
      filter(frame == f)
   
    p1<-plot_skeleton(data_plot)
    #print(p1)
    p2 <- plot_wave(skeleton_wave_onetrack)
    #print(p2)
    plot_grid(p2,p1,align=("v"),scale=c(1,0.8))+ theme(plot.background = element_rect(fill = "black"))
    ggsave(paste0(file.path(target_folder_analysis,"ggplots"),"/","Wave_and_skeleton_","timepoint_",timepoint,"_",track,"_","frame_",f,".png"))
}


```

```{r, include=FALSE}
one_worm_skeleton <-  skeleton_data_all %>%
  filter(tp == 1) %>%
  filter(frame == 2) %>%
  filter(TrackID == "track_4") %>%
  drop_na("angle_1") %>%
  mutate(angle_scaled = scale(angle_1,scale=TRUE))


mean(one_worm_skeleton$angle_1)
mean(one_worm_skeleton$angle_scaled)


# ggplot(one_worm_skeleton,aes(index,angle_scaled))+
#   geom_line()+
#   geom_hline(yintercept = 0,linetype="dotted")
# 
# ggplot(one_worm_skeleton,aes(index,angle_1))+
#   geom_line()+
#   geom_hline(yintercept = 0,linetype="dotted")



```


#calculate eigenworms
```{r, include=FALSE}

calculate_PCA <- function(timepoints,dataframe,frames){
  #print(timepoints)
  for_pca <- dataframe  %>%
    filter(tp %in% timepoints)  %>%
    group_by(tp,TrackID,frame) %>%
    filter(any(is_head == "YES")) %>%
    group_by(tp,TrackID) %>%
    select(angle_1,index, frame,TrackCheck,dataset_ID,TrackID,tp) %>%
    mutate(TrackCheck_cleaned = replace_f(TrackCheck, 24*frames)) %>%
    na.omit() %>%
    select(-c(TrackCheck,TrackCheck_cleaned))
  
  
  number_of_tracks <<- for_pca %>%  
    ungroup() %>%
    mutate(grouping = paste(dataset_ID,tp, TrackID, sep="_")) %>%
    mutate(unique_tracks = length(unique(grouping))) %>%
    select(unique_tracks) %>%
    slice(1) %>%
    pull(unique_tracks)
  print(number_of_tracks)
  
  for_pca_2 <<- for_pca %>%
    mutate(ID = paste0(dataset_ID,"_",tp, "_",TrackID, "_",frame)) %>%
    group_by(ID) %>%
    mutate(angle_1 = scale(angle_1,scale=TRUE)) %>%
    ungroup() %>%
    select(-c(dataset_ID,tp,TrackID,frame))
 
   

  # if(nrow(for_pca) != 0){
    for_pca_t <- dcast(for_pca_2,ID~index,value.var="angle_1")
    rownames(for_pca_t) <- for_pca_t$ID
    for_pca_t <- select(for_pca_t, -ID)
    #for_pca_t <- select(for_pca_t, -index)
    head(for_pca_t)
    pca <- prcomp(for_pca_t,scale=TRUE)
    pca
    
}

plot_six_eigenworms <- function(pca,timepoints,frames){
    six_eigenworms <- melt(pca$rotation[,1:6])
    colnames(six_eigenworms) <- c("Index", "PC","angle")
    ggplot(six_eigenworms, aes(Index,angle)) +
      #geom_point()+
      geom_line(color="white")+
      #geom_hline(yintercept=0, linetype="dashed",color="white")+
      facet_wrap(~PC,dir="v",ncol=3)+
      labs(x="# segment angle", y="angle (rad)")+
      scale_y_continuous(limits=c(-0.8,0.8))+
      theme_black()+
      theme(aspect.ratio=1)+
      ggtitle(paste0("Six_eigenworms_","minFrames_", frames,"_timepoints_",min(timepoints),"-",max(timepoints)))
}

plot_threetimes_six_eigenworms <- function(pca,pca2,pca3){
  six_eigenworms_2 <- melt(pca2$rotation[,1:6])
  colnames(six_eigenworms_2) <- c("Index", "PC","angle")
  six_eigenworms_3 <- melt(pca3$rotation[,1:6])
  colnames(six_eigenworms_3) <- c("Index", "PC","angle")
  plot_six_eigenworms(pca,timepoints,frames) +
    geom_line(data=six_eigenworms_2,color="yellow") +
    geom_line(data=six_eigenworms_3,color="red")
}




plot_contribution <- function(pca,timepoints, frames){
  pca_con <- setNames(data.frame(1:length(pca$sdev),pca$sdev^2),c("eigenworm","value")) %>%
    mutate(cumsum_eigenvalue = cumsum(value)) %>%
    mutate(var_contr = cumsum_eigenvalue/sum(value)) %>%
    filter(eigenworm %in% c(1:6))
    
  ggplot(pca_con,aes(eigenworm,var_contr*100)) +
    geom_line(color="white") +
    geom_point(color="white")+
    scale_y_continuous(limits=c(0,100),breaks=c(0,10,20,30,40,50,60,70,80,90,100)) +
    scale_x_continuous(breaks=c(0,1,2,3,4,5,6)) +
    labs(x="# eigenworm", y="variance contribution (%)") +
    theme_black() +
    theme(aspect.ratio=1,
          legend.position = "top")+
    ggtitle(paste0("Contribution_","minFrames_", frames,"_timepoints_",min(timepoints),"-",max(timepoints)))

}



frames <- 25
dataframe <- skeleton_data_all

timepoints <- c(0:69)
pca <- calculate_PCA(timepoints, dataframe,frames)



# mean_frames <- for_pca_2 %>%
#   mutate(Track = gsub("(.+)_\\d+$","\\1",ID)) %>%
#   group_by(Track) %>%
#   summarise(number = n()/22)
# 
# hist(mean_frames$number)
# abline(v=mean(mean_frames$number),col="red")
# mean(mean_frames$number)/22

plot_six_eigenworms(pca,timepoints,frames) 
ggsave(paste0(file.path(target_folder_analysis,"ggplots"),"/","PCA","Six_eigenworms_","minFrames_", frames,"_timepoints_",min(timepoints),"-",max(timepoints),"_",number_of_tracks,"_tracks",".png"))
plot_contribution(pca,timepoints,frames)
ggsave(paste0(file.path(target_folder_analysis,"ggplots"),"/","Contribution_","minFrames_", frames,"_timepoints_",min(timepoints),"-",max(timepoints),"_",number_of_tracks,"_tracks",".png"))

timepoints <- c(0:15)
pca2 <- calculate_PCA(timepoints, dataframe,frames)
plot_six_eigenworms(pca2,timepoints,frames) 
ggsave(paste0(file.path(target_folder_analysis,"ggplots"),"/","PCA","Six_eigenworms_","minFrames_", frames,"_timepoints_",min(timepoints),"-",max(timepoints),"_",number_of_tracks,"_tracks",".png"))
plot_contribution(pca2,timepoints,frames)
ggsave(paste0(file.path(target_folder_analysis,"ggplots"),"/","Contribution_","minFrames_", frames,"_timepoints_",min(timepoints),"-",max(timepoints),"_",number_of_tracks,"_tracks",".png"))




timepoints <- c(16:31)
pca3 <- calculate_PCA(timepoints, dataframe,frames)
plot_six_eigenworms(pca3,timepoints,frames) 
ggsave(paste0(file.path(target_folder_analysis,"ggplots"),"/","PCA","Six_eigenworms_","minFrames_", frames,"_timepoints_",min(timepoints),"-",max(timepoints),"_",number_of_tracks,"_tracks",".png"))
plot_contribution(pca3,timepoints,frames)
ggsave(paste0(file.path(target_folder_analysis,"ggplots"),"/","Contribution_","minFrames_", frames,"_timepoints_",min(timepoints),"-",max(timepoints),"_",number_of_tracks,"_tracks",".png"))


plot_threetimes_six_eigenworms(pca,pca2,pca3)
ggsave(paste0(file.path(target_folder_analysis,"ggplots"),"/","Six_Eigenworms_","_NotTurned_","minFrames_", frames,"_timepoints_",min(timepoints),"-",max(timepoints),"_",number_of_tracks,"_tracks",".png"))

pca2$rotation[,1] <- -pca2$rotation[,1]
pca2$rotation[,3] <- -pca2$rotation[,3]
pca2$rotation[,6] <- -pca2$rotation[,6]

pca3$rotation[,4] <- -pca3$rotation[,4]
pca3$rotation[,5] <- -pca3$rotation[,5]

plot_threetimes_six_eigenworms(pca,pca2,pca3)
ggsave(paste0(file.path(target_folder_analysis,"ggplots"),"/","Six_Eigenworms_","_Turned_","minFrames_", frames,"_timepoints_",min(timepoints),"-",max(timepoints),"_",number_of_tracks,"_tracks",".png"))

second <- pca3$rotation[,2] 
pca3$rotation[,2] <- pca3$rotation[,1] 
pca3$rotation[,1] <- second

plot_threetimes_six_eigenworms(pca,pca2,pca3)
ggsave(paste0(file.path(target_folder_analysis,"ggplots"),"/","Six_Eigenworms_","_Turned_PCsSwapped","minFrames_", frames,"_timepoints_",min(timepoints),"-",max(timepoints),"_",number_of_tracks,"_tracks",".png"))


# IDs <- unique(for_pca_2$ID)

# ggplot(filter(for_pca_2, ID == IDs[10]),aes(index,angle_1))+
#   geom_line()+
#   geom_hline(yintercept = 0,linetype="dotted")+
#   scale_y_continuous(limits = c(-2,2))


?prcomp

test <- data.frame(pca$x) %>%
  add_rownames() 

test$tp <- as.numeric(gsub(".+\\-16\\_(\\d+)\\_.+","\\1",test$rowname))

ggplot(test, aes(PC4,PC5))+
  geom_point(aes(colour=tp),alpha=0.1)+
  scale_colour_gradientn(colours = terrain.colors(10))


```


```{r, include=FALSE}


timepoints <- c(0:69)
dataframe <- skeleton_data_all
frames <- 22
# calculate_eigenvalue_contribution <- function(timepoints,dataframe,frames){
  print(timepoints)
  for_pca <- dataframe  %>%
    filter(tp %in% timepoints)  %>%
    group_by(tp,TrackID,frame) %>%
    filter(any(is_head == "YES")) %>%
    group_by(tp,TrackID) %>%
    select(angle_1,index, frame,TrackCheck,dataset_ID,TrackID,tp) %>%
    mutate(TrackCheck_cleaned = replace_f(TrackCheck, 24*frames)) %>%
    na.omit() %>%
    select(-c(TrackCheck,TrackCheck_cleaned))
  
  number_of_tracks <- for_pca %>%  
    ungroup() %>%
    mutate(grouping = paste(dataset_ID,tp, TrackID, sep="_")) %>%
    mutate(unique_tracks = length(unique(grouping))) %>%
    select(unique_tracks) %>%
    slice(1) %>%
    pull(unique_tracks)
  
  for_pca <- for_pca %>%
    mutate(ID = paste0(dataset_ID,"_",tp, "_",TrackID, "_",frame)) %>%
    ungroup()  %>%
    select(-c(dataset_ID,tp,TrackID,frame))
 
   

  # if(nrow(for_pca) != 0){
    for_pca_t <- dcast(for_pca,ID~index,value.var="angle_1")
    #for_pca_t <- dcast(for_pca, index~ID,value.var = "angle_1")
    
    rownames(for_pca_t) <- for_pca_t$ID
    for_pca_t <- select(for_pca_t, -ID)
    #for_pca_t <- select(for_pca_t, -index)
    head(for_pca_t)
    pca <- prcomp(for_pca_t,scale=TRUE)
    plot(pca)
    pca
    six_eigenworms <- melt(pca$rotation[,1:6])
    colnames(six_eigenworms) <- c("Index", "PC","angle")
    ggplot(six_eigenworms, aes(Index,angle)) +
      #geom_point()+
      geom_line()+
      geom_hline(yintercept=0, linetype="dashed")+
      facet_wrap(~PC,dir="v",ncol=3)+
      theme(aspect.ratio=1)+
      labs(x="# segment angle", y="angle (rad)")
    
    plot(pca$rotation[,1:6])
    
    head(for_pca_t)
    library(factoextra)
    fviz_eig(pca)
    fviz_pca_ind(pca,
             col.ind = "cos2", # Color by the quality of representation
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )

    fviz_pca_var(pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )

    data.frame(pca$sdev^2,number_of_tracks)
  } else {
    data.frame(rep(NA,22),rep(NA,22))
    
  }
} 


dataframe <- skeleton_data_all
frames <- 50
liste <- list(c(0:15),c(16:31))
timepoints <- liste

eigenvalues_all <- map_dfc(liste,calculate_eigenvalue_contribution,dataframe,frames)
column_names <- paste0(rep(liste,each=2),rep(c("","_numberoftracks"),each=1,times=2))
colnames(eigenvalues_all) <- column_names


ev <- eigenvalues_all %>%
  select(-contains("_")) %>%
  melt() %>%
  group_by(variable) %>%
  mutate(cumsum_eigenvalue = cumsum(value)) %>%
  mutate(var_contr = cumsum_eigenvalue/sum(value)) %>%
  mutate(index = 1:n()) %>%
  filter(index %in% c(1:6))

number_of_tracks <- eigenvalues_all %>%
  select(contains("numberoftracks")) %>%
  slice(1)


scale(for_pca_t[4,], pca$center, pca$scale) %*% pca$rotation 
pca$rotation
# ev$variable <- as.numeric(ev$variable)
ggplot(ev,aes(index,var_contr*100,group=variable,color=variable)) +
  geom_line(size=1) +
  geom_point()+
  scale_y_continuous(limits=c(0,100),breaks=c(0,10,20,30,40,50,60,70,80,90,100)) +
  scale_x_continuous(breaks=c(0,1,2,3,4,5,6)) +
  # scale_color_gradientn(colours =  wes_palette("Zissou1", 40, type = "continuous")) +
  labs(x="# eigenworm", y="variance contribution (%)") +
  theme_black() +
  theme(aspect.ratio=1,
        legend.position = "top")
  # scale_color_viridis_c()


ggsave(paste0(file.path(target_folder_analysis,"ggplots"),"/","test",".png"))

ev_diff <- dcast(ev,index~variable, value.var = "var_contr") %>%
  rename("early" = 2, "late" =3) %>%
  mutate(difference = abs(early - late)) %>%
  summarise(max(difference))




assign_new_tp <- function(x){
  s[x]
}


  
sampling_shuffled <- function(x){
  tps_to_shuffle <- 0:31
  s <<- sample(tps_to_shuffle, length(tps_to_shuffle))
  
  dataframe_shuffled <- skeleton_data_all %>%
     filter(tp %in% tps_to_shuffle) %>%
     mutate(grouping=paste(dataset_ID, tp,sep="_")) %>%
     group_by(grouping) %>%
     mutate(tp = mapply(assign_new_tp,tp)) %>%
     ungroup() %>%
     select(-grouping)

  eigenvalues_all <- map_dfc(liste,calculate_eigenvalue_contribution,dataframe_shuffled,22)
  column_names <- paste0(rep(liste,each=2),rep(c("","_numberoftracks"),each=1,times=2))
  colnames(eigenvalues_all) <- column_names


  ev <- eigenvalues_all %>%
    select(-contains("_")) %>%
    melt() %>%
    group_by(variable) %>%
    mutate(cumsum_eigenvalue = cumsum(value)) %>%
    mutate(var_contr = cumsum_eigenvalue/sum(value)) %>%
    mutate(index = 1:n()) %>%
    filter(index %in% c(1:6)) %>%
    mutate(iteration = x)

  # number_of_tracks <- eigenvalues_all %>%
  #   select(contains("_")) %>%
  #   slice(1)
  ev
  
  
}

test <- map_dfr(1:10,sampling_shuffled)


shuffled <- dcast(test,index+iteration~variable, value.var = "var_contr") %>%
  rename("early" = 3, "late" =4) %>%
  mutate(difference = abs(early - late)) %>%
  summarise(max(difference))


ggplot(test,aes(index,var_contr*100)) +
  geom_line(aes(group=iteration,color=iteration)) +
  geom_point(aes(shape=variable))+
  scale_y_continuous(limits=c(0,100),breaks=c(0,10,20,30,40,50,60,70,80,90,100)) +
  scale_x_continuous(breaks=c(0,1,2,3,4,5,6)) +
  scale_color_gradientn(colours =  wes_palette("Zissou1", 40, type = "continuous")) +
  labs(x="# eigenworm", y="variance contribution (%)") +
  theme_black() +
  theme(aspect.ratio=1,
        legend.position = "top")

head(for_pca_t)

  
```

```{r, include=FALSE}

pal <- wes_palette("Zissou1", 21, type = "continuous")

skeleton_data_cluster <- skeleton_data_all %>%
  mutate(ID = paste0(tp,"_",TrackID,"_",frame)) %>%
  filter(tp %in% c(0,10,20,30))

p1 <- ggplot(skeleton_data_cluster, aes(x=index, y=ID))+
          geom_tile(aes(fill = angle_1))+
          #geom_vline(xintercept = t, linetype="dotted")+
          scale_fill_gradientn(colours = pal) +
          labs(x="time (seconds)",y="#Neuron") +
          #scale_x_continuous(expand= c(0,0),breaks = seq(0, max(int_norm_exp$seconds), by = 100)) +
          #scale_y_discrete(expand = c(0, 0)) +
          theme(axis.text.x = element_text(size = 10, colour="white"),
              axis.title = element_text(size=10, colour="white"),
              legend.position="none",
              plot.background = element_rect(fill = "black"),
              plot.title = element_text(size = 10, colour = "white"))
          #ggtitle(paste0(i))
p1


```


##set parameters here
```{r, include=FALSE}
#pixel to mm conversion
conversion_factor <- 6.25

#set parameters
offset =8 #== 4 seconds
max_gaps = 0 
duration = 20 #==10 seconds
binning_factor = 8 #==4 seconds

#conversion_factor,offset,binning_factor,max_gaps,duration
dfp <- calculate_overview_statistics(imported_data,conversion_factor,offset,binning_factor,max_gaps,duration)



```


```{r, include=FALSE}
#which_tracks,which_track,offset,binning_factor,conversion_factor,time_input_type,time_input,which_dataset,max_number_gaps,duration,selected_frame,color_path,image
plot_image_with_path("current_frame","track_4",8,binning_factor,conversion_factor,"minutes",18,"2019-03-26_19-27-16",0,30*2,10,"ID","no_image")
#plot_image_with_path_centered("all_frames",4*2,conversion_factor,"minutes",18,"2019-03-06_17-56-39",0,50,30*2,10,"ID","no_image")

plot_single_path_states("track_2",conversion_factor,offset,binning_factor,"minutes",700,100,"2019-03-06_17-56-39",max_gaps,duration,"path_class_binned","no_image")+
  ggsave("Path_4.png")
plot_single_path_states("track_1",conversion_factor,offset,binning_factor,"minutes",1,100,"2019-03-06_17-56-39",max_gaps,duration,"path_class_binned","no_image")


p2 <- ggplot(data_for_plotting,aes(x=frame, y=local_distance,xend=lead(frame),yend=lead(local_distance),color=state_binned))+
  geom_segment()+
  # scale_color_manual(values=rev(wes_palette(n=3, name="BottleRocket2",type="discrete")))
  scale_colour_brewer(palette="Set1")



# which_dataset <- "2019-03-06_17-56-39"
# time_input <- "278"
# color_path <- "mean_angle"
# here("Image_analysis/R/plots", which_dataset,time_input,color_path)
# path <- here("Image_analysis/R/plots", which_dataset,time_input,color_path)
# dir.create(path,recursive = TRUE)
# selected_frame <- 2
# file.path(path,paste0("tp_",selected_tp,"_",round(selected_frame,3),".png"))
# 
# 
# plot_image_with_path("current_frame",4*2,conversion_factor,"minutes",18,"2019-03-06_17-56-39",0,50,30*2,10,"ID","with_image")
#   

```




##Plots1

```{r, echo=FALSE}



imported_data %>%
  select(hours, dataset_ID, TrackID) %>%
  group_by(hours, dataset_ID) %>%
  summarise(.,n = n_distinct(TrackID)) %>%
  ggplot(.,aes(x=hours,y=n,fill=dataset_ID,colour=dataset_ID))+
  #scale_colour_manual(values = wes_palette("BottleRocket2"))+
  #geom_line()+
  geom_smooth(method="loess")+
  ylab("Number of tracked worms")+
  theme_classic()

imported_data %>%
  select(hours,dataset_ID, TrackID, Duration_of_track) %>%
  group_by(hours, dataset_ID) %>%
  summarise(., mean_duration =mean(Duration_of_track)/downsampled_fps) %>%
  ggplot(.,aes(x=hours,y=mean_duration,fill=dataset_ID,colour=dataset_ID))+
  #scale_colour_manual(values = wes_palette("BottleRocket2"))+
  #geom_line()+
  geom_smooth(method="loess")+
  geom_hline(yintercept=duration,color="red")+
  ylab("Mean duration of tracks (seconds)")+
  theme_classic()


```


## Plot grouped images for standard parameters
```{r, echo=TRUE}

params <- grep("p\\_.+",colnames(dfp),value = TRUE)
dfp_for_plotting <- dfp %>%
  # filter(!dataset_ID %in% exps_out) %>%
  group_by(hours,dataset_ID,plate_type)%>%
  unite("experiment", c("dataset_ID","worm_type", "plate_type"), sep= " ") %>%
  group_by(experiment,hours,minutes,tp) %>%
  summarise_at(.vars = params,
               .funs = c(mean_per_minute="mean"))

params <- grep("p\\_.+",colnames(dfp_for_plotting),value = TRUE)
for (i in params){
print(ggplot(dfp_for_plotting, aes_string(x="hours",y=i))+
      #geom_ribbon(aes(ymin =  median_angle_per_minute - iqr_angle_per_minute, ymax = median_angle_per_minute + iqr_angle_per_minute))+
      geom_line(size=0.5)+
      ggtitle(i)+
      theme_classic()+
      # scale_x_continuous(breaks = seq(0, max(dfp_for_plotting$hours), 1))+
      facet_wrap(~experiment)
      #ggsave(paste0(i,".png"))
)
}

# 
# dfp$angle_mean_mmed <- mmed(dfp$mean_angle)
# 
# dfp2 <- dfp %>%
#   group_by(hours,dataset_ID,plate_type)%>%
#   unite("experiment", c("dataset_ID","worm_type", "plate_type"), sep= " ")%>%
#   group_by(experiment,hours,minutes)%>%
#   summarise(turns_mean_per_minute = mean(turns_per_minute), turns_mean_per_minute_ml=mean(turns_per_minute_ml), size_mean_per_minute=mean(mean_size),eccentricity_mean_per_minute=mean(mean_eccentricity),angle_mean_per_minute=mean(mean_angle),angle_mmed_mean_per_minute=mean(angle_mean_mmed),velocity_mean_per_minute=mean(mean_velocity), sd_velocity_mean_per_minute=mean(sd_velocity),displacement_mean_per_minute=mean(mean_displacement))
# 
# params <- c(params, "angle_mmed_mean_per_minute")
# for (i in params){
# print(ggplot(dfp2, aes_string(x="hours",y=i))+
#       #geom_ribbon(aes(ymin =  median_angle_per_minute - iqr_angle_per_minute, ymax = median_angle_per_minute + iqr_angle_per_minute))+
#       geom_line(size=0.5)+
#       ggtitle(i)+
#       theme_classic()+
#       scale_x_continuous(breaks = seq(0, max(dfp2$hours), 1))+
#       facet_wrap(~experiment)+
#       ggsave(paste0(i,".png"))
# )
# }

```

##Plot grouped images for standard parameters
```{r, echo=TRUE}

save_path <- file.path(target_folder_base,"analysis","191108")
save_path

chosen_exps_1 <- c(
                 #"2019-03-06_17-56-39",
                 #"2019-03-11_17-54-09",
                 # "2019-03-18_18-01-40",
                 #"2019-03-19_17-40-32"
                 "2019-03-26_19-27-16",
                 "2019-03-27_18-24-47")

chosen_exps_2 <-c("2019-05-07_12-15-40", #daf2 dauer
                  "2019-04-23_17-46-08")
                   

chosen_exps_3 <- c("2019-03-25_18-10-06") #no food


chosen_exps_4 <-c("2019-07-08_18-33-57", #1:5 OP50
                "2019-07-09_18-22-34") #1:5 OP50

chosen_exps_5 <-c("2019-04-30_14-15-44", #L2
                  "2019-05-04_15-36-42")


params <- grep("p\\_.+",colnames(dfp),value = TRUE)
sem <- function(x) sd(x)/sqrt(length(x))
i <- params[1]
for (i in params){
  dfp_for_plotting <<- dfp %>%
  filter(dataset_ID %in% chosen_exps_1 | dataset_ID %in% chosen_exps_2 | dataset_ID %in% chosen_exps_3 | dataset_ID %in% chosen_exps_4 | dataset_ID %in% chosen_exps_5) %>%
  mutate(annotation = ifelse(dataset_ID %in% chosen_exps_1, "N2 dauers 1:10",NA)) %>%
  mutate(annotation = ifelse(dataset_ID %in% chosen_exps_2, "daf2 dauers",annotation)) %>%
  mutate(annotation = ifelse(dataset_ID %in% chosen_exps_3, "N2 dauers no food",annotation)) %>%
  mutate(annotation = ifelse(dataset_ID %in% chosen_exps_4, "N2 dauers 1:5",annotation))%>%
  mutate(annotation = ifelse(dataset_ID %in% chosen_exps_5, "L2",annotation))%>%
  #round per half an hour
  mutate(hours_rounded= ceiling(hours* 2) / 2) %>%
  group_by(annotation, hours_rounded) %>%
  mutate(number_of_tracks_per_roundedtp_exptype = n()) %>%
  mutate(parameter_mean_per_minute = mean(!!sym(i)),
            parameter_sem_per_minute = sem(!!sym(i))) %>%
  group_by(annotation) %>%
  mutate(mean_number_of_tracks_per_roundedtp_exptype = mean(number_of_tracks_per_roundedtp_exptype)) %>%
  ungroup() %>%
  mutate(annotation = paste0(annotation, "\n(", round(mean_number_of_tracks_per_roundedtp_exptype),")"))

  
  print(ggplot(dfp_for_plotting,aes(x=hours_rounded,y=parameter_mean_per_minute,color=annotation,group=annotation,palette = "jco"))+
        geom_line(size=0.75)+
        geom_point()+
        #geom_errorbar(width=.1, aes(ymin=parameter_mean_per_minute-parameter_sd_per_minute, ymax=parameter_mean_per_minute+parameter_sd_per_minute))+
        geom_ribbon(aes(ymin=parameter_mean_per_minute-parameter_sem_per_minute, ymax=parameter_mean_per_minute+parameter_sem_per_minute), fill="white",linetype = 0, alpha=0.2)+
        ggtitle(paste0(i," with standard error of the mean"))+
        scale_x_continuous(limits = c(0,7),breaks = seq(0, 7, 1))+
        xlab("hours") + ylab(i)+
        theme_black()+
        scale_color_jco()+
        theme(legend.direction="vertical")+
        #theme(axis.title=element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), plot.background = element_rect(fill = "black"))
        ggsave(file.path(save_path,paste0(i,"_grouped",".png")))
  )
}
```



```{r, echo=TRUE}

save_path <- file.path(target_folder_base,"analysis","191108")
save_path


for (i in params){

  dfp_for_plotting <<- dfp %>%
    filter(dataset_ID %in% chosen_exps_1 | dataset_ID %in% chosen_exps_2 | dataset_ID %in% chosen_exps_3 | dataset_ID %in% chosen_exps_4) %>%
    mutate(annotation = ifelse(dataset_ID %in% chosen_exps_1, "N2 dauers 1:10",NA)) %>%
    mutate(annotation = ifelse(dataset_ID %in% chosen_exps_2, "daf2 dauers",annotation)) %>%
    mutate(annotation = ifelse(dataset_ID %in% chosen_exps_3, "N2 dauers no food",annotation)) %>%
    mutate(annotation = ifelse(dataset_ID %in% chosen_exps_4, "N2 dauers 1:5",annotation))%>%
    mutate(time_annotation = ifelse(hours >= 0 & hours <= 1, "1h",NA)) %>%
    mutate(time_annotation = ifelse(hours > 1 & hours <= 2, "2h",time_annotation)) %>%
    mutate(time_annotation = ifelse(hours > 2 & hours <= 3, "3h",time_annotation)) %>%
    mutate(time_annotation = ifelse(hours > 3 & hours <= 4, "4h",time_annotation)) %>%
    mutate(time_annotation = ifelse(hours > 4 & hours <= 5, "5h",time_annotation)) %>%
    mutate(time_annotation = ifelse(hours > 5 & hours <= 6, "6h",time_annotation)) %>%
    mutate(time_annotation = ifelse(hours > 6 & hours <= 7, "7h",time_annotation))%>%
    na.omit()

  

   print(
     ggplot(dfp_for_plotting,aes_string(x="time_annotation",y=i,fill="annotation"))+
    geom_boxplot(outlier.shape=1,outlier.color="white")+
    # geom_violin(outlier.shape=1,outlier.color="white")+
    #ggtitle(paste0(i," with standard error of the mean"))+
    #scale_x_continuous(limits = c(0,7))+
    xlab("hours") + ylab(i)+
    theme_black()+
    scale_fill_jco()+
    theme(legend.direction="vertical")  
   )
    ggsave(file.path(save_path,paste0(i,"_boxplot",".png")))
   
   mean_dfp_for_plotting <- dfp_for_plotting %>%
     group_by(time_annotation,annotation) %>%
      mutate(parameter_mean_per_hour = mean(!!sym(i)),
          parameter_sd_per_hour = sd(!!sym(i)))
  
   print(
     ggplot(mean_dfp_for_plotting, aes(x=time_annotation,y=parameter_mean_per_hour,fill=annotation)) +  
      geom_bar(stat="identity",position=position_dodge())+
      #geom_errorbar(aes(ymin=parameter_mean_per_hour-parameter_sd_per_hour, ymax=parameter_mean_per_hour+parameter_sd_per_hour), width=.2,position=position_dodge(.9),color="white")+
      xlab("hours") + ylab(i)+
      theme_black()+
      scale_fill_jco()+
      theme(legend.direction="vertical")  
   )
   ggsave(file.path(save_path,paste0(i,"_barplot",".png")))

  
   
} 
    
```


```{r, echo=TRUE}

dfp$hours_shuffled <- sample(dfp$hours, replace = FALSE)

for (i in params){
  dfp2 <- dfp %>%
  filter(dataset_ID %in% chosen_exps) %>%
  mutate(hours_rounded= ceiling(hours_shuffled* 2) / 2) %>%
  group_by(hours_rounded)%>%
  summarise(parameter_mean_per_minute = mean(!!sym(i)),
            parameter_sd_per_minute = sem(!!sym(i)))
  
  print(ggplot(dfp2,aes(x=hours_rounded,y=parameter_mean_per_minute))+
        geom_line(size=0.5,color="blue")+
        #geom_errorbar(width=.1, aes(ymin=parameter_mean_per_minute-parameter_sd_per_minute, ymax=parameter_mean_per_minute+parameter_sd_per_minute))+
        geom_ribbon(aes(ymin=parameter_mean_per_minute-parameter_sd_per_minute, ymax=parameter_mean_per_minute+parameter_sd_per_minute), alpha=0.3)+
        ggtitle(paste0(i," n=",length(chosen_exps)," with standard error of the mean"))+
        theme_classic()+
        scale_x_continuous(breaks = seq(0, max(dfp$hours), 1))+
        xlab("hours") + ylab(i)
        #ggsave(paste0(i,".png"))
  )
}       


```

## Cumulative distributions over time average over all datasets

```{r, echo=TRUE}

for (i in params){
  dfp2 <- dfp %>%
    filter(dataset_ID %in% chosen_exps_1 | dataset_ID %in% chosen_exps_2 | dataset_ID %in% chosen_exps_3 | dataset_ID %in% chosen_exps_4) %>%
    mutate(annotation = ifelse(dataset_ID %in% chosen_exps_1, "N2 dauers 1:10",NA)) %>%
    mutate(annotation = ifelse(dataset_ID %in% chosen_exps_2, "daf2 dauers",annotation)) %>%
    mutate(annotation = ifelse(dataset_ID %in% chosen_exps_3, "N2 dauers no food",annotation)) %>%
    mutate(annotation = ifelse(dataset_ID %in% chosen_exps_4, "N2 dauers 1:5",annotation))%>%
    mutate(hours_rounded= ceiling(hours* 2) / 2) %>%
    group_by(annotation) %>%
    mutate(N=paste0(annotation, " N= ",n_distinct(annotation), " datasets"))
  
  for(w in unique(dfp2$annotation)){
    dfp3 <- dfp2 %>%
      filter(annotation == w) %>%
      group_by(hours_rounded) %>%
      mutate(N_worms= n()) %>%
      ungroup() %>%
      mutate(sd_N_worms=sd(N_worms))%>%
      mutate(mean_N_worms=mean(N_worms))
  
    print(ggplot(dfp3,aes_string(x = i, y = "hours_rounded",group="hours_rounded",height="..density.."))+
      geom_density_ridges_gradient(aes(fill = ..x..), scale = 5, size = 0.3) +
      scale_fill_gradientn(colours = c("#0D0887FF", "#CC4678FF", "#F0F921FF"))+
      scale_x_continuous(limits = c(0, NA)) +
      theme_black()+
      theme(legend.position = "none")+
      ggtitle(paste0(gsub("p\\_(.+)","\\1",i)," ",w, " ", round(dfp3$mean_N_worms,0), "+-", round(dfp3$sd_N_worms,0)))+
      ggsave(file.path(save_path,paste0(i,"_", w,"_distribution",".png"))))
  }

}


```

## Plot gifs of parameters
```{r, echo=TRUE, out.width = '4%'}

for (i in params){
  dfp2 <- dfp %>%
  filter(dataset_ID %in% chosen_exps) %>%
  mutate(hours_rounded= ceiling(hours* 2) / 2) %>%
  group_by(hours_rounded)%>%
  summarise(parameter_mean_per_minute = mean(!!sym(i)),
            parameter_sd_per_minute = sem(!!sym(i)))
  
  print(ggplot(dfp2,aes(x=hours_rounded,y=parameter_mean_per_minute))+
        geom_line(size=0.5,color="blue")+
        #geom_errorbar(width=.1, aes(ymin=parameter_mean_per_minute-parameter_sd_per_minute, ymax=parameter_mean_per_minute+parameter_sd_per_minute))+
        geom_ribbon(aes(ymin=parameter_mean_per_minute-parameter_sd_per_minute, ymax=parameter_mean_per_minute+parameter_sd_per_minute), alpha=0.3)+
        ggtitle(paste0(i," n=",length(chosen_exps)," with standard error of the mean"))+
        theme_classic()+
        scale_x_continuous(breaks = seq(0, max(dfp$hours), 1))+
        xlab("hours") + ylab(i)
        #ggsave(paste0(i,".png"))
  )
}           
chosen_dataset <- "2019-01-23_16-07-02"
dfp2 <- dfp %>%
  group_by(minutes,dataset_ID,plate_type,tp)%>%
  filter(mean_displacement > 100)%>%
  summarise(size_median_per_minute=median(mean_size),eccentricity_median_per_minute=median(mean_eccentricity),angle_median_per_minute=median(mean_angle),velocity_median_per_minute=median(mean_velocity), sd_velocity_median_per_minute=median(sd_velocity),displacement_median_per_minute=median(mean_displacement))%>%
  filter(dataset_ID == chosen_dataset)

for (i in dfp2$tp){
  
dfp3 <- dfp2 %>%
    filter(tp <= i)
  
  p1 <- ggplot(dfp3,aes_string(x="minutes",y="angle_median_per_minute"))+
      geom_line(size=1,color="white")+
      scale_x_continuous(limits=c(0, max(dfp2$minutes)))+
      scale_y_continuous(limits=c(0, max(dfp2$angle_median_per_minute)))+
      xlab("")+
      ylab("median\nangle")+
      theme_black()+
      theme(axis.title.x = element_text(size = rel(1.5)),
            axis.title.y = element_text(size = rel(1.5)))       
  
#plot_image_with_path(offset,selected_minute,which_dataset,max_number_gaps,duration,which_frame,color_path,with_image) 
  p2 <- plot_image_with_path(5,"tp",i,chosen_dataset,5,100,1,"mean_angle","no")+theme_black()+xlab("")+ylab("")+
      theme(axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank(),
        legend.key.height=unit(0.5,"line"))


  p3 <- ggplot(dfp3,aes_string(x="minutes",y="velocity_median_per_minute"))+
      geom_line(size=1,color="white")+
      scale_x_continuous(limits=c(0, max(dfp2$minutes)))+
      scale_y_continuous(limits=c(0, max(dfp2$velocity_median_per_minute)))+
      xlab("")+
      ylab("median\nvelocity")+
      theme_black()+
      theme(axis.title.x = element_text(size = rel(1.5)),
            axis.title.y = element_text(size = rel(1.5)))  

  p4 <- plot_image_with_path(5,"tp",i,chosen_dataset,5,100,1,"velocity","no")+theme_black()+xlab("")+ylab("")+
      theme(axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank(),
        legend.key.height=unit(0.5,"line"))

  
  p5 <- ggplot(dfp3,aes_string(x="minutes",y="displacement_median_per_minute"))+
      geom_line(size=1,color="white")+
      scale_x_continuous(limits=c(0, max(dfp2$minutes)))+
      scale_y_continuous(limits=c(0, max(dfp2$displacement_median_per_minute)))+
      xlab("minutes")+
      ylab("median\ndisplacement")+
      theme_black()+
      theme(axis.title.x = element_text(size = rel(1.5)),
            axis.title.y = element_text(size = rel(1.5)))  
  
  p6 <- plot_image_with_path(5,"tp",i,chosen_dataset,5,100,1,"displacement","no")+theme_black()+xlab("")+ylab("")+
      theme(axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank(),
        legend.key.height=unit(0.5,"line"))

  
 p_all <- plot_grid(p1, p2, p3,p4,p5,p6,
          ncol = 2, nrow = 3,
          rel_widths = c(1,1))

 p_all
 save_plot(paste0("plots/",chosen_dataset,"_",round(i,3),".png"), p_all, base_height=10,base_aspect_ratio = 1.1)
 print(paste0("Saved plot Nr.",round(i,3)))
 
}


```


```{r, echo=TRUE}
###check if this function is up to date
#plot_image_with_path_centered(which_tracks,offset,conversion_factor,time_input_type,time_input,which_dataset,max_number_gaps,duration,selected_frame,color_path,image)
plot_image_with_path_centered("all_frames",secs_angle_offset*downsampled_fps,conversion_factor,"minutes",129,"2019-03-06_17-56-39",max_gaps,secs_min_tracked*downsampled_fps,10, "mean_angle","no_image")

minutes <- dfp %>%
  filter(dataset_ID == "2019-03-06_17-56-39")

minutes_unique <- unique(minutes$minutes)
minutes_unique
minutes_length <- length(minutes_unique)
minutes_length
```


```{r, echo=TRUE}

for (i in (minutes_unique)){
  plot_image_with_path_centered("all_frames",secs_angle_offset*downsampled_fps,conversion_factor,"minutes",i,"2019-03-06_17-56-39",max_gaps,secs_min_tracked*downsampled_fps,10, "mean_angle","no_image")
  save_plot(paste0("plots/","centered_",sprintf("%03d", i),".png"),pc,base_height=10,base_aspect_ratio = 1.1)
  print(paste0("Saved plot for minute ",sprintf("%03d", i)))
}

```



```{r, echo=TRUE}
dfp2 <- dfp %>%
  group_by(minutes,dataset_ID,plate_type)%>%
  unite("experiment", c("dataset_ID","plate_type"), sep= " ")

ggplot(dfp2,aes(x = mean_angle, y = mean_velocity))+
  stat_density2d(geom="raster", aes(fill = ..density..),contour = FALSE)+
  scale_fill_viridis(option = "inferno")+
  scale_x_reverse(limits=c(180,0), breaks = seq(180, 0, by = -36))+
  scale_y_continuous(limits=c(0,15), breaks = seq(0,15, by = 5))+
  theme_classic2()+
  ggtitle("2D density velocity against angle velocity")+
  facet_wrap(~experiment)

```


```{r, echo=TRUE}
test <- MASS::geyser

data <- data.frame(dfp2$mean_angle,dfp2$mean_velocity)
colnames(data) <- c("mean_angle","mean_velocity")
data
kd <- with(data, MASS::kde2d(mean_angle,mean_velocity, n = 50))
p <- plot_ly(x = kd$x, y = kd$y, z = kd$z) %>% add_surface()
p
chart_link = api_create(p, filename="surface-2")
chart_link

```


