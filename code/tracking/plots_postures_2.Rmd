# Use this script after running the "cluster_skeletons.R" script that clusters skeletons for a given condition.
# Needed: "second_kmeans_with_k..." 
# as computed by the "cluster_skeletons_2.R" script
 
# load packages
```{r, include=FALSE}

options(warn=-1)

library(tidyverse)
options(dplyr.summarise.inform=FALSE)

#for plotting of heatmap next to postures
library(patchwork)
#for colors
library(viridis)
library(wesanderson)

```

# load functions
```{r, include=FALSE}

#prepare data for clustering of posture libraries across annotations
#also we now cluster (unified) x/y positions instead of angles, this seems to work better...
plot_posture_examples <- function(data_to_plot,X,Y){
  ggplot(data_to_plot, aes_string(x=X,y=Y,color="angle"))+
    geom_point(size=3.5) +
    geom_path(size=2.5,lineend = "round") +
    theme_void()+
    coord_fixed(ratio = 1)+
    scale_color_gradient2(low = "deepskyblue", mid = "lavender",
                          high = "deeppink",midpoint=0,limits=c(-1,1),na.value="grey") +
    # scale_color_viridis(option = "plasma",limits=c(-1,1))+
    theme(plot.title = element_text(face = "bold"))
}
```


# load data
```{r, include=FALSE}
#second clustering with relative occurences
angle_data_postures_per_dataset <- readRDS("/media/fpreuss/raid5/timelapses/analysis/paper/data/skeletonized/clustered_2/second_kmeans_with_k_3_occurences.RDS")
#second clustering with posture angles
cluster_centers_reduced_grouped <- readRDS("/media/fpreuss/raid5/timelapses/analysis/paper/data/skeletonized/clustered_2/second_kmeans_with_k_3_angles.RDS")

save_path <- file.path("/media/fpreuss/raid5/timelapses/analysis/paper/plots/postures", "2nd_clustering")
dir.create(save_path,recursive = TRUE)

how_many_clusters <- unique(angle_data_postures_per_dataset$number_k)

#this is a list for converting between newID (after first kmeans) and newID2 (after temporal clustering for heatmap)
conversion_newID_and_newID2 <- angle_data_postures_per_dataset %>%
  select(annotation,newID, newID2) %>%
  group_by(annotation,newID, newID2) %>%
  summarise()

ID_conversions <- cluster_centers_reduced_grouped %>%
  #append newID2, so that postures in the overview have the same ID as in heatmap
  left_join(conversion_newID_and_newID2, by=c("newID","annotation")) %>%
  select(annotation, newID, newID2, posture_grouped) %>%
  group_by(annotation, newID, newID2, posture_grouped) %>%
  summarise() %>%
  arrange(annotation,posture_grouped,newID2)

write.csv(ID_conversions, file.path(save_path, "ID_conversion_after_2nd_clustering.txt"))

```

# plot overview seperately for each posture group (seperately for each annotation)
# the Id corresponds to the one in the heatmap (for that particular dataset)
```{r}

for (a in unique(angle_data_postures_per_dataset$annotation)){
  for (i in seq(1,how_many_clusters)){
    data_to_plot <- cluster_centers_reduced_grouped %>%
      #append newID2, so that postures in the overview have the same ID as in heatmap
      left_join(conversion_newID_and_newID2, by=c("newID","annotation")) %>%
      filter(posture_grouped == paste0("group_",i)) %>%
      filter(annotation ==a)
    number_of_IDs <- length(unique(data_to_plot$newID))
    plot <- plot_posture_examples(data_to_plot, "X","Y") +
        geom_point(data=filter(data_to_plot,index == 2), aes(X,Y),color="orange",size=7,shape=17) +
        facet_wrap(vars(posture_grouped,newID2,annotation),ncol=sqrt(number_of_IDs)) +
        theme(strip.text.x = element_text(size = 20,face="bold"))
    # print(plot)
    ggsave(file.path(save_path,paste0(a,"_group_",i,"_k_",how_many_clusters,".png")),height=sqrt(number_of_IDs)*4,width=sqrt(number_of_IDs)*4,limitsize=FALSE)
  }
}

```


#calculate relative occurence of posture groups
```{r, include=FALSE}
postures_stats <- angle_data_postures_per_dataset %>%
  group_by(annotation,dataset_ID, hours_rounded,posture_grouped,postures_per_tp_per_dataset) %>%
  #Count members of one posture group (adding all number of cluster members per hours_rounded per dataset within this group)
  summarise(number_of_posture_members_per_tp_per_dataset = sum(number_of_cluster_members_per_tp_per_dataset)) %>%
  #do this seperately for each dataset, hours_rounded) and posture group
  group_by(dataset_ID, hours_rounded,posture_grouped) %>%
  #Normalize this with the numbers of postures per hour per dataset
  #this gives the relative occurence of a certain posture at one "hours_rounded" timepoint
  mutate(perc_per_posture_grouped_per_dataset = number_of_posture_members_per_tp_per_dataset/postures_per_tp_per_dataset) %>%
  #again calculating the relative abundance of a posture_group but across annotations (==same condition), not experimental repeats
  group_by(annotation, hours_rounded,posture_grouped) %>%
  mutate(number_of_posture_members_per_tp_per_annotation = sum(number_of_posture_members_per_tp_per_dataset)) %>%
  mutate(postures_per_tp_per_annotation=sum(postures_per_tp_per_dataset)) %>%
  mutate(perc_per_posture_grouped_per_annotation = number_of_posture_members_per_tp_per_annotation/postures_per_tp_per_annotation) %>%
  select(dataset_ID,
         number_of_posture_members_per_tp_per_dataset,
         postures_per_tp_per_dataset,
         perc_per_posture_grouped_per_dataset,
         number_of_posture_members_per_tp_per_annotation,
         postures_per_tp_per_annotation,
         perc_per_posture_grouped_per_annotation) %>%
  arrange(hours_rounded)
  
  
postures_zscore <- postures_stats  %>%
  #the rest is done across time (z-score calculation) per dataset
  group_by(dataset_ID, posture_grouped) %>%
  mutate(sd_perc_per_posture_grouped_per_dataset = sd(perc_per_posture_grouped_per_dataset)) %>%
  mutate(mean_perc_per_posture_grouped_per_dataset = mean(perc_per_posture_grouped_per_dataset)) %>%
  mutate(z_posture_grouped_per_dataset =  (perc_per_posture_grouped_per_dataset-mean_perc_per_posture_grouped_per_dataset)/sd_perc_per_posture_grouped_per_dataset) %>%
  #standard deviation when looking at datasets of the same condition at different timepoints
  group_by(annotation, posture_grouped,hours_rounded) %>%
  mutate(sd_per_posture_grouped_per_annotation_per_tp = sd(perc_per_posture_grouped_per_dataset)) %>%
  #the rest is done across time (z-score calculation) per annotation
  group_by(annotation, posture_grouped) %>%
  mutate(sd_perc_per_posture_grouped_per_annotation = sd(perc_per_posture_grouped_per_annotation)) %>%
  mutate(mean_perc_per_posture_grouped_per_annotation = mean(perc_per_posture_grouped_per_annotation)) %>%
  mutate(z_posture_grouped_per_annotation =  (perc_per_posture_grouped_per_annotation-mean_perc_per_posture_grouped_per_annotation)/sd_perc_per_posture_grouped_per_annotation) %>%
  group_by(annotation, dataset_ID, hours_rounded, posture_grouped,
           perc_per_posture_grouped_per_dataset,
           perc_per_posture_grouped_per_annotation,
           sd_perc_per_posture_grouped_per_dataset,
           mean_perc_per_posture_grouped_per_dataset,
           z_posture_grouped_per_dataset,
           sd_perc_per_posture_grouped_per_annotation,
           mean_perc_per_posture_grouped_per_annotation,
           z_posture_grouped_per_annotation,
           sd_per_posture_grouped_per_annotation_per_tp) %>%
  summarise() %>%
  arrange(hours_rounded)


# unique(postures_grouped_statistics$annotation)
```

# occurence plots
```{r, include=FALSE}


selected_annotations <- c("Agar","OP50","OP50_w_Az")
pal <- wes_palette("Darjeeling1")[c(1,5,2)]
data_for_plotting <- postures_zscore %>%
  filter(annotation %in% selected_annotations) %>%
  mutate(annotation=factor(annotation, levels=selected_annotations))

ggplot(data_for_plotting, aes(y=z_posture_grouped_per_dataset,x=hours_rounded,color=annotation))+
  geom_point(alpha=0.5,shape=21)+
  geom_line(data=data_for_plotting, aes(y=z_posture_grouped_per_annotation, x=hours_rounded))+
  scale_y_continuous(limits = c(-3,3))+
  scale_x_continuous(breaks = seq(1,12))+
  # geom_smooth()+
  theme_bw()+
  theme(
    strip.background = element_rect(fill="white"))+
  facet_wrap(vars(posture_grouped,annotation),nrow=how_many_clusters,scales="free")+
  scale_fill_manual(values = pal)+
  scale_color_manual(values = pal)

  ggsave(file.path(save_path,"posture_groups_relative_occurences_norm.png"),height=6,width=5)

for (i in unique(data_for_plotting$posture_grouped)){
  ggplot(filter(data_for_plotting, posture_grouped == i), aes(y=z_posture_grouped_per_dataset,x=hours_rounded,color=annotation))+
    stat_smooth(geom='smooth',method="loess", alpha=0.25, se=TRUE)+
    geom_point(shape=21)+
    # geom_line(data=data_for_plotting, aes(y=z_posture_grouped_per_annotation, x=hours_rounded))+
    scale_x_continuous(breaks = seq(1,12))+
    # geom_smooth()+
    theme_bw()+
    theme(
      strip.background = element_rect(fill="white"))+
    facet_wrap(vars(annotation,posture_grouped),nrow=how_many_clusters)+
    scale_fill_manual(values = pal)+
    scale_color_manual(values = pal)
  
  ggsave(file.path(save_path,paste0("posture_groups_relative_occurences_norm_smoothed_posture_grouped_",i,".png")),height=5,width=3)

}
  
  
  
ggplot(data_for_plotting, aes(y=perc_per_posture_grouped_per_dataset,x=hours_rounded,color=annotation))+
  geom_ribbon(aes(ymin = perc_per_posture_grouped_per_annotation-sd_per_posture_grouped_per_annotation_per_tp, ymax = perc_per_posture_grouped_per_annotation + sd_per_posture_grouped_per_annotation_per_tp), fill = "lightgrey",color=NA)+
  geom_line(data=data_for_plotting, aes(y=perc_per_posture_grouped_per_annotation, x=hours_rounded),color="black")+
  scale_x_continuous(breaks = seq(1,12))+
  scale_y_continuous(limits = c(0,0.7))+
  theme_bw()+
  theme(
    strip.background = element_rect(fill="white"))+
  facet_wrap(vars(posture_grouped,annotation),nrow=how_many_clusters,scales="free_y")+
  scale_fill_manual(values = pal)+
  scale_color_manual(values = pal)

  ggsave(file.path(save_path,"posture_groups_relative_occurences.png"),height=6,width=5)

```  
  
# #plotting first derivatives of relative occurence of (sub-)posture groups
```{r, include=FALSE}
#only for z-score normalized data
selected_annotations <-c("Agar","OP50","OP50_w_Az")
pal <- wes_palette("Darjeeling1")[c(1,5,2)]
data_for_plotting <- postures_zscore %>%
  filter(annotation %in% selected_annotations) %>%
  mutate(annotation=factor(annotation, levels=selected_annotations)) %>%
  group_by(dataset_ID,posture_grouped) %>%
  mutate(first_d = z_posture_grouped_per_annotation - lag(z_posture_grouped_per_annotation)) %>%
  select(dataset_ID, annotation,hours_rounded,posture_grouped,first_d) %>%
  ungroup() %>%
  filter(posture_grouped == 1)


ggplot(data_for_plotting, aes(y=first_d,x=hours_rounded,color=annotation,fill=annotation))+
  # geom_line(color="black")+
  geom_smooth()+
  scale_x_continuous(breaks = seq(1,12))+
  theme_bw()+
  theme(
    strip.background = element_rect(fill="white"))+
  facet_wrap(vars(posture_grouped,annotation),nrow=1,scales="free_x")+
  scale_fill_manual(values = pal)+
  scale_color_manual(values = pal)

  ggsave(file.path(save_path,"firstd_posture_groups_relative_occurences_norm.png"),height=3,width=6)


```

#plotting average curvature per posture groups

```{r, include=FALSE}

pal <- wes_palette("Moonrise1")[c(2,3)]

cluster_centers_reduced_grouped %>%
  mutate(posture_meta = ifelse(posture_grouped %in% c("group_1", "group_3"),"curved","dauer")) %>%
  ggplot(., aes(x=angle,fill=posture_meta))+
    geom_density(alpha=0.5,lwd=1)+
    scale_x_continuous(limits=c(-1,1))+
    theme_classic()+
    scale_fill_manual(values = pal)+
    scale_color_manual(values = pal)


ggsave(file.path(save_path, "postures_grouped_angle_density.png"),height=3,width=6)

```

#plotting average posture
```{r, include=FALSE}

#select one dataset (i.e. OP50)
s <- cluster_centers_reduced_grouped %>%
  #append newID2, so that postures in the overview have the same ID as in heatmap
  left_join(conversion_newID_and_newID2, by=c("newID","annotation")) %>%
  filter(annotation == "OP50") %>%
  mutate(posture_meta = ifelse(posture_grouped %in% c("group_1", "group_3"),"curved","dauer")) %>%
  group_by(index,annotation, posture_grouped) %>%
  #shift all postures of "group_2 to the left
  mutate(X=ifelse(posture_meta == "dauer",-X-0.25,X)) %>%
  #manually select 2 posture to be highlighted
  mutate(highlight=ifelse(newID2 %in% c(102,23),"YES","NO"))

#do the plot
ggplot(s)+
  geom_path(data=s,aes(X,Y,group=newID),color="grey",alpha=0.5)+
  geom_path(data=filter(s,highlight=="YES"),aes(X,Y,group=newID,color=angle))+
  geom_point(data=filter(s,highlight=="YES"),aes(X,Y,group=newID,fill=angle,color=angle))+
  geom_point(data=filter(s,highlight=="YES" & index==2), aes(X,Y),color="orange",size=3,shape=17) +
  # scale_color_gradient2(low = "deepskyblue", mid = "lavender",
  #                       high = "deeppink",midpoint=0,limits=c(-1,1),na.value="grey") +
  # scale_fill_gradient2(low = "deepskyblue", mid = "lavender",
  #                      high = "deeppink",midpoint=0,limits=c(-1,1),na.value="grey") +
  scale_fill_viridis(option="plasma",limits=c(-1,1),na.value="grey")+
  scale_color_viridis(option="plasma",limits=c(-1,1),na.value="grey")+
  # theme_classic()+
  theme_void()+
  facet_wrap(vars(annotation))+
  coord_fixed(ratio = 1)

  ggsave(file.path(save_path, "postures_grouped_overlay_OP50.png"),height=3,width=6)
```
